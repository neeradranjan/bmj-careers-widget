<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console - BMJ Careers</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        /* Enhanced React-like styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0066cc;
            --primary-dark: #0052a3;
            --secondary: #48bb78;
            --danger: #f56565;
            --warning: #FFC000;
            --info: #4299e1;
            --dark: #1d1d1b;
            --gray: #6b7280;
            --light: #f0f4f8;
            --white: #ffffff;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 25px rgba(0,0,0,0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background: #f0f4f8;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            color: var(--dark);
            line-height: 1.6;
        }

        /* Loading States */
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* App Container */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--white);
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
            color: var(--white);
        }

        .sidebar-logo {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar-menu {
            padding: 1rem 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 0.875rem 1.5rem;
            color: var(--gray);
            text-decoration: none;
            transition: var(--transition);
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.9375rem;
            position: relative;
            overflow: hidden;
        }

        .menu-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: var(--primary);
            transform: translateX(-100%);
            transition: var(--transition);
        }

        .menu-item:hover {
            color: var(--primary);
            background: rgba(102, 126, 234, 0.05);
        }

        .menu-item.active {
            color: var(--primary);
            background: rgba(102, 126, 234, 0.1);
            font-weight: 600;
        }

        .menu-item.active::before {
            transform: translateX(0);
        }

        .menu-icon {
            width: 20px;
            height: 20px;
            margin-right: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            transition: var(--transition);
        }

        /* Header */
        .header {
            background: var(--white);
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--light);
            border-radius: 9999px;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-menu:hover {
            background: #e2e8f0;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        /* Content Area */
        .content {
            padding: 2rem;
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            overflow: hidden;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--dark);
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .stat-icon.primary {
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary);
        }

        .stat-icon.success {
            background: rgba(72, 187, 120, 0.1);
            color: var(--secondary);
        }

        .stat-icon.warning {
            background: rgba(237, 137, 54, 0.1);
            color: var(--warning);
        }

        .stat-icon.info {
            background: rgba(66, 153, 225, 0.1);
            color: var(--info);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.875rem;
        }

        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .stat-change.positive {
            background: rgba(72, 187, 120, 0.1);
            color: var(--secondary);
        }

        .stat-change.negative {
            background: rgba(245, 101, 101, 0.1);
            color: var(--danger);
        }

        /* Real-time Indicator */
        .real-time-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.875rem;
            background: #48bb78;
            color: var(--white);
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.8;
            }
        }

        .real-time-dot {
            width: 6px;
            height: 6px;
            background: var(--white);
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Session Cards */
        .session-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .session-card {
            background: var(--white);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            position: relative;
        }

        .session-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .session-card.active {
            border: 2px solid var(--secondary);
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .session-client {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9375rem;
        }

        .session-id {
            font-size: 0.625rem;
            color: var(--gray);
            font-family: monospace;
        }

        .session-badge {
            padding: 0.25rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.625rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .session-badge.active {
            background: rgba(72, 187, 120, 0.1);
            color: var(--secondary);
        }

        .session-badge.idle {
            background: rgba(237, 137, 54, 0.1);
            color: var(--warning);
        }

        .session-badge.ended {
            background: rgba(113, 128, 150, 0.1);
            color: var(--gray);
        }

        .session-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .metric-mini {
            text-align: center;
            padding: 0.5rem;
            background: var(--light);
            border-radius: 6px;
        }

        .metric-mini-value {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--primary);
        }

        .metric-mini-label {
            font-size: 0.625rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Activity Feed */
        .activity-feed {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: start;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            transition: var(--transition);
        }

        .activity-item:hover {
            background: var(--light);
        }

        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .activity-icon.load {
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary);
        }

        .activity-icon.click {
            background: rgba(237, 137, 54, 0.1);
            color: var(--warning);
        }

        .activity-icon.api {
            background: rgba(66, 153, 225, 0.1);
            color: var(--info);
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.875rem;
            margin-bottom: 0.125rem;
        }

        .activity-description {
            color: var(--gray);
            font-size: 0.75rem;
        }

        .activity-time {
            color: var(--gray);
            font-size: 0.75rem;
            white-space: nowrap;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }

        /* Buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--dark);
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-success {
            background: var(--secondary);
            color: var(--white);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-sm {
            padding: 0.375rem 0.875rem;
            font-size: 0.75rem;
        }

        .btn-warning {
            background: #FFC000;
            color: #1d1d1b;
        }

        .btn-warning:hover {
            background: #e6ac00;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--light);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e2e8f0;
        }

        td {
            padding: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.875rem;
        }

        tr:hover {
            background: var(--light);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            padding: 2rem;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease-out;
            box-shadow: var(--shadow-xl);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .session-grid {
                grid-template-columns: 1fr;
            }

            .header-content {
                padding: 1rem;
            }

            .content {
                padding: 1rem;
            }
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Notification Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--white);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 300px;
            transform: translateX(400px);
            transition: transform 0.3s ease-out;
            z-index: 3000;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .toast.success .toast-icon {
            background: rgba(72, 187, 120, 0.1);
            color: var(--secondary);
        }

        .toast.error .toast-icon {
            background: rgba(245, 101, 101, 0.1);
            color: var(--danger);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.125rem;
        }

        .toast-message {
            font-size: 0.875rem;
            color: var(--gray);
        }

        /* Section Display */
        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            z-index: 999;
        }

        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .empty-state-description {
            font-size: 0.875rem;
        }

        /* Settings Form */
        .settings-form {
            display: grid;
            gap: 1.5rem;
        }

        .form-group {
            display: grid;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 500;
            color: var(--dark);
            font-size: 0.875rem;
        }

        .form-input {
            padding: 0.625rem 0.875rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-select {
            padding: 0.625rem 0.875rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.875rem;
            background: var(--white);
            cursor: pointer;
        }

        .form-help {
            font-size: 0.75rem;
            color: var(--gray);
        }

        /* Client Detail View */
        .client-detail-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 1024px) {
            .client-detail-grid {
                grid-template-columns: 1fr;
            }
        }

        .info-row {
            display: flex;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .info-label {
            font-weight: 500;
            color: var(--gray);
            width: 140px;
            flex-shrink: 0;
        }

        .info-value {
            color: var(--dark);
        }

        /* Revenue Calculator */
        .revenue-calculator {
            background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
            color: var(--white);
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
        }

        .revenue-amount {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .revenue-period {
            opacity: 0.9;
            font-size: 1.125rem;
        }

        .revenue-breakdown {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .breakdown-item {
            text-align: center;
        }

        .breakdown-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .breakdown-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* Code blocks and tabs */
        .code-block {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .code-block code {
            font-family: 'Courier New', monospace;
            color: #0066cc;
            font-size: 0.875rem;
        }

        .api-section {
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 2rem;
        }

        .api-section:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .code-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .code-tab {
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border: 1px solid #e2e8f0;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .code-tab.active {
            background: #0066cc;
            color: white;
            border-color: #0066cc;
        }

        .code-example {
            display: none;
            background: #1e293b;
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 0 8px 8px 8px;
            overflow-x: auto;
            margin: 0;
        }

        .code-example.active {
            display: block;
        }

        .code-example code {
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 0.8125rem;
            line-height: 1.6;
        }

        .json-viewer {
            background: #1e293b;
            border-radius: 8px;
            padding: 1rem;
            max-height: 500px;
            overflow: auto;
        }

        .json-viewer pre {
            margin: 0;
            color: #e2e8f0;
            font-size: 0.8125rem;
        }

        .json-viewer .json-key {
            color: #60a5fa;
        }

        .json-viewer .json-string {
            color: #86efac;
        }

        .json-viewer .json-number {
            color: #fbbf24;
        }

        .json-viewer .json-boolean {
            color: #c084fc;
        }

        /* User dropdown styles */
        .user-dropdown {
            position: relative;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--light);
            border-radius: 9999px;
            cursor: pointer;
            transition: var(--transition);
        }

        .dropdown-arrow {
            font-size: 0.75rem;
            transition: transform 0.3s ease;
        }

		.user-dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: var(--white);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            min-width: 220px;
            display: none;
            z-index: 1000;
            overflow: hidden;
        }

        .user-dropdown-menu.show {
            display: block;
            animation: dropdownFadeIn 0.2s ease-out;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-header {
            padding: 1rem;
            background: var(--light);
        }

        .user-email {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .user-role {
            font-size: 0.75rem;
            color: var(--gray);
        }

        .dropdown-divider {
            height: 1px;
            background: #e5e7eb;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--dark);
            text-decoration: none;
            transition: background 0.2s ease;
        }

        .dropdown-item:hover {
            background: var(--light);
        }

        .dropdown-icon {
            font-size: 1rem;
        }

        /* Enhanced tracking styles */
        .tracking-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary);
            border-radius: 9999px;
            font-size: 0.625rem;
            font-weight: 600;
        }

        .iframe-indicator {
            background: rgba(237, 137, 54, 0.1);
            color: var(--warning);
        }

        .client-identifier {
            font-family: monospace;
            background: var(--light);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .usage-metric {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .usage-metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: var(--gray);
            font-size: 0.875rem;
        }

        .metric-value {
            font-weight: 600;
            color: var(--dark);
        }

        /* Enhanced JSON viewer */
        .json-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .json-stats {
            display: flex;
            gap: 2rem;
            padding: 1rem;
            background: var(--light);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .json-stat {
            display: flex;
            flex-direction: column;
        }

        .json-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .json-stat-label {
            font-size: 0.75rem;
            color: var(--gray);
            text-transform: uppercase;
        }

        /* Live tracking indicator */
        .tracking-live {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            background: rgba(72, 187, 120, 0.1);
            color: var(--secondary);
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .tracking-live::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--secondary);
            border-radius: 50%;
            animation: pulse-dot 2s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        /* Client usage heatmap */
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            gap: 2px;
            margin-top: 1rem;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            background: var(--light);
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }

        .heatmap-cell.low { background: rgba(102, 126, 234, 0.2); }
        .heatmap-cell.medium { background: rgba(102, 126, 234, 0.5); }
        .heatmap-cell.high { background: rgba(102, 126, 234, 0.8); }
        .heatmap-cell.peak { background: var(--primary); }

        .heatmap-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: var(--white);
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
        }

        .heatmap-cell:hover .heatmap-tooltip {
            opacity: 1;
        }

        /* Enhanced Responsive Design */
@media (max-width: 1200px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .client-detail-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .sidebar {
        transform: translateX(-100%);
        width: 240px;
    }

    .sidebar.active {
        transform: translateX(0);
    }

    .main-content {
        margin-left: 0;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .session-grid {
        grid-template-columns: 1fr;
    }

    .header-content {
        padding: 0.75rem 1rem;
    }

    .header-title {
        font-size: 1.25rem;
    }

    .content {
        padding: 1rem;
    }

    .card-header {
        padding: 1rem;
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
    }

    .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .revenue-breakdown {
        grid-template-columns: 1fr;
    }

    .activity-feed {
        max-height: 300px;
    }
}

@media (max-width: 480px) {
    .sidebar {
        width: 100%;
    }

    .header-actions {
        gap: 0.5rem;
    }

    .user-menu span {
        display: none;
    }

    .user-menu .user-avatar {
        margin: 0;
    }

    .btn {
        padding: 0.5rem 0.875rem;
        font-size: 0.8125rem;
    }

    .stat-value {
        font-size: 1.5rem;
    }

    .modal-content {
        width: 95%;
        padding: 1.5rem;
    }
}

/* Sticky table headers on mobile */
@media (max-width: 768px) {
    .table-container {
        max-height: 400px;
        position: relative;
    }

    thead {
        position: sticky;
        top: 0;
        z-index: 10;
        background: var(--white);
    }
}

/* Improved mobile menu toggle */
.mobile-menu-toggle {
    display: none;
    position: fixed;
    top: 1rem;
    left: 1rem;
    width: 44px;
    height: 44px;
    background: var(--primary);
    color: var(--white);
    border: none;
    border-radius: 8px;
    font-size: 1.25rem;
    cursor: pointer;
    box-shadow: var(--shadow-md);
    z-index: 1001;
    align-items: center;
    justify-content: center;
}

@media (max-width: 768px) {
    .mobile-menu-toggle {
        display: flex;
    }
}

/* Sidebar overlay for mobile */
.sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
}

.sidebar-overlay.active {
    display: block;
}

@media (max-width: 768px) {
    .sidebar.active ~ .sidebar-overlay {
        display: block;
    }
}

        #enhanced-analytics {
    animation: fadeIn 0.3s ease-out;
}

/* Enhanced Stats Cards */
#enhanced-analytics .stat-card {
    background: var(--white);
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
    position: relative;
    overflow: hidden;
    transition: var(--transition);
}

#enhanced-analytics .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--primary);
}

#enhanced-analytics .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

#enhanced-analytics .stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin-bottom: 1rem;
}

#enhanced-analytics .stat-icon.primary {
    background: rgba(102, 126, 234, 0.1);
    color: var(--primary);
}

#enhanced-analytics .stat-icon.success {
    background: rgba(72, 187, 120, 0.1);
    color: var(--secondary);
}

#enhanced-analytics .stat-icon.warning {
    background: rgba(237, 137, 54, 0.1);
    color: var(--warning);
}

#enhanced-analytics .stat-icon.info {
    background: rgba(66, 153, 225, 0.1);
    color: var(--info);
}

#enhanced-analytics .stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--dark);
    line-height: 1;
    margin-bottom: 0.5rem;
}

#enhanced-analytics .stat-label {
    color: var(--gray);
    font-size: 0.875rem;
}

/* Enhanced Client Search */
#enhancedClientSearch {
    padding: 0.625rem 0.875rem;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 0.875rem;
    transition: var(--transition);
}

#enhancedClientSearch:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* Enhanced Clients Table */
#enhancedClientsTable {
    width: 100%;
}

#enhancedClientsTable tr {
    transition: var(--transition);
}

#enhancedClientsTable tr:hover {
    background: var(--light);
}

#enhancedClientsTable td {
    padding: 0.75rem;
    border-bottom: 1px solid #e2e8f0;
    font-size: 0.875rem;
}

#enhancedClientsTable .client-identifier {
    font-size: 0.625rem;
    color: var(--gray);
    font-family: monospace;
    margin-top: 0.25rem;
}

#enhancedClientsTable .stat-value {
    font-size: 1.25rem !important;
    font-weight: 700;
    color: var(--primary);
}

#enhancedClientsTable .stat-change {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
}

#enhancedClientsTable .stat-change.positive {
    background: rgba(72, 187, 120, 0.1);
    color: var(--secondary);
}

/* Popular Filters and Searches Grid */
#enhanced-analytics .card + div {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-top: 2rem;
}

@media (max-width: 1024px) {
    #enhanced-analytics .card + div {
        grid-template-columns: 1fr;
    }
}

/* Popular Items Lists */
#popularFilters,
#popularSearches {
    max-height: 400px;
    overflow-y: auto;
}

#popularFilters .usage-metric,
#popularSearches .usage-metric {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid #e2e8f0;
    transition: var(--transition);
}

#popularFilters .usage-metric:last-child,
#popularSearches .usage-metric:last-child {
    border-bottom: none;
}

#popularFilters .usage-metric:hover,
#popularSearches .usage-metric:hover {
    background: var(--light);
    margin: 0 -1rem;
    padding-left: 1rem;
    padding-right: 1rem;
}

#popularFilters .metric-label,
#popularSearches .metric-label {
    color: var(--dark);
    font-size: 0.875rem;
    font-weight: 500;
}

#popularFilters .metric-value,
#popularSearches .metric-value {
    font-weight: 600;
    color: var(--primary);
    font-size: 0.875rem;
}

/* Device Chart Container */
#enhanced-analytics .chart-container {
    position: relative;
    height: 300px;
    margin-top: 1rem;
}

/* Activity Heatmap */
.heatmap-container {
    padding: 1rem 0;
}

#activityHeatmap {
    display: grid;
    grid-template-columns: repeat(24, 1fr);
    gap: 4px;
    margin-bottom: 1rem;
}

#activityHeatmap .heatmap-cell {
    aspect-ratio: 1;
    background: var(--light);
    border-radius: 4px;
    position: relative;
    cursor: pointer;
    transition: var(--transition);
}

#activityHeatmap .heatmap-cell:hover {
    transform: scale(1.1);
    z-index: 10;
}

#activityHeatmap .heatmap-cell.low {
    background: rgba(102, 126, 234, 0.2);
}

#activityHeatmap .heatmap-cell.medium {
    background: rgba(102, 126, 234, 0.5);
}

#activityHeatmap .heatmap-cell.high {
    background: rgba(102, 126, 234, 0.8);
}

#activityHeatmap .heatmap-cell.peak {
    background: var(--primary);
    box-shadow: 0 0 10px rgba(102, 126, 234, 0.4);
}

#activityHeatmap .heatmap-tooltip {
    position: absolute;
    bottom: calc(100% + 10px);
    left: 50%;
    transform: translateX(-50%);
    background: var(--dark);
    color: var(--white);
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    font-size: 0.625rem;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
    z-index: 1000;
    line-height: 1.4;
}

#activityHeatmap .heatmap-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-top-color: var(--dark);
}

#activityHeatmap .heatmap-cell:hover .heatmap-tooltip {
    opacity: 1;
}

/* Heatmap Legend */
.heatmap-container > div:last-child {
    display: flex;
    align-items: center;
    gap: 2rem;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e2e8f0;
}

.heatmap-container > div:last-child > div {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.heatmap-container > div:last-child > div > div:first-child {
    width: 20px;
    height: 20px;
    border-radius: 2px;
}

.heatmap-container > div:last-child span {
    font-size: 0.875rem;
    color: var(--gray);
}

/* Enhanced Client Modal */
#enhancedClientModal .modal-content {
    max-width: 900px !important;
}

#enhancedClientModal .client-detail-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
}

@media (max-width: 1024px) {
    #enhancedClientModal .client-detail-grid {
        grid-template-columns: 1fr;
    }
}

#enhancedClientModal h3 {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e2e8f0;
}

#enhancedClientModal .info-row {
    display: flex;
    padding: 0.75rem 0;
    border-bottom: 1px solid #e2e8f0;
}

#enhancedClientModal .info-row:last-child {
    border-bottom: none;
}

#enhancedClientModal .info-label {
    font-weight: 500;
    color: var(--gray);
    width: 140px;
    flex-shrink: 0;
    font-size: 0.875rem;
}

#enhancedClientModal .info-value {
    color: var(--dark);
    font-size: 0.875rem;
}

#enhancedClientModal .info-value code {
    background: var(--light);
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.75rem;
}

#enhancedClientModal .stat-card {
    background: var(--light);
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    text-align: center;
    transition: var(--transition);
}

#enhancedClientModal .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}

#enhancedClientModal .stat-card .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 0.25rem;
}

#enhancedClientModal .stat-card .stat-label {
    font-size: 0.75rem;
    color: var(--gray);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* Search History and Filter Usage in Modal */
#enhancedClientModal .usage-metric {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem;
    border-bottom: 1px solid #e2e8f0;
    font-size: 0.875rem;
}

#enhancedClientModal .usage-metric:last-child {
    border-bottom: none;
}

#enhancedClientModal .usage-metric:hover {
    background: var(--light);
}

#enhancedClientModal .usage-metric .metric-label {
    color: var(--dark);
    font-weight: 500;
}

#enhancedClientModal .usage-metric .metric-value {
    color: var(--gray);
    font-size: 0.75rem;
}

/* Empty State for Enhanced Analytics */
#enhanced-analytics .empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--gray);
    font-size: 0.875rem;
}

#enhanced-analytics .empty-state-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.3;
}

/* Loading State for Enhanced Analytics */
#enhanced-analytics .loading-skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    height: 20px;
    border-radius: 4px;
    margin: 0.5rem 0;
}

/* Export Button Styles */
#enhancedClientsTable .btn-group {
    display: flex;
    gap: 0.5rem;
}

#enhancedClientsTable .btn.btn-secondary {
    background: var(--light);
    color: var(--dark);
    border: 1px solid #e2e8f0;
}

#enhancedClientsTable .btn.btn-secondary:hover {
    background: #e2e8f0;
}

/* Responsive Design for Enhanced Analytics */
@media (max-width: 768px) {
    #enhanced-analytics .stats-grid {
        grid-template-columns: 1fr;
    }

    #enhanced-analytics .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    #activityHeatmap {
        grid-template-columns: repeat(12, 1fr);
    }

    #enhanced-analytics .card + div {
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .heatmap-container > div:last-child {
        flex-wrap: wrap;
        gap: 1rem;
    }
}

@media (max-width: 480px) {
    #enhancedClientSearch {
        width: 100% !important;
        max-width: 100% !important;
    }

    #enhanced-analytics .stat-value {
        font-size: 1.5rem;
    }

    #activityHeatmap {
        grid-template-columns: repeat(8, 1fr);
    }

    #enhancedClientModal .modal-content {
        width: 95%;
        padding: 1.5rem;
    }

    #enhancedClientModal .client-detail-grid {
        grid-template-columns: 1fr;
    }
}

/* Print Styles for Enhanced Analytics */
@media print {
    #enhanced-analytics .btn {
        display: none;
    }

    #enhanced-analytics .card {
        box-shadow: none;
        border: 1px solid #e2e8f0;
        page-break-inside: avoid;
    }

    #activityHeatmap {
        grid-template-columns: repeat(24, 1fr);
    }
}

/* Dark Mode Support (if implemented) */
@media (prefers-color-scheme: dark) {
    #enhanced-analytics .card {
        background: #1a202c;
        color: #e2e8f0;
    }

    #enhanced-analytics .stat-card {
        background: #2d3748;
    }

    #enhanced-analytics .stat-label {
        color: #a0aec0;
    }

    #enhanced-analytics .stat-value {
        color: #e2e8f0;
    }

    #activityHeatmap .heatmap-cell {
        background: #2d3748;
    }

    #enhancedClientModal .modal-content {
        background: #1a202c;
        color: #e2e8f0;
    }
}

        #enhanced-analytics .stat-card {
    background: var(--white) !important;
    color: var(--dark) !important;
}

#enhanced-analytics .stat-value {
    color: var(--dark) !important;
}

#enhanced-analytics .stat-label {
    color: var(--gray) !important;
}

#enhanced-analytics .card {
    background: var(--white) !important;
    color: var(--dark) !important;
}

#enhanced-analytics .card-header {
    background: var(--white) !important;
    color: var(--dark) !important;
}

#enhanced-analytics .card-title {
    color: var(--dark) !important;
}

#enhanced-analytics table {
    background: var(--white) !important;
    color: var(--dark) !important;
}

#enhanced-analytics th {
    background: var(--light) !important;
    color: var(--gray) !important;
}

#enhanced-analytics td {
    background: var(--white) !important;
    color: var(--dark) !important;
}

#enhanced-analytics .empty-state {
    color: var(--gray) !important;
    background: var(--white) !important;
}

#enhanced-analytics .usage-metric {
    background: var(--white) !important;
}

#enhanced-analytics .usage-metric .metric-label {
    color: var(--dark) !important;
}

#enhanced-analytics .usage-metric .metric-value {
    color: var(--primary) !important;
    font-weight: 600;
}

#enhanced-analytics .heatmap-container {
    background: var(--white) !important;
}

#enhanced-analytics .form-input {
    background: var(--white) !important;
    color: var(--dark) !important;
    border: 1px solid #e2e8f0 !important;
}

#enhanced-analytics .btn {
    background: var(--primary) !important;
    color: var(--white) !important;
}

#enhanced-analytics .btn:hover {
    background: var(--primary-dark) !important;
}

/* Fix for the modal */
#enhancedClientModal .modal-content {
    background: var(--white) !important;
    color: var(--dark) !important;
}

#enhancedClientModal .info-row {
    background: var(--white) !important;
}

#enhancedClientModal .info-label {
    color: var(--gray) !important;
}

#enhancedClientModal .info-value {
    color: var(--dark) !important;
}

#enhancedClientModal .stat-card {
    background: var(--light) !important;
}

#enhancedClientModal .stat-value {
    color: var(--primary) !important;
}

#enhancedClientModal .stat-label {
    color: var(--gray) !important;
}

/* Fix chart container backgrounds */
#enhanced-analytics .chart-container {
    background: var(--white) !important;
    padding: 1rem;
    border-radius: 8px;
}

/* Ensure Popular Filters and Searches are readable */
#popularFilters,
#popularSearches {
    background: var(--white) !important;
    color: var(--dark) !important;
}

#popularFilters .usage-metric:hover,
#popularSearches .usage-metric:hover {
    background: var(--light) !important;
}

/* Fix heatmap cells */
#activityHeatmap .heatmap-cell {
    border: 1px solid rgba(0,0,0,0.1);
}

#activityHeatmap .heatmap-cell.low {
    background: rgba(102, 126, 234, 0.2) !important;
}

#activityHeatmap .heatmap-cell.medium {
    background: rgba(102, 126, 234, 0.5) !important;
}

#activityHeatmap .heatmap-cell.high {
    background: rgba(102, 126, 234, 0.8) !important;
}

#activityHeatmap .heatmap-cell.peak {
    background: var(--primary) !important;
}
    </style>
</head>
<body>
<div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <span>🏥</span>
                <span>BMJ Careers Admin</span>
            </div>
        </div>
        <nav class="sidebar-menu">
            <button class="menu-item active" onclick="showSection('dashboard')">
                <span class="menu-icon">📊</span>
                <span>Dashboard</span>
            </button>
            <button class="menu-item" onclick="showSection('sessions')">
                <span class="menu-icon">👥</span>
                <span>Live Sessions</span>
            </button>
            <button class="menu-item" onclick="showSection('clients')">
                <span class="menu-icon">🏢</span>
                <span>Clients</span>
            </button>
            <button class="menu-item" onclick="showSection('analytics')">
                <span class="menu-icon">📈</span>
                <span>Analytics</span>
            </button>
            <button class="menu-item" onclick="showSection('billing')">
                <span class="menu-icon">💷</span>
                <span>Billing</span>
            </button>
            <button class="menu-item" onclick="showSection('api')">
                <span class="menu-icon">🔑</span>
                <span>API Keys</span>
            </button>
            <button class="menu-item" onclick="showSection('activity')">
                <span class="menu-icon">⚡</span>
                <span>Activity Feed</span>
            </button>
            <button class="menu-item" onclick="showSection('jobsdata')">
                <span class="menu-icon">📋</span>
                <span>Jobs Data</span>
            </button>
            <button class="menu-item" onclick="showSection('settings')">
                <span class="menu-icon">⚙️</span>
                <span>Settings</span>
            </button>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1 class="header-title" id="pageTitle">Dashboard</h1>
                <div class="header-actions">
                    <span class="real-time-indicator">
                        <span class="real-time-dot"></span>
                        <span>Live</span>
                    </span>
                    <div class="user-dropdown">
                        <div class="user-menu" onclick="toggleUserDropdown()">
                            <div class="user-avatar" id="userAvatar">A</div>
                            <span id="userName">Admin</span>
                            <span class="dropdown-arrow">▼</span>
                        </div>
                        <div class="user-dropdown-menu" id="userDropdownMenu">
                            <div class="dropdown-header">
                                <div class="user-email" id="userEmail">admin@bmj.com</div>
                                <div class="user-role">Administrator</div>
                            </div>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item" onclick="showProfile()">
                                <span class="dropdown-icon">👤</span>
                                Profile Settings
                            </a>
                            <a href="#" class="dropdown-item" onclick="logout()">
                                <span class="dropdown-icon">🚪</span>
                                Logout
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content -->
        <div class="content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section active">
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon primary">🏢</div>
                        <div class="stat-value" id="totalClients">0</div>
                        <div class="stat-label">Total Clients</div>
                        <div class="stat-change positive">
                            <span>↑ 12%</span> vs last month
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon success">👥</div>
                        <div class="stat-value" id="activeSessions">0</div>
                        <div class="stat-label">Active Sessions</div>
                        <div class="stat-change positive">
                            <span>↑ 8%</span> vs yesterday
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon warning">📊</div>
                        <div class="stat-value" id="totalPageViews">0</div>
                        <div class="stat-label">Page Views Today</div>
                        <div class="stat-change negative">
                            <span>↓ 3%</span> vs yesterday
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon info">💷</div>
                        <div class="stat-value" id="monthlyOwed">£0</div>
                        <div class="stat-label">Monthly Owed</div>
                        <div class="stat-change negative">
                            <span>↑ 25%</span> vs last month
                        </div>
                    </div>
                </div>

                <!-- Recent Sessions with Enhanced Tracking -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Recent Sessions</h2>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <span class="tracking-live">Tracking Active</span>
                            <button class="btn btn-primary btn-sm" onclick="showSection('sessions')">
                                View All
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="session-grid" id="recentSessions">
                            <!-- Sessions will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Usage Chart -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Usage Trends</h2>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-secondary active" onclick="updateUsageChart('7d')">7 Days</button>
                            <button class="btn btn-sm btn-secondary" onclick="updateUsageChart('30d')">30 Days</button>
                            <button class="btn btn-sm btn-secondary" onclick="updateUsageChart('90d')">90 Days</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="usageChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Enhanced Analytics Section - NOW AS A SEPARATE SECTION -->
            <section id="enhanced-analytics" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Enhanced Client Analytics</h2>
                        <button class="btn btn-primary" onclick="refreshEnhancedAnalytics()">
                            🔄 Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Engagement Metrics -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon primary">📊</div>
                                <div class="stat-value" id="avgEngagementScore">0</div>
                                <div class="stat-label">Avg Engagement Score</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon success">📈</div>
                                <div class="stat-value" id="avgScrollDepth">0%</div>
                                <div class="stat-label">Avg Scroll Depth</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon warning">🔍</div>
                                <div class="stat-value" id="totalSearches">0</div>
                                <div class="stat-label">Total Searches</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon info">👆</div>
                                <div class="stat-value" id="avgInteractionRate">0%</div>
                                <div class="stat-label">Avg Interaction Rate</div>
                            </div>
                        </div>

                        <!-- Client Engagement Table -->
                        <div class="card" style="margin-top: 2rem;">
                            <div class="card-header">
                                <h3 class="card-title">Client Engagement Details</h3>
                                <input type="text"
                                       class="form-input"
                                       placeholder="Search clients..."
                                       style="width: 300px; max-width: 100%;"
                                       id="enhancedClientSearch"
                                       onkeyup="searchEnhancedClients(this.value)">
                            </div>
                            <div class="card-body">
                                <div class="table-container">
                                    <table>
                                        <thead>
                                        <tr>
                                            <th>Client</th>
                                            <th>Session ID</th>
                                            <th>Engagement Score</th>
                                            <th>Scroll Depth</th>
                                            <th>Searches</th>
                                            <th>Interactions</th>
                                            <th>Conversion Rate</th>
                                            <th>Session Duration</th>
                                            <th>Actions</th>
                                        </tr>
                                        </thead>
                                        <tbody id="enhancedClientsTable">
                                        <tr>
                                            <td colspan="9" class="empty-state">Loading enhanced analytics data...</td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Popular Filters and Searches -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Popular Filters</h3>
                                </div>
                                <div class="card-body">
                                    <div id="popularFilters">
                                        <div class="empty-state">Loading filter data...</div>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Popular Search Terms</h3>
                                </div>
                                <div class="card-body">
                                    <div id="popularSearches">
                                        <div class="empty-state">Loading search data...</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Device Breakdown -->
                        <div class="card" style="margin-top: 2rem;">
                            <div class="card-header">
                                <h3 class="card-title">Device Breakdown</h3>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="deviceChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Hourly Activity Heatmap -->
                        <div class="card" style="margin-top: 2rem;">
                            <div class="card-header">
                                <h3 class="card-title">Activity Heatmap (24 Hours)</h3>
                            </div>
                            <div class="card-body">
                                <div class="heatmap-container">
                                    <div class="heatmap-grid" id="activityHeatmap">
                                        <!-- Heatmap will be generated here -->
                                    </div>
                                    <div style="margin-top: 1rem; display: flex; align-items: center; gap: 2rem;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <div style="width: 20px; height: 20px; background: rgba(102, 126, 234, 0.2); border-radius: 2px;"></div>
                                            <span style="font-size: 0.875rem; color: var(--gray);">Low Activity</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <div style="width: 20px; height: 20px; background: rgba(102, 126, 234, 0.5); border-radius: 2px;"></div>
                                            <span style="font-size: 0.875rem; color: var(--gray);">Medium Activity</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <div style="width: 20px; height: 20px; background: rgba(102, 126, 234, 0.8); border-radius: 2px;"></div>
                                            <span style="font-size: 0.875rem; color: var(--gray);">High Activity</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <div style="width: 20px; height: 20px; background: var(--primary); border-radius: 2px;"></div>
                                            <span style="font-size: 0.875rem; color: var(--gray);">Peak Activity</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Jobs Data Section -->
            <section id="jobsdata" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Jobs Data API</h2>
                    </div>
                    <div class="card-body">
                        <!-- Dynamic API Endpoints -->
                        <div class="api-section">
                            <h3 style="margin-bottom: 1rem;">API Endpoints</h3>

                            <!-- Public endpoint without auth -->
                            <div style="margin-bottom: 1rem;">
                                <h4 style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">Public Endpoint (No Authentication)</h4>
                                <div class="code-block">
                                    <code id="publicEndpoint"></code>
                                    <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('publicEndpoint')">
                                        Copy URL
                                    </button>
                                </div>
                            </div>

                            <!-- Authenticated endpoint -->
                            <div>
                                <h4 style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">Authenticated Endpoint (Requires API Key)</h4>
                                <div class="code-block">
                                    <code id="authEndpoint"></code>
                                    <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('authEndpoint')">
                                        Copy URL
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Jobs Data Preview -->
                        <div class="api-section" style="margin-top: 2rem;">
                            <h3 style="margin-bottom: 1rem;">Jobs Data Structure</h3>
                            <div class="json-controls">
                                <button class="btn btn-primary" onclick="loadJobsData()">
                                    Load Current Jobs
                                </button>
                                <button class="btn btn-secondary" onclick="downloadJobsData()">
                                    Download JSON
                                </button>
                                <button class="btn btn-secondary" onclick="refreshJobsData()">
                                    🔄 Refresh
                                </button>
                                <span id="jobsCount" style="align-self: center; color: var(--gray);">
                                    Click to load jobs data
                                </span>
                            </div>

                            <div class="json-stats" id="jobsStats" style="display: none;">
                                <div class="json-stat">
                                    <div class="json-stat-value" id="totalJobsCount">0</div>
                                    <div class="json-stat-label">Total Jobs</div>
                                </div>
                                <div class="json-stat">
                                    <div class="json-stat-value" id="newJobsCount">0</div>
                                    <div class="json-stat-label">New Jobs</div>
                                </div>
                                <div class="json-stat">
                                    <div class="json-stat-value" id="updatedJobsCount">0</div>
                                    <div class="json-stat-label">Updated</div>
                                </div>
                                <div class="json-stat">
                                    <div class="json-stat-value" id="dataSource">-</div>
                                    <div class="json-stat-label">Source</div>
                                </div>
                            </div>

                            <div class="json-viewer" id="jobsDataViewer">
                                <pre><code>// Jobs data will appear here</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Live Sessions Section -->
            <section id="sessions" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Live Sessions Monitor</h2>
                        <div class="header-actions">
                            <span class="badge" id="sessionCount">0 Active</span>
                            <button class="btn btn-sm btn-secondary" onclick="refreshSessions()">
                                🔄 Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="sessionsContainer">
                            <!-- Live sessions will be loaded here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Clients Section -->
            <section id="clients" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Client Management</h2>
                        <input type="text"
                               class="form-input"
                               placeholder="Search clients..."
                               style="width: 300px; max-width: 100%;"
                               id="clientSearchInput"
                               onkeyup="searchClients(this.value)">
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>Domain</th>
                                    <th>Sessions</th>
                                    <th>Page Views</th>
                                    <th>Clicks</th>
                                    <th>Revenue</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="clientsTable">
                                <!-- Clients will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analytics" class="section">
                <div class="stats-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Session Distribution</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="sessionDistChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Revenue by Client Type</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">Geographic Distribution</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="geoChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Billing Section -->
            <section id="billing" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Third Party Billing</h2>
                    </div>
                    <div class="card-body">
                        <div class="settings-form">
                            <div class="form-group">
                                <label class="form-label">Select Installation</label>
                                <select class="form-select" id="billingClient" onchange="loadClientBillingSettings()">
                                    <option value="">Select a client...</option>
                                </select>
                            </div>

                            <div id="clientBillingSettings" style="display: none;">
                                <div class="form-group">
                                    <label class="form-label">Cost Per Click (£)</label>
                                    <input type="number" class="form-input" id="clientCPC" value="0.50" step="0.01">
                                    <button class="btn btn-sm btn-secondary" onclick="saveClientCPC()">Save Rate</button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Billing Period</label>
                                <input type="month" class="form-input" id="billingMonth" max="${new Date().toISOString().slice(0, 7)}">
                            </div>

                            <button class="btn btn-primary" onclick="generateBillingReport()">
                                Generate Report
                            </button>
                        </div>

                        <div id="billingReport" style="display: none; margin-top: 2rem;">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title" id="reportTitle">Billing Report</h3>
                                    <div>
                                        <button class="btn btn-sm btn-secondary" onclick="exportBillingPDF()">
                                            📄 Export PDF
                                        </button>
                                        <button class="btn btn-sm btn-secondary" onclick="exportBillingCSV()">
                                            📊 Export CSV
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="revenue-calculator" style="background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);">
                                        <div class="revenue-amount" id="totalOwed">£0.00</div>
                                        <div class="revenue-period" id="billingPeriodText">Amount Owed</div>
                                        <div class="revenue-breakdown">
                                            <div class="breakdown-item">
                                                <div class="breakdown-value" id="totalClicks">0</div>
                                                <div class="breakdown-label">Total Clicks</div>
                                            </div>
                                            <div class="breakdown-item">
                                                <div class="breakdown-value" id="cpcRate">£0.00</div>
                                                <div class="breakdown-label">Rate per Click</div>
                                            </div>
                                            <div class="breakdown-item">
                                                <div class="breakdown-value" id="uniqueJobs">0</div>
                                                <div class="breakdown-label">Unique Jobs</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div style="margin-top: 2rem;">
                                        <h4 style="margin-bottom: 1rem;">Click Details by Job</h4>
                                        <div class="table-container">
                                            <table>
                                                <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Job Title</th>
                                                    <th>Job ID</th>
                                                    <th>Location</th>
                                                    <th>Clicks</th>
                                                    <th>Cost</th>
                                                </tr>
                                                </thead>
                                                <tbody id="billingDetailsTable">
                                                <!-- Details will be loaded here -->
                                                </tbody>
                                                <tfoot>
                                                <tr style="font-weight: 600; background: var(--light);">
                                                    <td colspan="4">Total</td>
                                                    <td id="footerTotalClicks">0</td>
                                                    <td id="footerTotalCost">£0.00</td>
                                                </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- API Keys Section -->
            <section id="api" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">API Key Management</h2>
                        <button class="btn btn-primary" onclick="showGenerateKeyModal()">
                            Generate New Key
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>API Key</th>
                                    <th>Created</th>
                                    <th>Usage</th>
                                    <th>Last Used</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="apiKeysTable">
                                <!-- API keys will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Code Examples Section -->
                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <h2 class="card-title">API Integration Examples</h2>
                    </div>
                    <div class="card-body">
                        <div class="api-section">
                            <h3 style="margin-bottom: 1rem;">Quick Start Guide</h3>
                            <p style="color: var(--gray); margin-bottom: 1rem;">
                                Use these code examples to integrate the BMJ Careers API into your application.
                                Replace <code>YOUR_API_KEY</code> with your actual API key.
                            </p>

                            <!-- Code Tabs -->
                            <div class="code-tabs">
                                <button class="code-tab active" onclick="showCodeExample('javascript')">JavaScript</button>
                                <button class="code-tab" onclick="showCodeExample('python')">Python</button>
                                <button class="code-tab" onclick="showCodeExample('curl')">cURL</button>
                                <button class="code-tab" onclick="showCodeExample('php')">PHP</button>
                            </div>

                            <!-- JavaScript Example -->
                            <pre class="code-example active" id="code-javascript"><code>// Fetch jobs using JavaScript
const API_KEY = 'YOUR_API_KEY';
const API_URL = '${window.location.origin}/api/v1/jobs';

async function fetchJobs() {
    try {
        const response = await fetch(API_URL, {
            headers: {
                'X-API-Key': API_KEY
            }
        });

        if (!response.ok) {
            throw new Error('API request failed');
        }

        const data = await response.json();
        console.log(`Found ${data.data.jobs.length} jobs`);

        // Process jobs
        data.data.jobs.forEach(job => {
            console.log(`${job.job_title} - ${job.location_description}`);
        });

        return data.data.jobs;
    } catch (error) {
        console.error('Error fetching jobs:', error);
    }
}

// Call the function
fetchJobs();</code></pre>

                            <!-- Python Example -->
                            <pre class="code-example" id="code-python" style="display: none;"><code>import requests

# API Configuration
API_KEY = 'YOUR_API_KEY'
API_URL = '${window.location.origin}/api/v1/jobs'

def fetch_jobs():
    """Fetch jobs from BMJ Careers API"""

    headers = {
        'X-API-Key': API_KEY
    }

    try:
        response = requests.get(API_URL, headers=headers)
        response.raise_for_status()

        data = response.json()
        jobs = data['data']['jobs']

        print(f"Found {len(jobs)} jobs")

        # Process jobs
        for job in jobs:
            print(f"{job['job_title']} - {job['location_description']}")

        return jobs

    except requests.exceptions.RequestException as e:
        print(f"Error fetching jobs: {e}")
        return None

# Call the function
if __name__ == "__main__":
    jobs = fetch_jobs()</code></pre>

                            <!-- cURL Example -->
                            <pre class="code-example" id="code-curl" style="display: none;"><code># Fetch jobs using cURL
curl -X GET "${window.location.origin}/api/v1/jobs" \
     -H "X-API-Key: YOUR_API_KEY" \
     -H "Content-Type: application/json"

# Pretty print the JSON response
curl -X GET "${window.location.origin}/api/v1/jobs" \
     -H "X-API-Key: YOUR_API_KEY" \
     -H "Content-Type: application/json" | python -m json.tool

# Save response to file
curl -X GET "${window.location.origin}/api/v1/jobs" \
     -H "X-API-Key: YOUR_API_KEY" \
     -H "Content-Type: application/json" \
     -o jobs.json</code></pre>

                            <!-- PHP Example -->
                            <pre class="code-example" id="code-php" style="display: none;"><code>&lt;?php
// API Configuration
$apiKey = 'YOUR_API_KEY';
$apiUrl = '${window.location.origin}/api/v1/jobs';

function fetchJobs($apiUrl, $apiKey) {
    // Initialize cURL
    $ch = curl_init();

    // Set cURL options
    curl_setopt($ch, CURLOPT_URL, $apiUrl);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, array(
        'X-API-Key: ' . $apiKey,
        'Content-Type: application/json'
    ));

    // Execute request
    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);

    // Check for errors
    if (curl_errno($ch)) {
        echo 'Error: ' . curl_error($ch);
        curl_close($ch);
        return null;
    }

    curl_close($ch);

    // Parse response
    if ($httpCode === 200) {
        $data = json_decode($response, true);
        $jobs = $data['data']['jobs'];

        echo "Found " . count($jobs) . " jobs\n";

        // Process jobs
        foreach ($jobs as $job) {
            echo $job['job_title'] . " - " . $job['location_description'] . "\n";
        }

        return $jobs;
    } else {
        echo "API request failed with status: " . $httpCode;
        return null;
    }
}

// Call the function
$jobs = fetchJobs($apiUrl, $apiKey);
?&gt;</code></pre>
                        </div>

                        <!-- API Response Format -->
                        <div class="api-section" style="margin-top: 2rem;">
                            <h3 style="margin-bottom: 1rem;">API Response Format</h3>
                            <pre class="code-example" style="display: block;"><code>{
    "success": true,
    "data": {
        "jobs": [
            {
                "id": 123456,
                "job_title": "Consultant Cardiologist",
                "location_description": "London, UK",
                "salary": "£93,666 - £126,281",
                "short_description": "Exciting opportunity for experienced consultant...",
                "job_url": "https://www.bmj.com/careers/job/123456",
                "sector": ["Cardiology", "Consultant"],
                "grade": "Consultant",
                "contract_type": "Permanent",
                "recruiter_name": "NHS Trust",
                "published": "Posted 2 days ago",
                "job_start_date": "2024-01-15",
                "job_end_date": "2024-02-15"
            }
            // ... more jobs
        ],
        "total": 150,
        "timestamp": "2024-01-10T14:30:00Z"
    },
    "meta": {
        "source": "synced",
        "cached": false
    }
}</code></pre>
                        </div>
                    </div>
                </div>
            </section>


            <!-- Activity Feed Section -->
            <section id="activity" class="section">
                <div class="stats-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Page Loads</h3>
                            <span class="real-time-indicator">
                    <span class="real-time-dot"></span>
                    <span>Live</span>
                </span>
                        </div>
                        <div class="card-body">
                            <div class="activity-feed" id="loadsFeed">
                                <!-- Activity items will be loaded here -->
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Clicks</h3>
                            <span class="real-time-indicator">
                    <span class="real-time-dot"></span>
                    <span>Live</span>
                </span>
                        </div>
                        <div class="card-body">
                            <div class="activity-feed" id="clicksFeed">
                                <!-- Activity items will be loaded here -->
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">API Calls</h3>
                            <span class="real-time-indicator">
                    <span class="real-time-dot"></span>
                    <span>Live</span>
                </span>
                        </div>
                        <div class="card-body">
                            <div class="activity-feed" id="apiFeed">
                                <!-- Activity items will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="section">
                <!-- System Health Card -->
                <div class="card" style="margin-bottom: 2rem;">
                    <div class="card-header">
                        <h2 class="card-title">System Health & Status</h2>
                        <button class="btn btn-primary btn-sm" onclick="checkSystemHealth()">
                            🔄 Check Status
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon success">🟢</div>
                                <div class="stat-value" id="systemStatus">Checking...</div>
                                <div class="stat-label">System Status</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon info">🗄️</div>
                                <div class="stat-value" id="dynamoStatus">Checking...</div>
                                <div class="stat-label">DynamoDB Status</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon warning">📡</div>
                                <div class="stat-value" id="feedSource">Checking...</div>
                                <div class="stat-label">Data Source</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon primary">⏱️</div>
                                <div class="stat-value" id="cacheAge">Checking...</div>
                                <div class="stat-label">Cache Age</div>
                            </div>
                        </div>

                        <!-- Detailed Status Information -->
                        <div style="margin-top: 2rem; padding: 1rem; background: var(--light); border-radius: 8px;">
                            <h4 style="margin-bottom: 1rem;">System Details</h4>
                            <div class="usage-metric">
                                <span class="metric-label">API Endpoint:</span>
                                <span class="metric-value" id="apiEndpoint">${window.location.origin}/api</span>
                            </div>
                            <div class="usage-metric">
                                <span class="metric-label">Jobs Feed URL:</span>
                                <span class="metric-value" id="feedUrl">Loading...</span>
                            </div>
                            <div class="usage-metric">
                                <span class="metric-label">Total Jobs Cached:</span>
                                <span class="metric-value" id="totalJobsCached">0</span>
                            </div>
                            <div class="usage-metric">
                                <span class="metric-label">Last Sync Time:</span>
                                <span class="metric-value" id="lastSyncTime">Never</span>
                            </div>
                            <div class="usage-metric">
                                <span class="metric-label">Server Uptime:</span>
                                <span class="metric-value" id="serverUptime">Unknown</span>
                            </div>
                            <div class="usage-metric">
                                <span class="metric-label">Memory Usage:</span>
                                <span class="metric-value" id="memoryUsage">Unknown</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Existing Settings Card -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">System Settings</h2>
                    </div>
                    <div class="card-body">
                        <div class="settings-form">
                            <h3 style="margin-bottom: 1rem;">Tracking Settings</h3>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="trackInternalIPs" checked onchange="saveSettings()">
                                    Track Internal IPs
                                </label>
                                <div class="form-help">Track sessions from internal network IPs</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Session Timeout (minutes)</label>
                                <input type="number" class="form-input" id="sessionTimeout" value="30" onchange="saveSettings()">
                                <div class="form-help">Consider session ended after this many minutes of inactivity</div>
                            </div>

                            <h3 style="margin: 2rem 0 1rem;">Notification Settings</h3>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="enableNotifications" checked onchange="saveSettings()">
                                    Enable Real-time Notifications
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Alert Threshold (concurrent sessions)</label>
                                <input type="number" class="form-input" id="alertThreshold" value="100" onchange="saveSettings()">
                                <div class="form-help">Send alert when concurrent sessions exceed this number</div>
                            </div>

                            <h3 style="margin: 2rem 0 1rem;">Data Retention</h3>
                            <div class="form-group">
                                <label class="form-label">Keep Session Data For</label>
                                <select class="form-select" id="dataRetention" onchange="saveSettings()">
                                    <option value="7">7 days</option>
                                    <option value="30">30 days</option>
                                    <option value="90" selected>90 days</option>
                                    <option value="180">180 days</option>
                                    <option value="365">1 year</option>
                                </select>
                            </div>

                            <button class="btn btn-primary" onclick="exportAllData()">
                                Export All Data
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleSidebar()">☰</button>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast">
    <div class="toast-icon" id="toastIcon">✓</div>
    <div class="toast-content">
        <div class="toast-title" id="toastTitle">Success</div>
        <div class="toast-message" id="toastMessage">Operation completed successfully</div>
    </div>
</div>

<div class="modal" id="enhancedClientModal">
    <div class="modal-content" style="max-width: 900px;">
        <h2 id="enhancedClientModalTitle" style="margin-bottom: 1.5rem;">Client Detailed Analytics</h2>
        <div id="enhancedClientModalContent">
            <!-- Enhanced client details will be loaded here -->
        </div>
        <button class="btn btn-secondary" onclick="closeModal('enhancedClientModal')" style="margin-top: 1.5rem;">
            Close
        </button>
    </div>
</div>

<script>
    // Global state
    let state = {
        clients: [],
        sessions: [],
        apiKeys: [],
        charts: {},
        jobsData: null,
        currentOrigin: window.location.origin,
        settings: {
            trackLocalhost: true,
            trackInternalIPs: true,
            sessionTimeout: 30,
            enableNotifications: true,
            alertThreshold: 100,
            dataRetention: 90
        },
        refreshInterval: null
    };

    // Initialize dynamic endpoints
    function initializeDynamicEndpoints() {
        const origin = window.location.origin;

        // Update public endpoint
        document.getElementById('publicEndpoint').textContent = `${origin}/api/jobs`;

        // Update authenticated endpoint
        document.getElementById('authEndpoint').textContent = `${origin}/api/v1/jobs`;

        // Update all code examples dynamically
        updateCodeExamples(origin);
    }

    // Update code examples with current origin
    function updateCodeExamples(origin) {
        // This will be called when showing code tabs
        window.currentApiOrigin = origin;
    }

    // Enhanced authentication check
    const sessionToken = localStorage.getItem('sessionToken');
    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');

    if (!sessionToken || !userInfo.email) {
        window.location.href = '/login?redirect=/admin';
    }

    // Set user info
    document.getElementById('userName').textContent = userInfo.username || 'Admin';
    document.getElementById('userEmail').textContent = userInfo.email || 'admin@bmj.com';
    document.getElementById('userAvatar').textContent = (userInfo.username || 'Admin').charAt(0).toUpperCase();

    // Toggle user dropdown
    function toggleUserDropdown() {
        const dropdown = document.getElementById('userDropdownMenu');
        dropdown.classList.toggle('show');

        // Close dropdown when clicking outside
        document.addEventListener('click', function closeDropdown(e) {
            if (!e.target.closest('.user-dropdown')) {
                dropdown.classList.remove('show');
                document.removeEventListener('click', closeDropdown);
            }
        });
    }

    // Enhanced logout function
    async function logout() {
        try {
            await fetch('/api/auth/logout', {
                method: 'POST',
                headers: {
                    'x-session-token': sessionToken
                }
            });

            localStorage.removeItem('sessionToken');
            localStorage.removeItem('userInfo');
            window.location.href = state.currentOrigin;
        } catch (error) {
            console.error('Logout error:', error);
            localStorage.clear();
            window.location.href = '/';
        }
    }

    // Initialize on DOM load
// Initialize on DOM load
document.addEventListener('DOMContentLoaded', () => {
    initializeDynamicEndpoints();
    loadSettings();
    loadSettingsUI();
    initializeAllCharts(); // Use the new function
    loadDashboard();
    startRealTimeUpdates();

    // Add sidebar overlay
    const overlay = document.createElement('div');
    overlay.className = 'sidebar-overlay';
    overlay.onclick = () => toggleSidebar();
    document.body.appendChild(overlay);
});


    // Initialize charts
    function initializeCharts() {
        // Usage Chart
        const usageCtx = document.getElementById('usageChart').getContext('2d');
        state.charts.usage = new Chart(usageCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Page Views',
                    data: [],
                    borderColor: '#0066cc',
                    backgroundColor: 'rgba(0, 102, 204, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Job Clicks',
                    data: [],
                    borderColor: '#FFC000',
                    backgroundColor: 'rgba(255, 192, 0, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Sessions',
                    data: [],
                    borderColor: '#48bb78',
                    backgroundColor: 'rgba(72, 187, 120, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                if (context.dataset.label === 'Job Clicks') {
                                    return 'Revenue: £' + (context.parsed.y * 0.50).toFixed(2);
                                }
                                return '';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

// Enhanced load dashboard with iframe tracking
async function loadDashboard() {
    try {
        const response = await fetch('/api/admin/dashboard', {
            headers: {
                'x-session-token': sessionToken
            }
        });

        if (!response.ok) {
            if (response.status === 401) {
                window.location.href = '/login?redirect=/admin';
                return;
            }
            throw new Error('Failed to load dashboard');
        }

        const data = await response.json();

        // Log raw data for debugging
        console.log('Dashboard API response:', data);

        // Process the data - will filter out localhost
        processDashboardData(data.data || { clients: [], sessions: [], apiKeys: [] });
        updateDashboard();

        // Show appropriate message
        if (state.sessions.length > 0) {
            showToast(`Dashboard loaded: ${state.clients.length} clients active`, 'success');
        } else {
            console.log('No client sessions found - only client_id based sessions are shown');
        }

    } catch (error) {
        console.error('Dashboard error:', error);
        // Initialize with empty data
        processDashboardData({ clients: [], sessions: [], apiKeys: [] });
        updateDashboard();
    }
}


// Enhanced process dashboard data with proper aggregation
function processDashboardData(data) {
    console.log('Raw dashboard data received:', data);

    // Handle both old and new data formats
    const rawSessions = data.clients || data.sessions || [];

    // Create a map to aggregate ALL data by client_id
    const clientMap = {};

    rawSessions.forEach(session => {
        // Determine client key
        let clientKey = null;
        let clientName = null;

        // Priority 1: Use client_id if available
        if (session.client_id && session.client_id !== 'unknown') {
            clientKey = session.client_id;
            clientName = session.client_name || session.client_id;
        }
        // Priority 2: Use utm_source as fallback
        else if (session.utm_source && session.utm_source !== 'direct' && session.utm_source !== 'localhost') {
            clientKey = session.utm_source;
            clientName = session.name || session.utm_source;
        }

        // Skip if no valid client key
        if (!clientKey) return;

        // Initialize client entry if doesn't exist
        if (!clientMap[clientKey]) {
            clientMap[clientKey] = {
                clientId: clientKey,
                clientName: clientName,
                client_id: clientKey,
                client_name: clientName,
                displayName: clientName,
                domain: (session.domain === 'localhost' || session.domain === '127.0.0.1') ? 'Test Environment' : 'Embedded Widget',
                isTestEnvironment: session.domain === 'localhost' || session.domain === '127.0.0.1',
                isIframe: true,

                // Aggregated metrics
                totalMetrics: {
                    loads: 0,
                    clicks: 0,
                    apiCalls: 0
                },
                todayMetrics: {
                    loads: 0,
                    clicks: 0,
                    apiCalls: 0
                },

                // Timing
                firstSeen: null,
                lastSeen: null,

                // Raw sessions for detailed view
                rawSessions: []
            };
        }

        // Aggregate the metrics - ADD to existing totals
        const client = clientMap[clientKey];

        // Add loads/page views
        client.totalMetrics.loads += parseInt(session.loads || session.totalLoads || session.pageViews || session.page_views || 0);
        client.totalMetrics.clicks += parseInt(session.clicks || session.totalClicks || session.jobClicks || session.job_clicks || 0);
        client.totalMetrics.apiCalls += parseInt(session.apiCalls || session.totalApiCalls || session.api_calls || 0);

        // Add today's metrics
        client.todayMetrics.loads += parseInt(session.todayLoads || session.todayPageViews || session.today_loads || 0);
        client.todayMetrics.clicks += parseInt(session.todayClicks || session.todayJobClicks || session.today_clicks || 0);
        client.todayMetrics.apiCalls += parseInt(session.todayApiCalls || session.today_api_calls || 0);

        // Update first seen (earliest)
        const sessionFirstSeen = session.firstSeen || session.createdAt || session.created_at;
        if (sessionFirstSeen && (!client.firstSeen || new Date(sessionFirstSeen) < new Date(client.firstSeen))) {
            client.firstSeen = sessionFirstSeen;
        }

        // Update last seen (latest)
        const sessionLastSeen = session.lastSeen || session.updatedAt || session.updated_at || new Date().toISOString();
        if (!client.lastSeen || new Date(sessionLastSeen) > new Date(client.lastSeen)) {
            client.lastSeen = sessionLastSeen;
        }

        // Store raw session for reference
        client.rawSessions.push(session);
    });

    // Convert client map to arrays for state
    state.clients = [];
    state.sessions = [];

    Object.values(clientMap).forEach(client => {
        // Ensure we have valid timestamps
        if (!client.firstSeen) client.firstSeen = new Date().toISOString();
        if (!client.lastSeen) client.lastSeen = new Date().toISOString();

        // Calculate derived values
        const duration = calculateDuration({
            firstSeen: client.firstSeen,
            lastSeen: client.lastSeen
        });

        const isActive = isSessionActive({ lastSeen: client.lastSeen });

        const revenue = calculateSessionRevenue({
            totalMetrics: client.totalMetrics
        });

        // Create the aggregated session object
        const aggregatedSession = {
            // Identity
            clientIdentifier: client.clientId,
            client_id: client.clientId,
            client_name: client.clientName,
            displayName: client.displayName,
            sessionId: `${client.clientId}_aggregated`,

            // Status
            domain: client.domain,
            isIframe: true,
            isTestEnvironment: client.isTestEnvironment,
            isActive: isActive,

            // Metrics - ensure these are the aggregated totals
            totalMetrics: {
                loads: client.totalMetrics.loads,
                clicks: client.totalMetrics.clicks,
                apiCalls: client.totalMetrics.apiCalls
            },
            todayMetrics: {
                loads: client.todayMetrics.loads,
                clicks: client.todayMetrics.clicks,
                apiCalls: client.todayMetrics.apiCalls
            },

            // Timing
            firstSeen: client.firstSeen,
            lastSeen: client.lastSeen,
            duration: duration,

            // Other
            revenue: revenue,
            sessionCount: client.rawSessions.length,
            metrics: { daily: {} }
        };

        // Add to sessions
        state.sessions.push(aggregatedSession);

        // Create client object
        state.clients.push({
            clientId: client.clientId,
            name: client.displayName,
            domain: client.domain,
            isIframe: true,
            isTestEnvironment: client.isTestEnvironment,
            sessions: [aggregatedSession],
            sessionCount: client.rawSessions.length,
            totalMetrics: {
                loads: client.totalMetrics.loads,
                clicks: client.totalMetrics.clicks,
                apiCalls: client.totalMetrics.apiCalls,
                revenue: revenue
            },
            rawSessions: client.rawSessions // Keep raw sessions for detailed view
        });
    });

    state.apiKeys = data.publicApiKeys || data.apiKeys || [];

    console.log('Final aggregated state:', {
        clients: state.clients,
        sessions: state.sessions,
        clientCount: state.clients.length,
        sessionCount: state.sessions.length
    });

    // Log metrics for debugging
    state.clients.forEach(client => {
        console.log(`Client: ${client.name} (${client.clientId})`);
        console.log(`  - Page Views: ${client.totalMetrics.loads}`);
        console.log(`  - Clicks: ${client.totalMetrics.clicks}`);
        console.log(`  - Sessions: ${client.sessionCount}`);
    });
}

// Add this after the loadDashboard function
async function debugDashboard() {
    try {
        const response = await fetch('/api/admin/dashboard', {
            headers: {
                'x-session-token': sessionToken
            }
        });

        const data = await response.json();
        console.log('Raw API Response:', data);

        if (data.data && data.data.clients) {
            data.data.clients.forEach(client => {
                console.log('Client data:', {
                    client_id: client.client_id,
                    clientId: client.clientId,
                    utm_source: client.utm_source,
                    utm_medium: client.utm_medium,
                    client_name: client.client_name,
                    domain: client.domain,
                    clicks: client.clicks || 0,
                    loads: client.loads || 0
                });
            });
        }
    } catch (error) {
        console.error('Debug error:', error);
    }
}

// When tracking a job click in the widget
function trackJobClick(jobData) {
    // Get client_id from URL parameters or configuration
    const urlParams = new URLSearchParams(window.location.search);
    const clientId = urlParams.get('client_id') || urlParams.get('utm_source');
    const clientName = urlParams.get('client_name');

    // Send tracking data with client info
    fetch('/api/track', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            event: 'job_click',
            client_id: clientId,  // This is crucial
            client_name: clientName,
            session_id: sessionId,
            job_id: jobData.id,
            timestamp: Date.now()
        })
    });
}

// Extract client identifier from session
function extractClientIdentifier(session) {
    // ONLY use client_id - nothing else
    if (session.client_id && session.client_id !== 'unknown') {
        return session.client_id;
    }

    // Check alternative field names
    if (session.clientId && session.clientId !== 'unknown') {
        return session.clientId;
    }

    // Check UTM source as last resort (but not localhost)
    if (session.utm_source &&
        session.utm_source !== 'direct' &&
        session.utm_source !== 'localhost' &&
        session.utm_source !== '127.0.0.1') {
        return session.utm_source;
    }

    // Return null for anything else (will be filtered out)
    return null;
}

    // Calculate session duration
    function calculateDuration(session) {
        const start = new Date(session.firstSeen);
        const end = new Date(session.lastSeen);
        const diff = end - start;

        const hours = Math.floor(diff / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);

        if (hours > 0) return `${hours}h ${minutes}m`;
        if (minutes > 0) return `${minutes}m ${seconds}s`;
        return `${seconds}s`;
    }

    // Check if session is active
    function isSessionActive(session) {
        const lastSeen = new Date(session.lastSeen);
        const now = new Date();
        const diffMinutes = (now - lastSeen) / 60000;
        return diffMinutes < state.settings.sessionTimeout;
    }

    // Calculate session revenue
    function calculateSessionRevenue(session) {
        const loads = session.totalMetrics?.loads || 0;
        const clicks = session.totalMetrics?.clicks || 0;
        const apiCalls = session.totalMetrics?.apiCalls || 0;

        // Default pricing
        const costPerView = 0.02;
        const costPerClick = 0.50;
        const costPerSession = 0.10;
        const costPerApi = 0.05;

        return (loads * costPerView) + (clicks * costPerClick) + (apiCalls * costPerApi) + costPerSession;
    }

    // Update dashboard UI
    // Update dashboard UI
function updateDashboard() {
    // Update stats with actual data
    const activeSessions = state.sessions.filter(s => s.isActive).length;
    const totalPageViews = state.sessions.reduce((sum, s) => sum + (s.todayMetrics?.loads || 0), 0);

    // Calculate monthly owed based on actual clicks
    const monthlyOwed = state.sessions.reduce((sum, s) => {
        const clientCPC = clientCPCRates[s.clientIdentifier] || 0.50; // Use stored CPC or default
        return sum + ((s.totalMetrics?.clicks || 0) * clientCPC);
    }, 0);

    document.getElementById('totalClients').textContent = state.clients.length;
    document.getElementById('activeSessions').textContent = activeSessions;
    document.getElementById('totalPageViews').textContent = totalPageViews.toLocaleString();
    document.getElementById('monthlyOwed').textContent = `£${monthlyOwed.toFixed(2)}`;

    updateRecentSessions();

    // Only update charts if they exist and have data
    if (state.charts && state.charts.usage && state.sessions.length > 0) {
        updateAllCharts();
    }

    // Update all sections if they're visible
    if (document.getElementById('clientsTable')) {
        loadClients();
    }
    if (document.getElementById('apiKeysTable')) {
        loadAPIKeys();
    }
    if (document.getElementById('billingClient')) {
        loadBillingSection();
    }
}

// Enhanced update recent sessions with iframe indicators
function updateRecentSessions() {
    const container = document.getElementById('recentSessions');
    const recentSessions = state.sessions
        .sort((a, b) => new Date(b.lastSeen) - new Date(a.lastSeen))
        .slice(0, 6);

    if (recentSessions.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">👥</div>
                <div class="empty-state-title">No sessions yet</div>
                <div class="empty-state-description">Sessions will appear here when clients connect</div>
            </div>
        `;
        return;
    }

    container.innerHTML = recentSessions.map(session => `
        <div class="session-card ${session.isActive ? 'active' : ''}">
            <div class="session-header">
                <div>
                    <div class="session-client">
                        ${session.displayName}
                        <span class="tracking-badge">Widget</span>
                        ${session.isTestEnvironment ? '<span class="tracking-badge iframe-indicator">Test</span>' : ''}
                    </div>
                    <div class="client-identifier">${session.clientIdentifier}</div>
                    ${session.sessionCount > 1 ? `
                        <div style="font-size: 0.625rem; color: var(--gray); margin-top: 0.25rem;">
                            ${session.sessionCount} page refreshes
                        </div>
                    ` : ''}
                </div>
                <span class="session-badge ${session.isActive ? 'active' : 'ended'}">
                    ${session.isActive ? '● Active' : '○ Ended'}
                </span>
            </div>
            <div class="session-metrics">
                <div class="metric-mini">
                    <div class="metric-mini-value">${session.totalMetrics?.loads || 0}</div>
                    <div class="metric-mini-label">Total Views</div>
                </div>
                <div class="metric-mini">
                    <div class="metric-mini-value">${session.totalMetrics?.clicks || 0}</div>
                    <div class="metric-mini-label">Total Clicks</div>
                </div>
                <div class="metric-mini">
                    <div class="metric-mini-value">${session.duration}</div>
                    <div class="metric-mini-label">Total Time</div>
                </div>
                <div class="metric-mini">
                    <div class="metric-mini-value">£${session.revenue.toFixed(2)}</div>
                    <div class="metric-mini-label">Revenue</div>
                </div>
            </div>
        </div>
    `).join('');
}

    // Update charts with real data
    function updateCharts() {
        const last7Days = getLastNDays(7);
        const usageData = calculateUsageData(last7Days);

        state.charts.usage.data.labels = last7Days.map(d => formatDate(d));
        state.charts.usage.data.datasets[0].data = usageData.views;
        state.charts.usage.data.datasets[1].data = usageData.clicks;
        state.charts.usage.data.datasets[2].data = usageData.sessions;
        state.charts.usage.update();
    }

    // Helper functions
    function getLastNDays(n) {
        const days = [];
        for (let i = n - 1; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
           days.push(date);
       }
       return days;
   }

   function formatDate(date) {
       return date.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric' });
   }

   function calculateUsageData(days) {
       const data = {
           views: [],
           clicks: [],
           sessions: []
       };

       days.forEach(day => {
           const dayStr = day.toISOString().split('T')[0];
           let dayViews = 0, dayClicks = 0, daySessions = 0;

           state.sessions.forEach(session => {
               if (session.metrics?.daily?.[dayStr]) {
                   dayViews += session.metrics.daily[dayStr].loads || 0;
                   dayClicks += session.metrics.daily[dayStr].clicks || 0;
                   daySessions++;
               }
           });

           data.views.push(dayViews);
           data.clicks.push(dayClicks);
           data.sessions.push(daySessions);
       });

       return data;
   }

   // Section navigation
   // Section navigation - REPLACE the existing showSection function with this
function showSection(sectionId) {
    // Update menu
    document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active');
    });

    // Find and activate the correct menu item based on section ID
    const menuItems = document.querySelectorAll('.menu-item');
    menuItems.forEach(item => {
        const menuText = item.textContent.toLowerCase();
        const sectionName = sectionId.replace('-', ' ').toLowerCase();

        if ((sectionId === 'dashboard' && menuText.includes('dashboard')) ||
            (sectionId === 'sessions' && menuText.includes('live sessions')) ||
            (sectionId === 'clients' && menuText.includes('clients')) ||
            (sectionId === 'analytics' && menuText.includes('analytics') && !menuText.includes('enhanced')) ||
            (sectionId === 'enhanced-analytics' && menuText.includes('enhanced analytics')) ||
            (sectionId === 'billing' && menuText.includes('billing')) ||
            (sectionId === 'api' && menuText.includes('api')) ||
            (sectionId === 'activity' && menuText.includes('activity')) ||
            (sectionId === 'jobsdata' && menuText.includes('jobs data')) ||
            (sectionId === 'settings' && menuText.includes('settings'))) {
            item.classList.add('active');
        }
    });

    // Update sections
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });

    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
    }

    // Update page title
const titles = {
    'dashboard': 'Dashboard',
    'sessions': 'Live Sessions',
    'clients': 'Client Management',
    'analytics': 'Analytics',
    'enhanced-analytics': 'Enhanced Analytics',
    'billing': 'Third Party Billing',  // Changed from 'Revenue Calculator'
    'api': 'API Management',
    'activity': 'Activity Feed',
    'jobsdata': 'Jobs Data API',
    'settings': 'Settings'
};

    document.getElementById('pageTitle').textContent = titles[sectionId] || 'Dashboard';

    // Load section data
    switch(sectionId) {
        case 'sessions':
            loadSessions();
            break;
        case 'clients':
            loadClients();
            break;
        case 'api':
            loadAPIKeys();
            break;
        case 'activity':
            loadActivity();
            break;
        case 'billing':
            loadBillingSection();
            break;
        case 'jobsdata':
            initializeDynamicEndpoints();
            break;
        case 'enhanced-analytics':
            loadEnhancedAnalytics();
            break;
        case 'analytics':
            // Initialize analytics charts if needed
            if (!state.charts.sessionDist) {
                initializeAllCharts();
            }
            break;
        case 'settings':
            checkSystemHealth();
            break;
    }
}

   // Enhanced Jobs Data functions
   async function loadJobsData() {
       try {
           // Show loading state
           const viewer = document.getElementById('jobsDataViewer');
           const statsDiv = document.getElementById('jobsStats');
           viewer.innerHTML = '<pre><code>Loading jobs data...</code></pre>';

           // Use dynamic origin
           const response = await fetch(`${state.currentOrigin}/api/jobs`, {
               headers: {
                   'x-session-token': sessionToken
               }
           });

           if (!response.ok) {
               throw new Error(`HTTP error! status: ${response.status}`);
           }

           const data = await response.json();

           // Store jobs data in state
           state.jobsData = data;

           // Update stats
           statsDiv.style.display = 'flex';
           document.getElementById('totalJobsCount').textContent = data.total || data.jobs.length;
           document.getElementById('newJobsCount').textContent = data.newJobsCount || 0;
           document.getElementById('updatedJobsCount').textContent = data.updatedJobsCount || 0;
           document.getElementById('dataSource').textContent = data.source || 'API';

           // Format JSON for display with syntax highlighting
           const jobsDisplay = {
               total: data.jobs.length,
               source: data.source,
               fromCache: data.fromCache,
               lastFetch: data.lastFetch,
               jobs: data.jobs
           };

           const formatted = JSON.stringify(jobsDisplay, null, 2);
           const highlighted = formatted
               .replace(/"([^"]+)":/g, '<span class="json-key">"$1"</span>:')
               .replace(/: "([^"]+)"/g, ': <span class="json-string">"$1"</span>')
               .replace(/: (\d+)/g, ': <span class="json-number">$1</span>')
               .replace(/: (true|false)/g, ': <span class="json-boolean">$1</span>')
               .replace(/: (null)/g, ': <span class="json-null">$1</span>');

           viewer.innerHTML = `<pre><code>${highlighted}</code></pre>`;
           document.getElementById('jobsCount').textContent = `${data.jobs.length} jobs loaded`;

           showToast('Jobs data loaded successfully', 'success');
       } catch (error) {
           console.error('Error loading jobs:', error);
           const viewer = document.getElementById('jobsDataViewer');
           viewer.innerHTML = `<pre><code class="error">Error loading jobs: ${error.message}</code></pre>`;
           document.getElementById('jobsStats').style.display = 'none';
           showToast('Error loading jobs data', 'error');
       }
   }

   async function downloadJobsData() {
       try {
           // Check if data is already loaded
           if (!state.jobsData) {
               showToast('Please load jobs data first', 'warning');
               await loadJobsData();
           }

           if (!state.jobsData) {
               throw new Error('No jobs data available');
           }

           // Prepare download data
           const downloadData = {
               total: state.jobsData.jobs.length,
               download_date: new Date().toISOString(),
               source: state.jobsData.source,
               origin: state.currentOrigin,
               jobs: state.jobsData.jobs
           };

           const blob = new Blob([JSON.stringify(downloadData, null, 2)], { type: 'application/json' });
           const url = window.URL.createObjectURL(blob);
           const a = document.createElement('a');
           a.href = url;
           a.download = `bmj-jobs-${new Date().toISOString().split('T')[0]}.json`;
           document.body.appendChild(a);
           a.click();
           window.URL.revokeObjectURL(url);
           document.body.removeChild(a);

           showToast('Jobs data downloaded successfully', 'success');
       } catch (error) {
           console.error('Error downloading jobs:', error);
           showToast('Error downloading jobs data', 'error');
       }
   }

   async function refreshJobsData() {
       try {
           showToast('Refreshing jobs data...', 'info');

           // Force refresh from server
           const response = await fetch(`${state.currentOrigin}/api/jobs/refresh`, {
               method: 'POST',
               headers: {
                   'x-session-token': sessionToken
               }
           });

           if (!response.ok) {
               throw new Error('Failed to refresh jobs');
           }

           const result = await response.json();

           // Reload the jobs data
           await loadJobsData();

           showToast(`Jobs refreshed: ${result.newJobsCount || 0} new, ${result.updatedJobsCount || 0} updated`, 'success');
       } catch (error) {
           console.error('Error refreshing jobs:', error);
           showToast('Error refreshing jobs data', 'error');
       }
   }

   function copyToClipboard(elementId) {
       const element = document.getElementById(elementId);
       const text = element.textContent;

       navigator.clipboard.writeText(text).then(() => {
           showToast('Copied to clipboard', 'success');
       }).catch(() => {
           // Fallback for older browsers
           const textArea = document.createElement('textarea');
           textArea.value = text;
           document.body.appendChild(textArea);
           textArea.select();
           document.execCommand('copy');
           document.body.removeChild(textArea);
           showToast('Copied to clipboard', 'success');
       });
   }

   // Load sessions with aggregated data
function loadSessions() {
    const container = document.getElementById('sessionsContainer');
    const activeSessions = state.sessions.filter(s => s.isActive);

    document.getElementById('sessionCount').textContent = `${activeSessions.length} Active`;

    if (state.sessions.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">👥</div>
                <div class="empty-state-title">No sessions found</div>
            </div>
        `;
        return;
    }

    container.innerHTML = state.sessions.map(session => `
        <div class="session-card ${session.isActive ? 'active' : ''}" style="margin-bottom: 1rem;">
            <div class="session-header">
                <div>
                    <div class="session-client">
                        ${session.displayName}
                        <span class="tracking-badge">Widget</span>
                        ${session.isTestEnvironment ? '<span class="tracking-badge iframe-indicator">Test</span>' : ''}
                    </div>
                    <div class="client-identifier">Client ID: ${session.clientIdentifier}</div>
                    <div style="margin-top: 0.5rem; color: var(--gray); font-size: 0.75rem;">
                        Started: ${new Date(session.firstSeen).toLocaleString()} |
                        Last Active: ${new Date(session.lastSeen).toLocaleString()}
                    </div>
                    ${session.sessionCount > 1 ? `
                        <div style="margin-top: 0.25rem; color: var(--gray); font-size: 0.75rem;">
                            Total Sessions: ${session.sessionCount}
                        </div>
                    ` : ''}
                </div>
                <span class="session-badge ${session.isActive ? 'active' : 'ended'}">
                    ${session.isActive ? '● Active' : '○ Ended'}
                </span>
            </div>
            <div class="session-metrics">
                <div class="metric-mini">
                    <div class="metric-mini-value">${session.totalMetrics?.loads || 0}</div>
                    <div class="metric-mini-label">Total Views</div>
                </div>
                <div class="metric-mini">
                    <div class="metric-mini-value">${session.totalMetrics?.clicks || 0}</div>
                    <div class="metric-mini-label">Total Clicks</div>
                </div>
                <div class="metric-mini">
                    <div class="metric-mini-value">${session.duration}</div>
                    <div class="metric-mini-label">Duration</div>
                </div>
                <div class="metric-mini">
                    <div class="metric-mini-value">£${session.revenue.toFixed(2)}</div>
                    <div class="metric-mini-label">Revenue</div>
                </div>
            </div>
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                <div class="usage-metric">
                    <span class="metric-label">Today's Page Views:</span>
                    <span class="metric-value">${session.todayMetrics?.loads || 0}</span>
                </div>
                <div class="usage-metric">
                    <span class="metric-label">Today's Clicks:</span>
                    <span class="metric-value">${session.todayMetrics?.clicks || 0}</span>
                </div>
            </div>
        </div>
    `).join('');
}


// Enhanced load clients with iframe detection
function loadClients() {
    const tbody = document.getElementById('clientsTable');

    if (state.clients.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No clients found. Waiting for widget connections...</td></tr>';
        return;
    }

    tbody.innerHTML = state.clients.map(client => `
        <tr>
            <td>
                <div style="font-weight: 600;">
                    ${client.name}
                    <span class="tracking-badge">Widget</span>
                    ${client.isTestEnvironment ? '<span class="tracking-badge iframe-indicator">Test</span>' : ''}
                </div>
                <div class="client-identifier">${client.clientId}</div>
                <div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">
                    ${client.sessionCount || 1} page refresh${client.sessionCount !== 1 ? 'es' : ''}
                </div>
            </td>
            <td>${client.domain}</td>
            <td>${client.sessionCount || 1}</td>
            <td>${client.totalMetrics.loads.toLocaleString()}</td>
            <td>${client.totalMetrics.clicks.toLocaleString()}</td>
            <td>£${client.totalMetrics.revenue.toFixed(2)}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="viewClientDetails('${client.clientId}')">
                    View Details
                </button>
            </td>
        </tr>
    `).join('');
}

   // Load settings
   function loadSettings() {
       const savedSettings = localStorage.getItem('adminSettings');
       if (savedSettings) {
           state.settings = JSON.parse(savedSettings);
       }
   }

   // Save settings
   function saveSettings() {
       localStorage.setItem('adminSettings', JSON.stringify(state.settings));
       showToast('Settings saved', 'success');
       loadDashboard();
   }

   // Real-time updates
   function startRealTimeUpdates() {
       // Update every 30 seconds
       state.refreshInterval = setInterval(() => {
           if (state.settings.enableNotifications) {
               loadDashboard();

               // Check for alerts
               const activeSessions = state.sessions.filter(s => s.isActive).length;
               if (activeSessions > state.settings.alertThreshold) {
                   showToast(`High traffic alert: ${activeSessions} active sessions`, 'warning');
               }
           }
       }, 30000);
   }

   // Toast notifications
   function showToast(message, type = 'success') {
       const toast = document.getElementById('toast');
       const toastIcon = document.getElementById('toastIcon');
       const toastTitle = document.getElementById('toastTitle');
       const toastMessage = document.getElementById('toastMessage');

       // Reset classes
       toast.className = 'toast';
       toast.classList.add(type);

       // Set content
       const icons = {
           success: '✓',
           error: '✕',
           warning: '⚠',
           info: 'ℹ'
       };

       const titles = {
           success: 'Success',
           error: 'Error',
           warning: 'Warning',
           info: 'Info'
       };

       toastIcon.textContent = icons[type] || '✓';
       toastTitle.textContent = titles[type] || 'Success';
       toastMessage.textContent = message;

       // Show toast
       toast.classList.add('show');

       // Hide after 3 seconds
       setTimeout(() => {
           toast.classList.remove('show');
       }, 3000);
   }

   // Cleanup on page unload
   window.addEventListener('beforeunload', () => {
       if (state.refreshInterval) {
           clearInterval(state.refreshInterval);
       }
   });

   // Handle responsive menu
   function toggleSidebar() {
       document.getElementById('sidebar').classList.toggle('active');
   }

   window.addEventListener('resize', () => {
       if (window.innerWidth > 768) {
           document.getElementById('sidebar').classList.remove('active');
       }
   });

   // Export functions for debugging
   window.debugState = () => console.log(state);
   window.refreshData = () => loadDashboard();

    // Initialize additional charts
function initializeAllCharts() {
    // Call existing initializeCharts first
    initializeCharts();

    // Session Distribution Chart
    const sessionDistCtx = document.getElementById('sessionDistChart');
    if (sessionDistCtx) {
        state.charts.sessionDist = new Chart(sessionDistCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Direct', 'iFrame', 'API'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: ['#0066cc', '#48bb78', '#FFC000']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // Revenue Chart
    const revenueCtx = document.getElementById('revenueChart');
    if (revenueCtx) {
        state.charts.revenue = new Chart(revenueCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Revenue (£)',
                    data: [],
                    backgroundColor: '#0066cc'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '£' + value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    }

    // Geographic Chart
    const geoCtx = document.getElementById('geoChart');
    if (geoCtx) {
        state.charts.geo = new Chart(geoCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Sessions by Region',
                    data: [],
                    backgroundColor: '#0066cc'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y'
            }
        });
    }
}

// Search clients function
function searchClients(query) {
    const filtered = state.clients.filter(client =>
        client.name.toLowerCase().includes(query.toLowerCase()) ||
        client.clientId.toLowerCase().includes(query.toLowerCase())
    );

    const tbody = document.getElementById('clientsTable');
    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No clients match your search</td></tr>';
        return;
    }

    tbody.innerHTML = filtered.map(client => `
        <tr>
            <td>
                <div style="font-weight: 600;">
                    ${client.name}
                    <span class="tracking-badge">Widget</span>
                    ${client.isTestEnvironment ? '<span class="tracking-badge iframe-indicator">Test</span>' : ''}
                </div>
                <div class="client-identifier">${client.clientId}</div>
                <div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">
                    ${client.sessionCount || 1} session${client.sessionCount !== 1 ? 's' : ''}
                </div>
            </td>
            <td>${client.domain}</td>
            <td>${client.sessionCount || 1}</td>
            <td>${client.totalMetrics.loads.toLocaleString()}</td>
            <td>${client.totalMetrics.clicks.toLocaleString()}</td>
            <td>£${client.totalMetrics.revenue.toFixed(2)}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="viewClientDetails('${client.clientId}')">
                    View Details
                </button>
            </td>
        </tr>
    `).join('');
}


// View client details function
function viewClientDetails(clientId) {
    const client = state.clients.find(c => c.clientId === clientId);
    if (!client) return;

    // Create and show modal with client details
    alert(`Client Details:\n\nName: ${client.name}\nDomain: ${client.domain}\nTotal Revenue: £${client.totalMetrics.revenue.toFixed(2)}\n\nSessions: ${client.sessions.length}\nPage Views: ${client.totalMetrics.loads}\nClicks: ${client.totalMetrics.clicks}`);
}

// Load API Keys
function loadAPIKeys() {
    const tbody = document.getElementById('apiKeysTable');

    if (!state.apiKeys || state.apiKeys.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No API keys generated yet</td></tr>';
        return;
    }

    tbody.innerHTML = state.apiKeys.map(key => `
        <tr>
            <td>${key.clientName}</td>
            <td>
                <code style="background: var(--light); padding: 0.25rem 0.5rem; border-radius: 4px;">
                    ${key.apiKey.substring(0, 20)}...
                </code>
                <button class="btn btn-sm btn-secondary" onclick="copyApiKey('${key.apiKey || key.fullKey}')">
                    Copy
                </button>
            </td>
            <td>${new Date(key.createdAt).toLocaleDateString()}</td>
            <td>${key.totalUsage || 0}</td>
            <td>${key.lastUsed ? new Date(key.lastUsed).toLocaleString() : 'Never'}</td>
            <td>
                <button class="btn btn-sm btn-danger" onclick="revokeApiKey('${key.clientId}')">
                    Revoke
                </button>
            </td>
        </tr>
    `).join('');
}

// Load Activity Feed
async function loadActivity() {
    try {
        const response = await fetch('/api/admin/activity/recent', {
            headers: {
                'x-session-token': sessionToken
            }
        });

        if (response.ok) {
            const data = await response.json();
            updateActivityFeeds(data.activities);
        }
    } catch (error) {
        console.error('Error loading activity:', error);
        // Show mock data if API fails
        updateActivityFeeds(generateMockActivity());
    }
}

// Generate mock activity data
function generateMockActivity() {
    const activities = {
        loads: [],
        clicks: [],
        apiCalls: []
    };

    state.sessions.forEach(session => {
        if (session.totalMetrics?.loads > 0) {
            activities.loads.push({
                client: session.displayName,
                action: session.isIframe ? 'Loaded widget (iFrame)' : 'Loaded widget',
                time: formatRelativeTime(session.lastSeen)
            });
        }

        if (session.totalMetrics?.clicks > 0) {
            activities.clicks.push({
                client: session.displayName,
                action: 'Clicked on job listing',
                time: formatRelativeTime(session.lastSeen)
            });
        }

        if (session.totalMetrics?.apiCalls > 0) {
            activities.apiCalls.push({
                client: session.displayName,
                action: 'API call',
                time: formatRelativeTime(session.lastSeen)
            });
        }
    });

    return activities;
}

// Update activity feeds
function updateActivityFeeds(activities) {
    // Page loads
    const loadsFeed = document.getElementById('loadsFeed');
    if (activities.loads && activities.loads.length > 0) {
        loadsFeed.innerHTML = activities.loads.slice(0, 10).map(item => `
            <div class="activity-item">
                <div class="activity-icon load">📄</div>
                <div class="activity-content">
                    <div class="activity-title">${item.client}</div>
                    <div class="activity-description">${item.action}</div>
                </div>
                <div class="activity-time">${item.time}</div>
            </div>
        `).join('');
    } else {
        loadsFeed.innerHTML = '<div class="empty-state">No recent page loads</div>';
    }

    // Clicks
    const clicksFeed = document.getElementById('clicksFeed');
    if (activities.clicks && activities.clicks.length > 0) {
        clicksFeed.innerHTML = activities.clicks.slice(0, 10).map(item => `
            <div class="activity-item">
                <div class="activity-icon click">👆</div>
                <div class="activity-content">
                    <div class="activity-title">${item.client}</div>
                    <div class="activity-description">${item.action}</div>
                </div>
                <div class="activity-time">${item.time}</div>
            </div>
        `).join('');
    } else {
        clicksFeed.innerHTML = '<div class="empty-state">No recent clicks</div>';
    }

    // API calls
    const apiFeed = document.getElementById('apiFeed');
    if (activities.apiCalls && activities.apiCalls.length > 0) {
        apiFeed.innerHTML = activities.apiCalls.slice(0, 10).map(item => `
            <div class="activity-item">
                <div class="activity-icon api">🔌</div>
                <div class="activity-content">
                    <div class="activity-title">${item.client}</div>
                    <div class="activity-description">${item.action}</div>
                </div>
                <div class="activity-time">${item.time}</div>
            </div>
        `).join('');
    } else {
        apiFeed.innerHTML = '<div class="empty-state">No recent API calls</div>';
    }
}

// Format relative time helper
function formatRelativeTime(date) {
    const now = new Date();
    const then = new Date(date);
    const diff = now - then;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);

    if (days > 0) return `${days}d ago`;
    if (hours > 0) return `${hours}h ago`;
    if (minutes > 0) return `${minutes}m ago`;
    return 'Just now';
}

// Load Revenue Calculator
function loadRevenueCalculator() {
    const select = document.getElementById('revenueClient');
    if (!select) return;

    select.innerHTML = '<option value="">All Clients</option>' +
        state.clients.map(client =>
            `<option value="${client.clientId}">${client.name}</option>`
        ).join('');
}

// Calculate Revenue
function calculateRevenue() {
    const clientId = document.getElementById('revenueClient').value;
    const period = document.getElementById('revenuePeriod').value;
    const costPerView = parseFloat(document.getElementById('costPerView').value);
    const costPerClick = parseFloat(document.getElementById('costPerClick').value);
    const costPerSession = parseFloat(document.getElementById('costPerSession').value);

    let sessions = state.sessions;
    if (clientId) {
        const client = state.clients.find(c => c.clientId === clientId);
        sessions = client ? client.sessions : [];
    }

    // Filter by period
    const now = new Date();
    let startDate = new Date();

    switch(period) {
        case 'today':
            startDate.setHours(0, 0, 0, 0);
            break;
        case 'week':
            startDate.setDate(now.getDate() - 7);
            break;
        case 'month':
            startDate.setMonth(now.getMonth() - 1);
            break;
        case 'quarter':
            startDate.setMonth(now.getMonth() - 3);
            break;
        case 'year':
            startDate.setFullYear(now.getFullYear() - 1);
            break;
    }

    const filteredSessions = sessions.filter(s =>
        new Date(s.firstSeen) >= startDate
    );

    // Calculate totals
    let totalViews = 0, totalClicks = 0;
    filteredSessions.forEach(session => {
        totalViews += session.totalMetrics?.loads || 0;
        totalClicks += session.totalMetrics?.clicks || 0;
    });

    const totalRevenue = (totalViews * costPerView) +
            (totalClicks * costPerClick) +
            (filteredSessions.length * costPerSession);

    // Display results
    document.getElementById('totalRevenue').textContent = `£${totalRevenue.toFixed(2)}`;
    document.getElementById('revenuePeriodText').textContent = document.getElementById('revenuePeriod').selectedOptions[0].text;
    document.getElementById('viewsCount').textContent = totalViews.toLocaleString();
    document.getElementById('clicksCount').textContent = totalClicks.toLocaleString();
    document.getElementById('sessionsCount').textContent = filteredSessions.length.toLocaleString();

    document.getElementById('revenueResult').style.display = 'block';
}

// Additional helper functions
function refreshSessions() {
    loadDashboard();
    showToast('Sessions refreshed', 'success');
}

function copyApiKey(apiKey) {
    navigator.clipboard.writeText(apiKey).then(() => {
        showToast('API key copied to clipboard', 'success');
    }).catch(() => {
        showToast('Failed to copy API key', 'error');
    });
}

async function revokeApiKey(clientId) {
    if (!confirm('Are you sure you want to revoke this API key?')) return;

    try {
        const response = await fetch(`/api/admin/apikey/${clientId}`, {
            method: 'DELETE',
            headers: {
                'x-session-token': sessionToken
            }
        });

        if (response.ok) {
            showToast('API key revoked', 'success');
            loadAPIKeys();
        } else {
            throw new Error('Failed to revoke API key');
        }
    } catch (error) {
        showToast('Error revoking API key', 'error');
    }
}

function showGenerateKeyModal() {
    // Simple prompt for now - can be replaced with proper modal
    const clientName = prompt('Enter client name:');
    const clientId = prompt('Enter client ID:');

    if (clientName && clientId) {
        generateAPIKey(clientId, clientName);
    }
}

async function generateAPIKey(clientId, clientName) {
    try {
        const response = await fetch('/api/admin/generate-api-key', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-session-token': sessionToken
            },
            body: JSON.stringify({ clientId, clientName })
        });

        if (response.ok) {
            const data = await response.json();
            showToast('API key generated successfully', 'success');
            loadDashboard();

            // Copy to clipboard
            navigator.clipboard.writeText(data.apiKey);
            showToast('API key copied to clipboard', 'success');
        } else {
            throw new Error('Failed to generate API key');
        }
    } catch (error) {
        showToast('Error generating API key', 'error');
    }
}

    async function exportAllData() {
    try {
        const response = await fetch('/api/admin/export', {
            headers: {
                'x-session-token': sessionToken
            }
    });

       if (response.ok) {
           const blob = await response.blob();
           const url = window.URL.createObjectURL(blob);
           const a = document.createElement('a');
           a.href = url;
           a.download = `bmj-careers-export-${new Date().toISOString().split('T')[0]}.json`;
           document.body.appendChild(a);
           a.click();
           window.URL.revokeObjectURL(url);
           document.body.removeChild(a);

           showToast('Data exported successfully', 'success');
       } else {
           throw new Error('Export failed');
       }
   } catch (error) {
       showToast('Failed to export data', 'error');
   }
}

// Update the saveSettings function
function saveSettings() {
   state.settings = {
       trackLocalhost: document.getElementById('trackLocalhost').checked,
       trackInternalIPs: document.getElementById('trackInternalIPs').checked,
       sessionTimeout: parseInt(document.getElementById('sessionTimeout').value),
       enableNotifications: document.getElementById('enableNotifications').checked,
       alertThreshold: parseInt(document.getElementById('alertThreshold').value),
       dataRetention: parseInt(document.getElementById('dataRetention').value)
   };

   localStorage.setItem('adminSettings', JSON.stringify(state.settings));
   showToast('Settings saved', 'success');
   loadDashboard();
}

// Load settings into UI
// In the loadSettingsUI function
function loadSettingsUI() {
    if (document.getElementById('trackLocalhost')) {
        // Default to false for localhost tracking
        document.getElementById('trackLocalhost').checked = state.settings.trackLocalhost !== undefined ? state.settings.trackLocalhost : false;
        document.getElementById('trackInternalIPs').checked = state.settings.trackInternalIPs;
        document.getElementById('sessionTimeout').value = state.settings.sessionTimeout;
        document.getElementById('enableNotifications').checked = state.settings.enableNotifications;
        document.getElementById('alertThreshold').value = state.settings.alertThreshold;
        document.getElementById('dataRetention').value = state.settings.dataRetention;
    }
}

// Update charts function enhancement
function updateAllCharts() {
   // Call existing updateCharts
   updateCharts();

   // Update session distribution
   if (state.charts.sessionDist) {
       const distribution = calculateSessionDistribution();
       state.charts.sessionDist.data.datasets[0].data = [
           distribution.direct,
           distribution.iframe,
           distribution.api
       ];
       state.charts.sessionDist.update();
   }

   // Update revenue chart
   if (state.charts.revenue) {
       const topClients = state.clients
           .sort((a, b) => b.totalMetrics.revenue - a.totalMetrics.revenue)
           .slice(0, 5);

       state.charts.revenue.data.labels = topClients.map(c => c.name);
       state.charts.revenue.data.datasets[0].data = topClients.map(c => c.totalMetrics.revenue);
       state.charts.revenue.update();
   }

   // Update geographic distribution
   if (state.charts.geo) {
       const geoData = calculateGeographicDistribution();
       state.charts.geo.data.labels = Object.keys(geoData);
       state.charts.geo.data.datasets[0].data = Object.values(geoData);
       state.charts.geo.update();
   }
}

// Calculate session distribution
function calculateSessionDistribution() {
   const distribution = { direct: 0, iframe: 0, api: 0 };

   state.sessions.forEach(session => {
       if (session.utm_medium === 'iframe' || session.isIframe) {
           distribution.iframe++;
       } else if (session.utm_medium === 'api') {
           distribution.api++;
       } else {
           distribution.direct++;
       }
   });

   return distribution;
}

// Calculate geographic distribution
function calculateGeographicDistribution() {
   const geo = {};

   state.sessions.forEach(session => {
       // Extract location from domain or use default
       let location = 'Unknown';

       if (session.domain) {
           if (session.domain.includes('.uk')) location = 'United Kingdom';
           else if (session.domain.includes('.com')) location = 'United States';
           else if (session.domain.includes('.ca')) location = 'Canada';
           else if (session.domain.includes('.au')) location = 'Australia';
           else if (session.domain.includes('.in')) location = 'India';
           else location = 'Other';
       }

       geo[location] = (geo[location] || 0) + 1;
   });

   return geo;
}

// Update usage chart function
function updateUsageChart(period) {
   // Update button states
   event.target.parentElement.querySelectorAll('.btn').forEach(btn => {
       btn.classList.remove('active');
   });
   event.target.classList.add('active');

   // Update chart based on period
   let days;
   switch(period) {
       case '7d':
           days = getLastNDays(7);
           break;
       case '30d':
           days = getLastNDays(30);
           break;
       case '90d':
           days = getLastNDays(90);
           break;
   }

   const usageData = calculateUsageData(days);
   state.charts.usage.data.labels = days.map(d => formatDate(d));
   state.charts.usage.data.datasets[0].data = usageData.views;
   state.charts.usage.data.datasets[1].data = usageData.clicks;
   state.charts.usage.data.datasets[2].data = usageData.sessions;
   state.charts.usage.update();
}

    // Modal functions
function showGenerateKeyModal() {
    document.getElementById('generateKeyModal').classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

function submitGenerateKey() {
    const clientName = document.getElementById('apiClientName').value;
    const clientId = document.getElementById('apiClientId').value;

    if (clientName && clientId) {
        generateAPIKey(clientId, clientName);
        closeModal('generateKeyModal');
        document.getElementById('generateKeyForm').reset();
    }
}

// Enhanced view client details
function viewClientDetails(clientId) {
    const client = state.clients.find(c => c.clientId === clientId);
    if (!client) return;

    const modal = document.getElementById('clientDetailsModal');
    document.getElementById('clientModalTitle').textContent = client.name;

    const sessionsHtml = client.sessions.map(session => `
        <div style="padding: 1rem; background: var(--light); border-radius: 8px; margin-bottom: 0.75rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <strong>Session ${session.sessionId || 'N/A'}</strong>
                <span class="session-badge ${session.isActive ? 'active' : 'ended'}">
                    ${session.isActive ? 'Active' : 'Ended'}
                </span>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 0.75rem;">
                <div>
                    <div style="font-size: 0.75rem; color: var(--gray);">Duration</div>
                    <div style="font-weight: 600;">${session.duration}</div>
                </div>
                <div>
                    <div style="font-size: 0.75rem; color: var(--gray);">Page Views</div>
                    <div style="font-weight: 600;">${session.totalMetrics?.loads || 0}</div>
                </div>
                <div>
                    <div style="font-size: 0.75rem; color: var(--gray);">Clicks</div>
                    <div style="font-weight: 600;">${session.totalMetrics?.clicks || 0}</div>
                </div>
                <div>
                    <div style="font-size: 0.75rem; color: var(--gray);">Revenue</div>
                    <div style="font-weight: 600;">£${session.revenue.toFixed(2)}</div>
                </div>
            </div>
        </div>
    `).join('');

    document.getElementById('clientModalContent').innerHTML = `
        <div class="client-detail-grid">
            <div>
                <h3 style="margin-bottom: 1rem;">Client Information</h3>
                <div class="info-row">
                    <div class="info-label">Client ID</div>
                    <div class="info-value">${client.clientId}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Domain</div>
                    <div class="info-value">${client.domain}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Type</div>
                    <div class="info-value">${client.isIframe ? 'iFrame Embed' : 'Direct Access'}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Total Sessions</div>
                    <div class="info-value">${client.sessions.length}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Active Sessions</div>
                    <div class="info-value">${client.sessions.filter(s => s.isActive).length}</div>
                </div>

                <h3 style="margin: 2rem 0 1rem;">Sessions</h3>
                ${sessionsHtml || '<div class="empty-state">No sessions found</div>'}
            </div>
            <div>
                <h3 style="margin-bottom: 1rem;">Metrics Summary</h3>
                <div class="stat-card">
                    <div class="stat-value">${client.totalMetrics.loads.toLocaleString()}</div>
                    <div class="stat-label">Total Page Views</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${client.totalMetrics.clicks.toLocaleString()}</div>
                    <div class="stat-label">Total Clicks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">£${client.totalMetrics.revenue.toFixed(2)}</div>
                    <div class="stat-label">Total Revenue</div>
                </div>
            </div>
        </div>
    `;

    modal.classList.add('active');
}

// Complete Enhanced Analytics Functions - Replace all existing enhanced analytics functions with these

let enhancedAnalyticsData = null;

// Load enhanced analytics data
async function loadEnhancedAnalytics() {
    console.log('Loading enhanced analytics...');

    try {
        // First attempt to load from API
        const response = await fetch('/api/admin/dashboard/enhanced', {
            headers: {
                'x-session-token': sessionToken
            }
        });

        if (response.ok) {
            const data = await response.json();
            if (data.data && data.data.clients && data.data.clients.length > 0) {
                enhancedAnalyticsData = data.data;
                updateEnhancedAnalyticsDashboard(data.data);
                showToast('Enhanced analytics loaded', 'success');
            } else {
                // No data from API, generate mock
                generateMockEnhancedData();
            }
        } else {
            // API failed, generate mock data
            generateMockEnhancedData();
        }

    } catch (error) {
        console.error('Enhanced analytics error:', error);
        // Generate mock data as fallback
        generateMockEnhancedData();
    }
}

// Generate mock enhanced data
function generateMockEnhancedData() {
    console.log('Generating mock enhanced analytics data...');

    // Create sample clients if none exist
    const sampleClients = state.clients && state.clients.length > 0 ? state.clients : [
        { clientId: 'nhs-trust-1', name: 'NHS Trust London', domain: 'nhs.uk' },
        { clientId: 'private-hospital-1', name: 'Private Hospital Group', domain: 'privatehospital.com' },
        { clientId: 'recruitment-agency-1', name: 'Medical Recruitment Ltd', domain: 'medicalrecruitment.co.uk' },
        { clientId: 'health-board-1', name: 'Health Board Wales', domain: 'wales.nhs.uk' },
        { clientId: 'gp-practice-1', name: 'GP Practice Network', domain: 'gppractice.nhs.uk' }
    ];

    // Create enhanced data
    const enhancedClients = sampleClients.map((client, index) => ({
        clientId: client.clientId,
        sessionId: 'session_' + Math.random().toString(36).substr(2, 9),
        name: client.name,
        domain: client.domain,
        engagementScore: Math.floor(Math.random() * 30) + 70,
        maxScrollDepth: Math.floor(Math.random() * 30) + 70,
        searches: [
            { term: 'cardiology consultant', timestamp: new Date().toISOString() },
            { term: 'london jobs', timestamp: new Date().toISOString() },
            { term: 'pediatric nurse', timestamp: new Date().toISOString() }
        ].slice(0, Math.floor(Math.random() * 3) + 1),
        interactionRate: Math.floor(Math.random() * 20) + 30,
        conversionRate: Math.floor(Math.random() * 10) + 5,
        sessionDuration: Math.floor(Math.random() * 25) + 10,
        firstSeen: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString(),
        lastSeen: new Date().toISOString(),
        filterUsage: {
            location: Math.floor(Math.random() * 15) + 5,
            specialty: Math.floor(Math.random() * 10) + 3,
            salary_range: Math.floor(Math.random() * 8) + 2,
            contract_type: Math.floor(Math.random() * 6) + 1
        },
        userInfo: index % 2 === 0 ? {
            userId: 'user_' + Math.random().toString(36).substr(2, 9),
            userEmail: `user${index}@${client.domain}`,
            userDepartment: ['HR', 'Recruitment', 'Medical Staff', 'Admin'][index % 4]
        } : null,
        deviceInfo: {
            screenResolution: ['1920x1080', '1366x768', '2560x1440', '1440x900'][index % 4],
            viewportSize: ['1920x947', '1366x625', '2560x1297', '1440x757'][index % 4],
            language: 'en-GB',
            deviceType: ['desktop', 'mobile', 'tablet'][index % 3]
        }
    }));

    const mockData = {
        clients: enhancedClients,
        aggregateStats: {
            averageEngagement: 82,
            averageScrollDepth: 75,
            totalSearches: enhancedClients.reduce((sum, c) => sum + c.searches.length, 0),
            averageInteractionRate: 45,
            popularFilters: [
                { filter: 'Location', count: 342 },
                { filter: 'Specialty', count: 289 },
                { filter: 'Salary Range', count: 234 },
                { filter: 'Contract Type', count: 198 },
                { filter: 'Experience Level', count: 156 },
                { filter: 'Working Hours', count: 134 },
                { filter: 'Benefits', count: 98 },
                { filter: 'Start Date', count: 76 }
            ],
            popularSearchTerms: [
                { term: 'cardiology', count: 156 },
                { term: 'consultant', count: 134 },
                { term: 'london', count: 121 },
                { term: 'nurse', count: 98 },
                { term: 'GP', count: 87 },
                { term: 'surgery', count: 76 },
                { term: 'pediatrics', count: 65 },
                { term: 'emergency', count: 54 },
                { term: 'mental health', count: 43 },
                { term: 'locum', count: 32 }
            ],
            deviceBreakdown: {
                desktop: 65,
                mobile: 25,
                tablet: 8,
                unknown: 2
            },
            hourlyActivity: generateHourlyActivity()
        }
    };

    enhancedAnalyticsData = mockData;
    updateEnhancedAnalyticsDashboard(mockData);
    showToast('Enhanced analytics loaded (sample data)', 'info');
}

// Generate hourly activity data
function generateHourlyActivity() {
    const hourly = {};
    for (let hour = 0; hour < 24; hour++) {
        const isPeakHour = hour >= 9 && hour <= 17;
        const baseActivity = isPeakHour ? 80 : 20;
        hourly[hour] = {
            loads: Math.floor(Math.random() * baseActivity) + 20,
            clicks: Math.floor(Math.random() * (baseActivity / 2)) + 10,
            sessions: Math.floor(Math.random() * 15) + 5
        };
    }
    return hourly;
}

// Update enhanced analytics dashboard
function updateEnhancedAnalyticsDashboard(data) {
    console.log('Updating enhanced analytics dashboard with data:', data);

    // Update summary stats
    document.getElementById('avgEngagementScore').textContent =
        Math.round(data.aggregateStats.averageEngagement || 0);
    document.getElementById('avgScrollDepth').textContent =
        Math.round(data.aggregateStats.averageScrollDepth || 0) + '%';
    document.getElementById('totalSearches').textContent =
        data.aggregateStats.totalSearches || 0;
    document.getElementById('avgInteractionRate').textContent =
        Math.round(data.aggregateStats.averageInteractionRate || 45) + '%';

    // Update clients table
    updateEnhancedClientsTable(data.clients);

    // Update popular filters
    updatePopularFilters(data.aggregateStats.popularFilters);

    // Update popular searches
    updatePopularSearches(data.aggregateStats.popularSearchTerms);

    // Update device chart
    updateDeviceChart(data.aggregateStats.deviceBreakdown);

    // Update activity heatmap
    updateActivityHeatmap(data.aggregateStats.hourlyActivity);
}

// Update enhanced clients table
function updateEnhancedClientsTable(clients) {
    const tbody = document.getElementById('enhancedClientsTable');

    if (!clients || clients.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No client data available</td></tr>';
        return;
    }

    tbody.innerHTML = clients.map(client => `
        <tr>
            <td>
                <div style="font-weight: 600; color: var(--dark);">${client.name}</div>
                <div style="font-size: 0.75rem; color: var(--gray);">${client.domain || 'Unknown'}</div>
            </td>
            <td>
                <code style="font-size: 0.75rem; background: var(--light); padding: 0.25rem 0.5rem; border-radius: 4px;">
                    ${client.sessionId.substring(0, 8)}...
                </code>
            </td>
            <td>
                <span style="font-size: 1.25rem; font-weight: 700; color: var(--primary);">
                    ${client.engagementScore}
                </span>
            </td>
            <td>${client.maxScrollDepth}%</td>
            <td>${client.searches?.length || 0}</td>
            <td>${client.interactionRate}%</td>
            <td>
                <span class="${client.conversionRate > 10 ? 'stat-change positive' : 'stat-change'}"
                      style="display: inline-block; padding: 0.25rem 0.5rem; border-radius: 12px;">
                    ${client.conversionRate}%
                </span>
            </td>
            <td>${client.sessionDuration} min</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="viewEnhancedClientDetails('${client.clientId}')">
                    Details
                </button>
            </td>
        </tr>
    `).join('');
}

// Update popular filters
function updatePopularFilters(filters) {
    const container = document.getElementById('popularFilters');

    if (!filters || filters.length === 0) {
        container.innerHTML = '<div class="empty-state">No filter data available</div>';
        return;
    }

    container.innerHTML = filters.slice(0, 10).map((filter, index) => `
        <div class="usage-metric" style="padding: 0.75rem 0; border-bottom: 1px solid #e2e8f0;">
            <span class="metric-label" style="color: var(--dark); font-weight: 500;">
                ${index + 1}. ${filter.filter}
            </span>
            <span class="metric-value" style="color: var(--primary); font-weight: 600;">
                ${filter.count} uses
            </span>
        </div>
    `).join('');
}

// Update popular searches
function updatePopularSearches(searches) {
    const container = document.getElementById('popularSearches');

    if (!searches || searches.length === 0) {
        container.innerHTML = '<div class="empty-state">No search data available</div>';
        return;
    }

    container.innerHTML = searches.slice(0, 10).map((search, index) => `
        <div class="usage-metric" style="padding: 0.75rem 0; border-bottom: 1px solid #e2e8f0;">
            <span class="metric-label" style="color: var(--dark); font-weight: 500;">
                ${index + 1}. ${search.term}
            </span>
            <span class="metric-value" style="color: var(--primary); font-weight: 600;">
                ${search.count} searches
            </span>
        </div>
    `).join('');
}

// Update device chart
function updateDeviceChart(deviceData) {
    const ctx = document.getElementById('deviceChart');
    if (!ctx) return;

    // Destroy existing chart if it exists
    if (state.charts.device) {
        state.charts.device.destroy();
    }

    state.charts.device = new Chart(ctx.getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['Desktop', 'Mobile', 'Tablet', 'Unknown'],
            datasets: [{
                data: [
                    deviceData?.desktop || 65,
                    deviceData?.mobile || 25,
                    deviceData?.tablet || 8,
                    deviceData?.unknown || 2
                ],
                backgroundColor: ['#0066cc', '#48bb78', '#FFC000', '#718096'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed + '%';
                        }
                    }
                }
            }
        }
    });
}

// Update activity heatmap
function updateActivityHeatmap(hourlyData) {
    const container = document.getElementById('activityHeatmap');

    if (!hourlyData) {
        hourlyData = generateHourlyActivity();
    }

    // Find max activity for scaling
    let maxActivity = 0;
    Object.values(hourlyData).forEach(data => {
        const total = (data.loads || 0) + (data.clicks || 0);
        maxActivity = Math.max(maxActivity, total);
    });

    // Generate 24 hour cells
    let html = '';
    for (let hour = 0; hour < 24; hour++) {
        const data = hourlyData[hour] || { loads: 0, clicks: 0, sessions: 0 };
        const activity = data.loads + data.clicks;
        const intensity = maxActivity > 0 ? (activity / maxActivity) : 0;

        let className = 'heatmap-cell';
        if (intensity > 0.75) className += ' peak';
        else if (intensity > 0.5) className += ' high';
        else if (intensity > 0.25) className += ' medium';
        else if (intensity > 0) className += ' low';

        const hourLabel = hour.toString().padStart(2, '0') + ':00';

        html += `
            <div class="${className}" style="position: relative; cursor: pointer;">
                <div class="heatmap-tooltip" style="position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
                     background: var(--dark); color: white; padding: 0.5rem; border-radius: 4px;
                     font-size: 0.75rem; white-space: nowrap; opacity: 0; pointer-events: none;
                     transition: opacity 0.2s; z-index: 1000;">
                    ${hourLabel}<br>
                    Loads: ${data.loads}<br>
                    Clicks: ${data.clicks}<br>
                    Sessions: ${data.sessions}
                </div>
            </div>
        `;
    }

    container.innerHTML = html;

    // Add hover effects
    container.querySelectorAll('.heatmap-cell').forEach(cell => {
        cell.addEventListener('mouseenter', function() {
            const tooltip = this.querySelector('.heatmap-tooltip');
            if (tooltip) tooltip.style.opacity = '1';
        });
        cell.addEventListener('mouseleave', function() {
            const tooltip = this.querySelector('.heatmap-tooltip');
            if (tooltip) tooltip.style.opacity = '0';
        });
    });
}

// View enhanced client details
function viewEnhancedClientDetails(clientId) {
    const client = enhancedAnalyticsData?.clients.find(c => c.clientId === clientId);
    if (!client) {
        showToast('Client details not found', 'error');
        return;
    }

    const modal = document.getElementById('enhancedClientModal');
    document.getElementById('enhancedClientModalTitle').textContent = `Analytics: ${client.name}`;

    const content = `
        <div class="client-detail-grid">
            <div>
                <h3 style="margin-bottom: 1rem; color: var(--dark);">Session Information</h3>
                <div class="info-row">
                    <div class="info-label">Session ID</div>
                    <div class="info-value"><code>${client.sessionId}</code></div>
                </div>
                <div class="info-row">
                    <div class="info-label">Client ID</div>
                    <div class="info-value">${client.clientId}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Domain</div>
                    <div class="info-value">${client.domain || 'Unknown'}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">First Seen</div>
                    <div class="info-value">${new Date(client.firstSeen).toLocaleString()}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Last Seen</div>
                    <div class="info-value">${new Date(client.lastSeen).toLocaleString()}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Session Duration</div>
                    <div class="info-value">${client.sessionDuration} minutes</div>
                </div>

                ${client.searches && client.searches.length > 0 ? `
                    <h3 style="margin: 2rem 0 1rem; color: var(--dark);">Search History</h3>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${client.searches.map(search => `
                            <div class="usage-metric">
                                <span class="metric-label">${search.term}</span>
                                <span class="metric-value">${new Date(search.timestamp).toLocaleTimeString()}</span>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>

            <div>
                <h3 style="margin-bottom: 1rem; color: var(--dark);">Engagement Metrics</h3>
                <div class="stat-card">
                    <div class="stat-value">${client.engagementScore}</div>
                    <div class="stat-label">Engagement Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${client.maxScrollDepth}%</div>
                    <div class="stat-label">Max Scroll Depth</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${client.interactionRate}%</div>
                    <div class="stat-label">Interaction Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${client.conversionRate}%</div>
                    <div class="stat-label">Conversion Rate</div>
                </div>

                ${client.filterUsage && Object.keys(client.filterUsage).length > 0 ? `
                    <h3 style="margin: 2rem 0 1rem; color: var(--dark);">Filter Usage</h3>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${Object.entries(client.filterUsage).map(([filter, count]) => `
                            <div class="usage-metric">
                                <span class="metric-label">${filter.replace(/_/g, ' ')}</span>
                                <span class="metric-value">${count} times</span>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        </div>
    `;

    document.getElementById('enhancedClientModalContent').innerHTML = content;
    modal.classList.add('active');
}

// Search enhanced clients
function searchEnhancedClients(query) {
    if (!enhancedAnalyticsData || !enhancedAnalyticsData.clients) {
        return;
    }

    const filtered = query ?
        enhancedAnalyticsData.clients.filter(client =>
            client.name.toLowerCase().includes(query.toLowerCase()) ||
            client.domain?.toLowerCase().includes(query.toLowerCase()) ||
            client.sessionId?.toLowerCase().includes(query.toLowerCase())
        ) : enhancedAnalyticsData.clients;

    updateEnhancedClientsTable(filtered);
}

// Refresh enhanced analytics
function refreshEnhancedAnalytics() {
    showToast('Refreshing enhanced analytics...', 'info');
    loadEnhancedAnalytics();
}

// Export client data
async function exportClientData(clientId) {
    const client = enhancedAnalyticsData?.clients.find(c => c.clientId === clientId);
    if (!client) {
        showToast('Client not found', 'error');
        return;
    }

    try {
        const exportData = {
            client: client,
            exportDate: new Date().toISOString(),
            metrics: {
                engagement: client.engagementScore,
                scrollDepth: client.maxScrollDepth,
                interactionRate: client.interactionRate,
                conversionRate: client.conversionRate
            }
        };

        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${clientId}_analytics_${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        showToast('Client data exported successfully', 'success');
    } catch (error) {
        console.error('Export error:', error);
        showToast('Failed to export client data', 'error');
    }
}


    function showSection(sectionId) {
    // Update menu
    document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active');
    });

    // Find and activate the correct menu item
    const menuItems = document.querySelectorAll('.menu-item');
    menuItems.forEach(item => {
        if (item.textContent.toLowerCase().includes(sectionId.replace('-', ' ').toLowerCase()) ||
            (sectionId === 'enhanced-analytics' && item.textContent.includes('Enhanced Analytics')) ||
            (sectionId === 'dashboard' && item.textContent.includes('Dashboard')) ||
            (sectionId === 'jobsdata' && item.textContent.includes('Jobs Data'))) {
            item.classList.add('active');
        }
    });

    // Update sections
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
    }

    // Update page title
    const titles = {
        dashboard: 'Dashboard',
        sessions: 'Live Sessions',
        clients: 'Client Management',
        analytics: 'Analytics',
        'enhanced-analytics': 'Enhanced Analytics',
        revenue: 'Revenue Calculator',
        api: 'API Management',
        activity: 'Activity Feed',
        jobsdata: 'Jobs Data API',
        settings: 'Settings'
    };
    document.getElementById('pageTitle').textContent = titles[sectionId] || 'Dashboard';

    // Load section data
    switch(sectionId) {
        case 'sessions':
            loadSessions();
            break;
        case 'clients':
            loadClients();
            break;
        case 'api':
            loadAPIKeys();
            break;
        case 'activity':
            loadActivity();
            break;
        case 'revenue':
            loadRevenueCalculator();
            break;
        case 'jobsdata':
            initializeDynamicEndpoints();
            break;
        case 'enhanced-analytics':
            loadEnhancedAnalytics();
            break;
        case 'settings':
            checkSystemHealth();
            break;
    }
}

// Add menu item for Enhanced Analytics
function addEnhancedAnalyticsMenuItem() {
    const sidebar = document.querySelector('.sidebar-menu');
    if (!sidebar) return;

    // Check if already exists
    if (Array.from(sidebar.querySelectorAll('.menu-item')).some(item =>
        item.textContent.includes('Enhanced Analytics'))) {
        return;
    }

    // Find the regular Analytics menu item
    const analyticsMenu = Array.from(sidebar.querySelectorAll('.menu-item')).find(item =>
        item.textContent.includes('Analytics') && !item.textContent.includes('Enhanced')
    );

    if (analyticsMenu) {
        const enhancedMenuItem = document.createElement('button');
        enhancedMenuItem.className = 'menu-item';
        enhancedMenuItem.onclick = () => showSection('enhanced-analytics');
        enhancedMenuItem.innerHTML = `
            <span class="menu-icon">📊</span>
            <span>Enhanced Analytics</span>
        `;
        analyticsMenu.parentNode.insertBefore(enhancedMenuItem, analyticsMenu.nextSibling);
    }
}

// Fixed revoke API key function
async function revokeApiKey(clientId) {
    if (!confirm('Are you sure you want to revoke this API key?')) return;

    try {
        // Remove from local state
        state.apiKeys = state.apiKeys.filter(key => key.clientId !== clientId);

        // Update the display
        loadAPIKeys();

        // Send delete request to server
        const response = await fetch(`/api/admin/apikey/${clientId}`, {
            method: 'DELETE',
            headers: {
                'x-session-token': sessionToken
            }
        });

        if (response.ok) {
            showToast('API key revoked successfully', 'success');
        } else {
            // Even if server fails, we've removed it from UI
            showToast('API key removed locally', 'warning');
        }

        // Reload dashboard to sync
        loadDashboard();

    } catch (error) {
        console.error('Error revoking API key:', error);
        showToast('API key removed from view', 'info');
        // Still reload to ensure consistency
        loadDashboard();
    }
}

// Code example switcher
function showCodeExample(language) {
    // Update tab states
    document.querySelectorAll('.code-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');

    // Hide all examples
    document.querySelectorAll('.code-example').forEach(example => {
        example.style.display = 'none';
    });

    // Show selected example
    const selectedExample = document.getElementById(`code-${language}`);
    if (selectedExample) {
        selectedExample.style.display = 'block';
    }
}

// System health check function
async function checkSystemHealth() {
    try {
        const response = await fetch('/health', {
            headers: {
                'x-session-token': sessionToken
            }
        });

        if (!response.ok) {
            throw new Error('Health check failed');
        }

        const health = await response.json();

        // Update system status
        document.getElementById('systemStatus').textContent = health.status || 'Unknown';
        document.getElementById('systemStatus').style.color =
            health.status === 'OK' ? 'var(--secondary)' :
            health.status === 'PARTIAL' ? 'var(--warning)' : 'var(--danger)';

        // Update DynamoDB status
        const dbStatus = health.dynamoDB?.connected ? 'Connected' : 'Disconnected';
        document.getElementById('dynamoStatus').textContent = dbStatus;
        document.getElementById('dynamoStatus').style.color =
            health.dynamoDB?.connected ? 'var(--secondary)' : 'var(--danger)';

        // Update feed source
        document.getElementById('feedSource').textContent = health.cache?.source || 'Unknown';

        // Update cache age
        if (health.cache?.age_seconds) {
            const minutes = Math.floor(health.cache.age_seconds / 60);
            const hours = Math.floor(minutes / 60);
            if (hours > 0) {
                document.getElementById('cacheAge').textContent = `${hours}h ${minutes % 60}m`;
            } else {
                document.getElementById('cacheAge').textContent = `${minutes}m`;
            }
        } else {
            document.getElementById('cacheAge').textContent = 'No cache';
        }

        // Update detailed information
        document.getElementById('feedUrl').textContent = health.feedUrl || 'Not configured';
        document.getElementById('totalJobsCached').textContent = health.cache?.jobs_count || 0;
        document.getElementById('lastSyncTime').textContent = health.cache?.last_fetch ?
            new Date(health.cache.last_fetch).toLocaleString() : 'Never';

        // Calculate uptime
        if (health.uptime) {
            const uptimeHours = Math.floor(health.uptime / 3600);
            const uptimeMinutes = Math.floor((health.uptime % 3600) / 60);
            document.getElementById('serverUptime').textContent =
                `${uptimeHours}h ${uptimeMinutes}m`;
        }

        // Memory usage
        if (health.memory_usage) {
            const memoryMB = Math.round(health.memory_usage.heapUsed / 1024 / 1024);
            const totalMB = Math.round(health.memory_usage.heapTotal / 1024 / 1024);
            document.getElementById('memoryUsage').textContent =
                `${memoryMB}MB / ${totalMB}MB`;
        }

        showToast('System health checked', 'success');

    } catch (error) {
        console.error('System health check error:', error);

        // Update with error state
        document.getElementById('systemStatus').textContent = 'Error';
        document.getElementById('systemStatus').style.color = 'var(--danger)';
        document.getElementById('dynamoStatus').textContent = 'Unknown';
        document.getElementById('feedSource').textContent = 'Unknown';
        document.getElementById('cacheAge').textContent = 'Unknown';

        showToast('Failed to check system health', 'error');
    }
}

// Initialize enhanced analytics on page load
document.addEventListener('DOMContentLoaded', function() {
    // Add the enhanced analytics menu item
    setTimeout(addEnhancedAnalyticsMenuItem, 100);

    // Check system health on settings page load
    if (window.location.hash === '#settings') {
        checkSystemHealth();
    }
});

// Fix the Generate Key Modal functionality
function showGenerateKeyModal() {
    const modal = document.getElementById('generateKeyModal');
    if (modal) {
        modal.classList.add('active');
    } else {
        // Fallback to prompt if modal doesn't exist
        const clientName = prompt('Enter client name:');
        const clientId = prompt('Enter client ID:');

        if (clientName && clientId) {
            generateAPIKey(clientId, clientName);
        }
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
    }
}

function submitGenerateKey() {
    const clientName = document.getElementById('apiClientName').value;
    const clientId = document.getElementById('apiClientId').value;

    if (clientName && clientId) {
        generateAPIKey(clientId, clientName);
        closeModal('generateKeyModal');
        document.getElementById('generateKeyForm').reset();
    }
}

// Ensure generateAPIKey function works properly
async function generateAPIKey(clientId, clientName) {
    try {
        const response = await fetch('/api/admin/generate-api-key', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-session-token': sessionToken
            },
            body: JSON.stringify({ clientId, clientName })
        });

        if (response.ok) {
            const data = await response.json();

            // Add to local state
            state.apiKeys.push({
                clientId: clientId,
                clientName: clientName,
                apiKey: data.apiKey,
                fullKey: data.apiKey,
                createdAt: new Date().toISOString(),
                totalUsage: 0,
                lastUsed: null
            });

            // Refresh the display
            loadAPIKeys();

            // Copy to clipboard
            navigator.clipboard.writeText(data.apiKey).then(() => {
                showToast('API key generated and copied to clipboard', 'success');
            }).catch(() => {
                showToast('API key generated successfully', 'success');
            });

        } else {
            throw new Error('Failed to generate API key');
        }
    } catch (error) {
        console.error('Generate API key error:', error);
        showToast('Error generating API key', 'error');
    }
}

    // Client CPC rates storage
let clientCPCRates = JSON.parse(localStorage.getItem('clientCPCRates') || '{}');

// Load billing section
function loadBillingSection() {
    const select = document.getElementById('billingClient');
    if (!select) return;

    select.innerHTML = '<option value="">Select a client...</option>' +
        state.clients.map(client =>
            `<option value="${client.clientId}">${client.name} (${client.domain})</option>`
        ).join('');

    // Set default month to previous month
    const now = new Date();
    now.setMonth(now.getMonth() - 1);
    document.getElementById('billingMonth').value = now.toISOString().slice(0, 7);
}

// Load client billing settings
function loadClientBillingSettings() {
    const clientId = document.getElementById('billingClient').value;
    if (!clientId) {
        document.getElementById('clientBillingSettings').style.display = 'none';
        return;
    }

    document.getElementById('clientBillingSettings').style.display = 'block';

    // Load saved CPC rate or default
    const savedRate = clientCPCRates[clientId] || 0.50;
    document.getElementById('clientCPC').value = savedRate;
}

// Save client CPC rate
function saveClientCPC() {
    const clientId = document.getElementById('billingClient').value;
    const cpc = parseFloat(document.getElementById('clientCPC').value);

    if (clientId && cpc > 0) {
        clientCPCRates[clientId] = cpc;
        localStorage.setItem('clientCPCRates', JSON.stringify(clientCPCRates));
        showToast('Cost per click rate saved', 'success');
    }
}

// Generate billing report
async function generateBillingReport() {
    const clientId = document.getElementById('billingClient').value;
    const billingMonth = document.getElementById('billingMonth').value;
    const cpc = parseFloat(document.getElementById('clientCPC').value || 0.50);

    if (!clientId) {
        showToast('Please select a client', 'warning');
        return;
    }

    if (!billingMonth) {
        showToast('Please select a billing month', 'warning');
        return;
    }

    try {
        // Get client data
        const client = state.clients.find(c => c.clientId === clientId);
        if (!client) {
            throw new Error('Client not found');
        }

        // Parse month
        const [year, month] = billingMonth.split('-').map(Number);
        const startDate = new Date(year, month - 1, 1);
        const endDate = new Date(year, month, 0, 23, 59, 59);

        // Filter clicks for the selected month
        // In production, this would come from the API
        const mockClicks = generateMockClickData(client, startDate, endDate);

        // Group clicks by job
        const jobClicks = {};
        mockClicks.forEach(click => {
            const jobKey = click.jobId;
            if (!jobClicks[jobKey]) {
                jobClicks[jobKey] = {
                    jobId: click.jobId,
                    jobTitle: click.jobTitle,
                    location: click.location,
                    clicks: 0,
                    dates: []
                };
            }
            jobClicks[jobKey].clicks++;
            jobClicks[jobKey].dates.push(click.date);
        });

        // Calculate totals
        const totalClicks = mockClicks.length;
        const totalCost = totalClicks * cpc;
        const uniqueJobs = Object.keys(jobClicks).length;

        // Update display
        document.getElementById('reportTitle').textContent =
            `Billing Report - ${client.name} - ${new Date(year, month - 1).toLocaleDateString('en-GB', { month: 'long', year: 'numeric' })}`;
        document.getElementById('totalOwed').textContent = `£${totalCost.toFixed(2)}`;
        document.getElementById('billingPeriodText').textContent = 'Total Amount Due';
        document.getElementById('totalClicks').textContent = totalClicks.toLocaleString();
        document.getElementById('cpcRate').textContent = `£${cpc.toFixed(2)}`;
        document.getElementById('uniqueJobs').textContent = uniqueJobs.toLocaleString();

        // Populate table
        const tbody = document.getElementById('billingDetailsTable');
        tbody.innerHTML = Object.values(jobClicks)
            .sort((a, b) => b.clicks - a.clicks)
            .map(job => `
                <tr>
                    <td>${job.dates[0].toLocaleDateString()}</td>
                    <td>${job.jobTitle}</td>
                    <td><code>${job.jobId}</code></td>
                    <td>${job.location}</td>
                    <td>${job.clicks}</td>
                    <td>£${(job.clicks * cpc).toFixed(2)}</td>
                </tr>
            `).join('');

        document.getElementById('footerTotalClicks').textContent = totalClicks;
        document.getElementById('footerTotalCost').textContent = `£${totalCost.toFixed(2)}`;

        document.getElementById('billingReport').style.display = 'block';

        // Store report data for export
        window.currentBillingReport = {
            client: client,
            month: billingMonth,
            clicks: mockClicks,
            jobClicks: jobClicks,
            totalClicks: totalClicks,
            totalCost: totalCost,
            cpc: cpc
        };

        showToast('Billing report generated', 'success');

    } catch (error) {
        console.error('Error generating billing report:', error);
        showToast('Failed to generate billing report', 'error');
    }
}

// Generate mock click data (replace with real API call)
function generateMockClickData(client, startDate, endDate) {
    const clicks = [];
    const jobs = [
        { id: 'JOB001', title: 'Consultant Cardiologist', location: 'London' },
        { id: 'JOB002', title: 'GP Partner', location: 'Manchester' },
        { id: 'JOB003', title: 'Registrar - Emergency Medicine', location: 'Birmingham' },
        { id: 'JOB004', title: 'Staff Nurse', location: 'Leeds' },
        { id: 'JOB005', title: 'Consultant Psychiatrist', location: 'Bristol' }
    ];

    // Generate random clicks
    const numClicks = Math.floor(Math.random() * 100) + 50;
    for (let i = 0; i < numClicks; i++) {
        const job = jobs[Math.floor(Math.random() * jobs.length)];
        const dayOffset = Math.floor(Math.random() * 30);
        const clickDate = new Date(startDate);
        clickDate.setDate(clickDate.getDate() + dayOffset);

        clicks.push({
            date: clickDate,
            jobId: job.id,
            jobTitle: job.title,
            location: job.location,
            clientId: client.clientId
        });
    }

    return clicks;
}

// Export billing report as PDF
async function exportBillingPDF() {
    if (!window.currentBillingReport) {
        showToast('No report to export', 'warning');
        return;
    }

    const report = window.currentBillingReport;

    // In production, you would use a library like jsPDF
    // For now, we'll create a printable version
    const printWindow = window.open('', '_blank');
    const html = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Billing Report - ${report.client.name}</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { color: #333; }
                .header { border-bottom: 2px solid #0066cc; padding-bottom: 10px; margin-bottom: 20px; }
                .summary { background: #f0f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
                table { width: 100%; border-collapse: collapse; }
                th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
                th { background: #f0f4f8; font-weight: bold; }
                .total { font-weight: bold; background: #f0f4f8; }
                .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>BMJ Careers Widget - Traffic Billing Report</h1>
                <p><strong>Client:</strong> ${report.client.name}</p>
                <p><strong>Period:</strong> ${new Date(report.month + '-01').toLocaleDateString('en-GB', { month: 'long', year: 'numeric' })}</p>
                <p><strong>Generated:</strong> ${new Date().toLocaleDateString('en-GB')}</p>
            </div>

            <div class="summary">
                <h2>Summary</h2>
                <p><strong>Total Clicks:</strong> ${report.totalClicks}</p>
                <p><strong>Cost Per Click:</strong> £${report.cpc.toFixed(2)}</p>
                <p><strong>Total Amount Due:</strong> £${report.totalCost.toFixed(2)}</p>
            </div>

            <h2>Click Details by Job</h2>
            <table>
                <thead>
                    <tr>
                        <th>Job ID</th>
                        <th>Job Title</th>
                        <th>Location</th>
                        <th>Clicks</th>
                        <th>Cost</th>
                    </tr>
                </thead>
                <tbody>
                    ${Object.values(report.jobClicks).map(job => `
                        <tr>
                            <td>${job.jobId}</td>
                            <td>${job.jobTitle}</td>
                            <td>${job.location}</td>
                            <td>${job.clicks}</td>
                            <td>£${(job.clicks * report.cpc).toFixed(2)}</td>
                        </tr>
                    `).join('')}
                </tbody>
                <tfoot>
                    <tr class="total">
                        <td colspan="3">Total</td>
                        <td>${report.totalClicks}</td>
                        <td>£${report.totalCost.toFixed(2)}</td>
                    </tr>
                </tfoot>
            </table>

            <div class="footer">
                <p>This report confirms ${report.totalClicks} clicks from the BMJ Careers widget installed on ${report.client.domain} during the specified period.</p>
                <p>Please invoice BMJ Careers for the total amount of £${report.totalCost.toFixed(2)}.</p>
            </div>
        </body>
        </html>
    `;

    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.print();

    showToast('PDF export opened in new window', 'success');
}

// Export billing report as CSV
function exportBillingCSV() {
    if (!window.currentBillingReport) {
        showToast('No report to export', 'warning');
        return;
    }

    const report = window.currentBillingReport;

    let csv = 'Job ID,Job Title,Location,Clicks,Cost\n';
    Object.values(report.jobClicks).forEach(job => {
        csv += `"${job.jobId}","${job.jobTitle}","${job.location}",${job.clicks},£${(job.clicks * report.cpc).toFixed(2)}\n`;
    });
    csv += `\nTotal,,,${report.totalClicks},£${report.totalCost.toFixed(2)}\n`;

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `billing_${report.client.name}_${report.month}.csv`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);

    showToast('CSV exported successfully', 'success');
}

    const monthlyOwed = state.sessions.reduce((sum, s) => {
    const clientCPC = clientCPCRates[s.clientIdentifier] || 0.50;
    return sum + ((s.totalMetrics?.clicks || 0) * clientCPC);
}, 0);
document.getElementById('monthlyOwed').textContent = `£${monthlyOwed.toFixed(2)}`;


    // Add this at the end of the script section
window.debugTracking = function() {
    console.log('=== TRACKING DEBUG ===');
    console.log('Total Clients:', state.clients.length);
    console.log('Total Sessions:', state.sessions.length);

    state.clients.forEach(client => {
        console.log(`Client: ${client.name} (${client.clientId})`);
        console.log(`  - Sessions: ${client.sessions.length}`);
        console.log(`  - Clicks: ${client.totalMetrics.clicks}`);
        console.log(`  - Loads: ${client.totalMetrics.loads}`);
    });

    if (state.sessions.length > 0) {
        console.log('\nSession Details:');
        state.sessions.forEach(session => {
            console.log(`  ${session.clientIdentifier}: ${session.totalMetrics.clicks} clicks`);
        });
    }
};

// Also add a manual refresh function
window.forceRefresh = async function() {
    console.log('Force refreshing dashboard...');
    await loadDashboard();
    console.log('Refresh complete');
    window.debugTracking();
};

    // Debug function to check aggregation
window.debugAggregation = function() {
    console.log('=== CLIENT AGGREGATION DEBUG ===');
    state.clients.forEach(client => {
        console.log(`\nClient: ${client.name} (${client.clientId})`);
        console.log(`  Domain: ${client.domain}`);
        console.log(`  Session Count: ${client.sessionCount || 1}`);
        console.log(`  Total Page Views: ${client.totalMetrics.loads}`);
        console.log(`  Total Clicks: ${client.totalMetrics.clicks}`);
        console.log(`  Total Revenue: £${client.totalMetrics.revenue.toFixed(2)}`);
        console.log(`  Is Test: ${client.isTestEnvironment ? 'Yes' : 'No'}`);
    });
};

    // Enhanced real-time updates
function startRealTimeUpdates() {
    // Update every 10 seconds for testing (change to 30 seconds in production)
    state.refreshInterval = setInterval(() => {
        if (state.settings.enableNotifications) {
            loadDashboard();
        }
    }, 10000); // 10 seconds for testing
}

</script>
<!-- Generate API Key Modal -->
<div class="modal" id="generateKeyModal">
    <div class="modal-content">
        <h2 style="margin-bottom: 1.5rem;">Generate API Key</h2>
        <form id="generateKeyForm" onsubmit="event.preventDefault(); submitGenerateKey();">
            <div class="form-group">
                <label class="form-label">Client Name</label>
                <input type="text" class="form-input" id="apiClientName" required>
            </div>
            <div class="form-group">
                <label class="form-label">Client ID</label>
                <input type="text" class="form-input" id="apiClientId" required>
                <div class="form-help">Use domain name or unique identifier</div>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button type="submit" class="btn btn-primary">Generate Key</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('generateKeyModal')">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Client Details Modal -->
<div class="modal" id="clientDetailsModal">
    <div class="modal-content" style="max-width: 800px;">
        <h2 id="clientModalTitle" style="margin-bottom: 1.5rem;">Client Details</h2>
        <div id="clientModalContent">
            <!-- Client details will be loaded here -->
        </div>
        <button class="btn btn-secondary" onclick="closeModal('clientDetailsModal')" style="margin-top: 1.5rem;">
            Close
        </button>
    </div>
</div>
</body>
</html>
