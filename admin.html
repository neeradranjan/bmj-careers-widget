<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console - BMJ Careers</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #f0f4f8 0%, #e9ecef 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            overflow-x: hidden;
        }

        /* Header Styles */
        .admin-header {
            background: linear-gradient(135deg, #2166ac 0%, #1a5490 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9375rem;
        }

        .user-email {
            font-size: 0.8125rem;
            opacity: 0.9;
        }

        /* Button Styles - Consistent across all sections */
        .btn, .action-btn, .save-settings-btn, .logout-btn, .filter-btn, .copy-btn, .regenerate-btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            outline: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before, .action-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .btn:hover::before, .action-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn.primary, .action-btn.primary, .save-settings-btn {
            background: linear-gradient(135deg, #2166ac 0%, #1a5490 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(33, 102, 172, 0.3);
        }

        .btn.primary:hover, .action-btn.primary:hover, .save-settings-btn:hover {
            box-shadow: 0 4px 12px rgba(33, 102, 172, 0.4);
            transform: translateY(-1px);
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 0.8125rem;
            padding: 0.5rem 1rem;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .copy-btn {
            background: #6b7280;
            color: white;
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            min-width: auto;
        }

        .copy-btn:hover {
            background: #4b5563;
        }

        .regenerate-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        .regenerate-btn:hover {
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
            transform: translateY(-1px);
        }

        /* Navigation */
        .admin-nav {
            background: white;
            padding: 0 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 76px;
            z-index: 100;
        }

        .nav-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            gap: 2rem;
            overflow-x: auto;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }

        .nav-content::-webkit-scrollbar {
            height: 6px;
        }

        .nav-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .nav-content::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .nav-item {
            padding: 1.25rem 0;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
            color: #6b7280;
            font-weight: 500;
            white-space: nowrap;
            position: relative;
        }

        .nav-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 3px;
            background: #2166ac;
            transition: width 0.3s ease;
        }

        .nav-item:hover {
            color: #2166ac;
        }

        .nav-item:hover::after {
            width: 100%;
        }

        .nav-item.active {
            color: #2166ac;
            border-bottom-color: #2166ac;
        }

        .nav-item.active::after {
            width: 100%;
        }

        /* Container */
        .admin-container {
            max-width: 1600px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Stat Cards */
        .stat-card {
            background: white;
            padding: 1.75rem;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(135deg, #2166ac 0%, #1a5490 100%);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
            letter-spacing: 0.025em;
        }

        .stat-value {
            font-size: 2.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, #2166ac 0%, #1a5490 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }

        .stat-change {
            font-size: 0.8125rem;
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-weight: 500;
        }

        .stat-change.positive {
            color: #10b981;
        }

        .stat-change.negative {
            color: #ef4444;
        }

        /* Chart Container - Fixed size */
        .chart-container {
            background: white;
            padding: 1.75rem;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            position: relative;
            height: 400px; /* Fixed height */
        }

        .chart-wrapper {
            position: relative;
            height: 320px; /* Fixed canvas container height */
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #1f2937;
            letter-spacing: -0.02em;
        }

        .chart-filters {
            display: flex;
            gap: 0.5rem;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            font-size: 0.8125rem;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #2166ac 0%, #1a5490 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 2px 8px rgba(33, 102, 172, 0.2);
        }

        /* Analytics Grid */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 1200px) {
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }

        .analytics-chart {
            background: white;
            padding: 1.75rem;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            height: 350px;
        }

        .analytics-chart .chart-wrapper {
            height: 280px;
        }

        /* Client Details Card */
        .client-details-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            padding: 1.75rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }

        .client-details-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .client-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
        }

        .client-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .metric-item {
            padding: 1.25rem;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 8px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .metric-item:hover {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
        }

        .metric-label {
            color: #64748b;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #2166ac;
        }

        /* Billing Section */
        .billing-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .billing-header {
            margin-bottom: 2rem;
        }

        .billing-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .billing-subtitle {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .billing-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
        }

        .form-input, .form-select {
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9375rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #2166ac;
            box-shadow: 0 0 0 4px rgba(33, 102, 172, 0.1);
        }

        .billing-result {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .billing-amount {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .billing-period {
            opacity: 0.95;
            font-size: 1.125rem;
        }

        .billing-breakdown {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255,255,255,0.2);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            text-align: center;
        }

        .breakdown-item {
            font-size: 0.875rem;
        }

        .breakdown-value {
            font-weight: 700;
            font-size: 1.125rem;
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 2px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .table-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
        }

        .table-actions {
            display: flex;
            gap: 0.75rem;
        }

        .table-content {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f9fafb;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #6b7280;
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid #e5e7eb;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.875rem;
        }

        tr:hover td {
            background: #f9fafb;
        }

        .client-name {
            font-weight: 600;
            color: #2166ac;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .client-name:hover {
            text-decoration: underline;
        }

        /* Badges */
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }

        .iframe-badge {
            background: #8b5cf6;
            color: white;
        }

        .metric-badge {
            margin-right: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .metric-badge.loads {
            background: #dbeafe;
            color: #1e40af;
        }

        .metric-badge.clicks {
            background: #fed7aa;
            color: #c2410c;
        }

        .revenue-badge {
            background: #d1fae5;
            color: #065f46;
            font-weight: 700;
        }

        /* Activity Feed */
        .activity-feed {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .feed-header {
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border-bottom: 2px solid #e5e7eb;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: #10b981;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .feed-content {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.2s ease;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .activity-item:hover {
            background: #f9fafb;
        }

        .activity-client {
            font-weight: 600;
            color: #2166ac;
            font-size: 0.875rem;
        }

        .activity-action {
            color: #6b7280;
            font-size: 0.8125rem;
            margin-top: 0.25rem;
        }

        .activity-time {
            color: #9ca3af;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        /* API Section */
        .api-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .api-endpoint {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.875rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
        }

        .code-example {
            background: #1f2937;
            color: #f3f4f6;
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.6;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .code-language {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            color: #9ca3af;
        }

        /* Settings */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .settings-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            padding: 2rem;
        }

        .settings-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1.5rem;
        }

        .setting-item {
            margin-bottom: 1.5rem;
        }

        .setting-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
        }

        .setting-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9375rem;
            transition: all 0.3s ease;
        }

        .setting-input:focus {
            outline: none;
            border-color: #2166ac;
            box-shadow: 0 0 0 4px rgba(33, 102, 172, 0.1);
        }

        .setting-description {
            margin-top: 0.375rem;
            font-size: 0.8125rem;
            color: #6b7280;
        }

        /* Health Status */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .status-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .status-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .status-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .status-icon.ok {
            background: #d1fae5;
            color: #10b981;
        }

        .status-icon.partial {
            background: #fed7aa;
            color: #f59e0b;
        }

        .status-icon.error {
            background: #fee2e2;
            color: #ef4444;
        }

        .status-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #1f2937;
        }

        .status-details {
            font-size: 0.875rem;
            color: #6b7280;
            line-height: 1.6;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: fadeInUp 0.3s ease-out;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        /* Section Display */
        .section {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #9ca3af;
            font-size: 0.875rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2166ac;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .billing-form {
                grid-template-columns: 1fr;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .nav-content {
                gap: 1rem;
            }

            .nav-item {
                padding: 1rem 0.5rem;
                font-size: 0.875rem;
            }

            .admin-container {
                padding: 0 1rem;
            }

            .billing-breakdown {
                grid-template-columns: 1fr;
            }
        }

        /* Quick Stats Animation */
        .quick-stat {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            margin-right: 0.75rem;
            animation: fadeInScale 0.3s ease-out;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Insights Panel */
        .insights-panel {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #fbbf24;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .insights-panel::before {
            content: '💡';
            position: absolute;
            top: -20px;
            right: -20px;
            font-size: 80px;
            opacity: 0.1;
        }

        .insights-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 0.75rem;
        }

        .insights-content {
            color: #92400e;
            font-size: 0.875rem;
            line-height: 1.6;
        }

        /* Currency Symbol Preview */
        .currency-preview {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.125rem;
            font-weight: 700;
            color: #2166ac;
            pointer-events: none;
        }

        .form-group.with-preview {
            position: relative;
        }

        .form-group.with-preview .form-input {
            padding-right: 3rem;
        }
    </style>
</head>
<body>
<div class="admin-header">
    <div class="header-content">
        <h1 class="header-title">BMJ Careers Admin Console</h1>
        <div class="header-user">
            <div class="user-info">
                <div class="user-name" id="userName">Loading...</div>
                <div class="user-email" id="userEmail">Loading...</div>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>
</div>

<nav class="admin-nav">
    <div class="nav-content">
        <div class="nav-item active" onclick="showSection('dashboard')">Dashboard</div>
        <div class="nav-item" onclick="showSection('analytics')">Analytics</div>
        <div class="nav-item" onclick="showSection('clients')">Clients</div>
        <div class="nav-item" onclick="showSection('billing')">Billing & Revenue</div>
        <div class="nav-item" onclick="showSection('jobs')">Jobs Data</div>
        <div class="nav-item" onclick="showSection('api-clients')">API Management</div>
        <div class="nav-item" onclick="showSection('activity')">Real-time Activity</div>
        <div class="nav-item" onclick="showSection('health')">System Health</div>
        <div class="nav-item" onclick="showSection('settings')">Settings</div>
    </div>
</nav>

<div class="admin-container">
    <!-- Dashboard Section -->
    <div id="dashboard" class="section active">
        <!-- Quick Insights Panel -->
        <div class="insights-panel" id="insightsPanel" style="display: none;">
            <h3 class="insights-title">Today's Insights</h3>
            <div class="insights-content" id="insightsContent">
                Loading insights...
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="stat-card">
                <div class="stat-label">Total Clients</div>
                <div class="stat-value" id="totalClients">0</div>
                <div class="stat-change positive">
                    <span>↑ 12%</span> from last month
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Active Today</div>
                <div class="stat-value" id="activeToday">0</div>
                <div class="stat-change positive">
                    <span>↑ 5%</span> from yesterday
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Revenue (This Month)</div>
                <div class="stat-value" id="monthlyRevenue">£0</div>
                <div class="stat-change positive">
                    <span>↑ 18%</span> from last month
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">API Calls Today</div>
                <div class="stat-value" id="apiCallsToday">0</div>
                <div class="stat-change negative">
                    <span>↓ 3%</span> from yesterday
                </div>
            </div>
        </div>

        <!-- Usage Chart -->
        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title">Usage Trends</h3>
                <div class="chart-filters">
                    <button class="filter-btn active" onclick="updateChart('7d')">7 Days</button>
                    <button class="filter-btn" onclick="updateChart('30d')">30 Days</button>
                    <button class="filter-btn" onclick="updateChart('90d')">90 Days</button>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="usageChart"></canvas>
            </div>
        </div>

        <!-- Top Clients -->
        <div class="table-container">
            <div class="table-header">
                <h2 class="table-title">Top Clients by Usage</h2>
                <div class="table-actions">
                    <button class="btn primary" onclick="exportClientData()">Export Data</button>
                </div>
            </div>
            <div class="table-content">
                <table>
                    <thead>
                    <tr>
                        <th>Client</th>
                        <th>Type</th>
                        <th>Today</th>
                        <th>This Week</th>
                        <th>This Month</th>
                        <th>Revenue</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="topClientsTable">
                    <tr>
                        <td colspan="7" class="loading">
                            <div class="spinner"></div>
                            <div>Loading client data...</div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Analytics Section -->
    <div id="analytics" class="section">
        <h2 style="margin-bottom: 1.5rem;">Detailed Analytics</h2>

        <div class="analytics-grid">
            <div class="analytics-chart">
                <h3 class="chart-title">Client Distribution</h3>
                <div class="chart-wrapper">
                    <canvas id="clientDistChart"></canvas>
                </div>
            </div>

            <div class="analytics-chart">
                <h3 class="chart-title">Revenue by Client Type</h3>
                <div class="chart-wrapper">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">Geographic Distribution</h3>
            <div class="chart-wrapper">
                <canvas id="geoChart"></canvas>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="dashboard-grid" style="margin-top: 2rem;">
            <div class="stat-card">
                <div class="stat-label">Average Response Time</div>
                <div class="stat-value">124ms</div>
                <div class="stat-change positive">
                    <span>↓ 15%</span> improvement
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Cache Hit Rate</div>
                <div class="stat-value">87%</div>
                <div class="stat-change positive">
                    <span>↑ 5%</span> from last week
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Error Rate</div>
                <div class="stat-value">0.02%</div>
                <div class="stat-change positive">
                    <span>↓ 0.01%</span> from last week
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Uptime</div>
                <div class="stat-value">99.98%</div>
                <div class="stat-change">
                    <span>→ 0%</span> stable
                </div>
            </div>
        </div>
    </div>

    <!-- Clients Section -->
    <div id="clients" class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2>Client Management</h2>
            <div>
                <input type="text" placeholder="Search clients..." class="form-input" style="width: 300px; display: inline-block;" onkeyup="searchClients(this.value)">
            </div>
        </div>

        <div id="clientsList">
            <!-- Client cards will be dynamically inserted here -->
        </div>
    </div>

    <!-- Billing Section -->
    <div id="billing" class="section">
        <h2 style="margin-bottom: 1.5rem;">Billing & Revenue Calculator</h2>

        <div class="billing-section">
            <div class="billing-header">
                <h3 class="billing-title">Calculate Client Charges</h3>
                <p class="billing-subtitle">Set pricing and calculate charges for any time period</p>
            </div>

            <div class="billing-form">
                <div class="form-group">
                    <label class="form-label">Select Client</label>
                    <select class="form-select" id="billingClient">
                        <option value="">Choose a client...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Currency</label>
                    <select class="form-select" id="billingCurrency" onchange="updateCurrencySymbol()">
                        <option value="GBP">British Pound (£)</option>
                        <option value="USD">US Dollar ($)</option>
                        <option value="EUR">Euro (€)</option>
                        <option value="INR">Indian Rupee (₹)</option>
                        <option value="JPY">Japanese Yen (¥)</option>
                        <option value="CNY">Chinese Yuan (¥)</option>
                        <option value="AUD">Australian Dollar ($)</option>
                        <option value="CAD">Canadian Dollar ($)</option>
                        <option value="CHF">Swiss Franc (Fr)</option>
                        <option value="SEK">Swedish Krona (kr)</option>
                        <option value="NZD">New Zealand Dollar ($)</option>
                        <option value="SGD">Singapore Dollar ($)</option>
                        <option value="HKD">Hong Kong Dollar ($)</option>
                        <option value="NOK">Norwegian Krone (kr)</option>
                        <option value="MXN">Mexican Peso ($)</option>
                    </select>
                </div>

                <div class="form-group with-preview">
                    <label class="form-label">Cost per Page Load</label>
                    <input type="number" class="form-input" id="costPerLoad" step="0.01" value="0.10" min="0">
                    <span class="currency-preview" id="currencyPreview1">£</span>
                </div>

                <div class="form-group with-preview">
                    <label class="form-label">Cost per Click</label>
                    <input type="number" class="form-input" id="costPerClick" step="0.01" value="0.50" min="0">
                    <span class="currency-preview" id="currencyPreview2">£</span>
                </div>

                <div class="form-group with-preview">
                    <label class="form-label">Cost per API Call</label>
                    <input type="number" class="form-input" id="costPerAPI" step="0.01" value="0.05" min="0">
                    <span class="currency-preview" id="currencyPreview3">£</span>
                </div>

                <div class="form-group">
                    <label class="form-label">Billing Period</label>
                    <select class="form-select" id="billingPeriod">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="quarter">This Quarter</option>
                        <option value="year">This Year</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
            </div>

            <button class="btn primary" onclick="calculateBilling()" style="width: 200px;">
                <span>Calculate Total</span>
            </button>

            <div class="billing-result" id="billingResult" style="display: none; margin-top: 2rem;">
                <div class="billing-amount" id="totalAmount">£0.00</div>
                <div class="billing-period" id="billingDetails">For the selected period</div>
                <div class="billing-breakdown">
                    <div class="breakdown-item">
                        <div>Page Loads</div>
                        <div class="breakdown-value" id="breakdownLoads">0</div>
                    </div>
                    <div class="breakdown-item">
                        <div>Clicks</div>
                        <div class="breakdown-value" id="breakdownClicks">0</div>
                    </div>
                    <div class="breakdown-item">
                        <div>API Calls</div>
                        <div class="breakdown-value" id="breakdownAPI">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Revenue Reports -->
        <div class="table-container" style="margin-top: 2rem;">
            <div class="table-header">
                <h3 class="table-title">Revenue Summary</h3>
                <div class="table-actions">
                    <button class="btn primary" onclick="generateInvoice()">Generate Invoice</button>
                </div>
            </div>
            <div class="table-content">
                <table>
                    <thead>
                    <tr>
                        <th>Client</th>
                        <th>This Month</th>
                        <th>Last Month</th>
                        <th>Total</th>
                        <th>Status</th>
                    </tr>
                    </thead>
                    <tbody id="revenueTable">
                    <tr>
                        <td colspan="5" class="empty-state">No revenue data yet</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Jobs Data Section -->
    <div id="jobs" class="section">
        <h2 style="margin-bottom: 1.5rem;">Jobs Data</h2>

        <!-- Public API Section -->
        <div class="api-section">
            <h3 style="margin-bottom: 1rem;">Public API Endpoint</h3>
            <p style="color: #6b7280; margin-bottom: 1rem;">Share this endpoint with clients who need direct JSON access</p>

            <div class="api-endpoint">
                <code id="publicApiUrl">/api/v1/jobs</code>
                <button class="copy-btn" onclick="copyToClipboard('publicApiUrl')">Copy</button>
            </div>

            <h4 style="margin: 1.5rem 0 1rem;">Required Headers:</h4>
            <div class="api-endpoint">
                <code>X-API-Key: YOUR_API_KEY</code>
                <button class="copy-btn" onclick="copyToClipboard('apiHeader')">Copy</button>
            </div>
        </div>

        <!-- Raw JSON Data -->
        <div class="api-section" style="margin-top: 2rem;">
            <h3 style="margin-bottom: 1rem;">Current Jobs Data (JSON)</h3>
            <div class="code-example" id="jobsData">
                <div class="loading">Loading jobs data...</div>
            </div>
        </div>
    </div>

    <!-- API Clients Section -->
    <div id="api-clients" class="section">
        <h2 style="margin-bottom: 1.5rem;">API Client Management</h2>

        <button class="btn primary" onclick="showGenerateKeyModal()" style="margin-bottom: 2rem;">
            Generate New API Key
        </button>

        <div class="table-container">
            <div class="table-header">
                <h3 class="table-title">Active API Keys</h3>
            </div>
            <div class="table-content">
                <table>
                    <thead>
                    <tr>
                        <th>Client Name</th>
                        <th>API Key</th>
                        <th>Created</th>
                        <th>Total Usage</th>
                        <th>Last Used</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="apiKeysTableBody">
                    <tr>
                        <td colspan="6" class="empty-state">No API keys generated yet</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Implementation Guide -->
        <div class="api-section" style="margin-top: 2rem;">
            <h3 style="margin-bottom: 1rem;">Implementation Guide for Clients</h3>
            <p style="color: #6b7280; margin-bottom: 1rem;">Share these code examples with your clients</p>

            <h4 style="margin-bottom: 1rem;">JavaScript (Fetch API)</h4>
            <div class="code-example">
                <span class="code-language">JavaScript</span>
                <pre>// Replace YOUR_API_KEY with the actual API key
const apiKey = 'YOUR_API_KEY';
const apiUrl = '${window.location.origin}/api/v1/jobs';

fetch(apiUrl, {
    headers: {
        'X-API-Key': apiKey
    }
})
.then(response => response.json())
.then(data => {
    console.log('Jobs data:', data);
    // Process the jobs data
})
.catch(error => {
    console.error('Error fetching jobs:', error);
});</pre>
            </div>

            <h4 style="margin: 1.5rem 0 1rem;">cURL</h4>
            <div class="code-example">
                <span class="code-language">Shell</span>
                <pre>curl -H "X-API-Key: YOUR_API_KEY" ${window.location.origin}/api/v1/jobs</pre>
            </div>

            <h4 style="margin: 1.5rem 0 1rem;">Python</h4>
            <div class="code-example">
                <span class="code-language">Python</span>
                <pre>import requests

api_key = 'YOUR_API_KEY'
api_url = '${window.location.origin}/api/v1/jobs'

headers = {
    'X-API-Key': api_key
}

response = requests.get(api_url, headers=headers)
jobs_data = response.json()

print(f"Total jobs: {jobs_data['data']['total']}")
for job in jobs_data['data']['jobs']:
    print(f"- {job['job_title']} at {job['location_description']}")</pre>
            </div>

            <h4 style="margin: 1.5rem 0 1rem;">PHP</h4>
            <div class="code-example">
                <span class="code-language">PHP</span>
                <pre>&lt;?php
$apiKey = 'YOUR_API_KEY';
$apiUrl = '${window.location.origin}/api/v1/jobs';

$options = [
    'http' => [
        'header' => "X-API-Key: $apiKey\r\n"
    ]
];

$context = stream_context_create($options);
$response = file_get_contents($apiUrl, false, $context);
$jobsData = json_decode($response, true);

echo "Total jobs: " . $jobsData['data']['total'] . "\n";
foreach ($jobsData['data']['jobs'] as $job) {
    echo "- " . $job['job_title'] . " at " . $job['location_description'] . "\n";
}
?&gt;</pre>
            </div>
        </div>
    </div>

    <!-- Real-time Activity Section -->
    <div id="activity" class="section">
        <h2 style="margin-bottom: 1.5rem;">Real-time Activity Monitor</h2>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem;">
            <div class="activity-feed">
                <div class="feed-header">
                    <span>Page Loads</span>
                    <div class="live-indicator">
                        <div class="live-dot"></div>
                        <span>Live</span>
                    </div>
                </div>
                <div class="feed-content" id="loadsFeed">
                    <div class="empty-state">No recent activity</div>
                </div>
            </div>

            <div class="activity-feed">
                <div class="feed-header">
                    <span>Button Clicks</span>
                    <div class="live-indicator">
                        <div class="live-dot"></div>
                        <span>Live</span>
                    </div>
                </div>
                <div class="feed-content" id="clicksFeed">
                    <div class="empty-state">No recent activity</div>
                </div>
            </div>

            <div class="activity-feed">
                <div class="feed-header">
                    <span>API Calls</span>
                    <div class="live-indicator">
                        <div class="live-dot"></div>
                        <span>Live</span>
                    </div>
                </div>
                <div class="feed-content" id="apiFeed">
                    <div class="empty-state">No recent activity</div>
                </div>
            </div>
        </div>

        <!-- iFrame Detection -->
        <div class="api-section" style="margin-top: 2rem;">
            <h3 style="margin-bottom: 1rem;">iFrame Embeddings</h3>
            <div id="iframeClients">
                <p style="color: #6b7280;">No iFrame embeddings detected yet</p>
            </div>
        </div>
    </div>

    <!-- Health Section -->
    <div id="health" class="section">
        <h2 style="margin-bottom: 1.5rem;">System Health Status</h2>
        <div class="status-grid" id="healthStatus">
            <div class="loading">
                <div class="spinner"></div>
                <div>Loading health status...</div>
            </div>
        </div>
    </div>

    <!-- Settings Section -->
    <div id="settings" class="section">
        <h2 style="margin-bottom: 1.5rem;">System Settings</h2>

        <div class="settings-grid">
            <div class="settings-card">
                <h3 class="settings-title">General Settings</h3>

                <div class="setting-item">
                    <label class="setting-label">Cache Duration (minutes)</label>
                    <input type="number" class="setting-input" id="cacheDuration" value="5">
                    <div class="setting-description">How long to cache job data before refreshing</div>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Jobs Per Page</label>
                    <input type="number" class="setting-input" id="jobsPerPage" value="20">
                    <div class="setting-description">Default number of jobs to display per page</div>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Auto-refresh Interval (seconds)</label>
                    <input type="number" class="setting-input" id="refreshInterval" value="300">
                    <div class="setting-description">How often to check for new jobs (0 to disable)</div>
                </div>

                <button class="btn primary" onclick="saveSettings()">Save Settings</button>
            </div>

            <div class="settings-card">
                <h3 class="settings-title">Email Notifications</h3>

                <div class="setting-item">
                    <label class="setting-label">Admin Email</label>
                    <input type="email" class="setting-input" id="adminEmail" value="admin@bmj.com">
                    <div class="setting-description">Receive system alerts and reports</div>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Daily Reports</label>
                    <select class="form-select" id="dailyReports">
                        <option value="enabled">Enabled</option>
                        <option value="disabled">Disabled</option>
                    </select>
                    <div class="setting-description">Receive daily usage reports via email</div>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Alert Threshold (errors/hour)</label>
                    <input type="number" class="setting-input" id="alertThreshold" value="10">
                    <div class="setting-description">Send alert when error rate exceeds this threshold</div>
                </div>

                <button class="btn primary" onclick="saveEmailSettings()">Save Email Settings</button>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Generate API Key Modal -->
<div id="generateKeyModal" class="modal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeGenerateKeyModal()">&times;</button>
        <h2 style="margin-bottom: 1.5rem;">Generate API Key</h2>

        <form id="generateKeyForm">
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label class="form-label">Client ID</label>
                <input type="text" id="clientId" class="form-input" required placeholder="e.g., client-website.com">
            </div>

            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label class="form-label">Client Name</label>
                <input type="text" id="clientName" class="form-input" required placeholder="e.g., Client Website">
            </div>

            <button type="submit" class="btn primary">Generate Key</button>
        </form>

        <div id="generatedKeyDisplay" style="display: none; margin-top: 1.5rem;">
            <p style="font-weight: 600; margin-bottom: 0.5rem;">Generated API Key:</p>
            <div class="api-endpoint">
                <code id="apiKeyDisplay"></code>
                <button class="copy-btn" onclick="copyToClipboard('apiKeyDisplay')">Copy</button>
            </div>
            <p style="color: #dc2626; font-size: 0.875rem; margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 1.25rem;">⚠️</span> Copy this key now. It won't be shown again!
            </p>
        </div>
    </div>
</div>

<!-- Client Details Modal -->
<div id="clientDetailsModal" class="modal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeClientDetailsModal()">&times;</button>
        <h2 id="clientModalTitle" style="margin-bottom: 1.5rem;">Client Details</h2>

        <div id="clientModalContent">
            <!-- Dynamic content will be inserted here -->
        </div>
    </div>
</div>

<script>
    // Check authentication
    const sessionToken = localStorage.getItem('sessionToken');
    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');

    if (!sessionToken || !userInfo.email) {
        window.location.href = '/login';
    }

    // Set user info
    document.getElementById('userName').textContent = userInfo.username || 'Admin';
    document.getElementById('userEmail').textContent = userInfo.email || '';

    // Global variables
    let clients = [];
    let apiKeys = [];
    let usageChart = null;
    let clientDistChart = null;
    let revenueChart = null;
    let geoChart = null;
    let activityInterval = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadDashboard();
        initializeCharts();
        startRealtimeUpdates();
    });

    // Logout function
    function logout() {
        fetch('/api/auth/logout', {
            method: 'POST',
            headers: {
                'x-session-token': sessionToken
            }
        });

        localStorage.removeItem('sessionToken');
        localStorage.removeItem('userInfo');
        window.location.href = '/login';
    }

    // Section navigation
    function showSection(sectionId) {
        // Update nav
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        event.target.classList.add('active');

        // Update sections
        document.querySelectorAll('.section').forEach(section => {
            section.classList.remove('active');
        });
        document.getElementById(sectionId).classList.add('active');

        // Load section data
        switch(sectionId) {
            case 'dashboard':
                loadDashboard();
                break;
            case 'analytics':
                loadAnalytics();
                break;
            case 'clients':
                loadClients();
                break;
            case 'billing':
                loadBilling();
                break;
            case 'health':
                loadHealth();
                break;
            case 'jobs':
                loadJobs();
                break;
            case 'api-clients':
                loadApiClients();
                break;
            case 'activity':
                loadActivity();
                break;
        }
    }

    // Initialize Charts
    function initializeCharts() {
        // Usage Trends Chart
        const ctx = document.getElementById('usageChart').getContext('2d');
        usageChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Page Loads',
                    data: [],
                    borderColor: '#2166ac',
                    backgroundColor: 'rgba(33, 102, 172, 0.1)',
                    tension: 0.4,
                    borderWidth: 3,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }, {
                    label: 'Clicks',
                    data: [],
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    tension: 0.4,
                    borderWidth: 3,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }, {
                    label: 'API Calls',
                    data: [],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    borderWidth: 3,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        cornerRadius: 8,
                        titleFont: {
                            size: 14
                        },
                        bodyFont: {
                            size: 13
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            padding: 8
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            padding: 8
                        }
                    }
                }
            }
        });
    }

    // Load dashboard data
    async function loadDashboard() {
        try {
            const response = await fetch('/api/admin/dashboard', {
                headers: {
                    'x-session-token': sessionToken
                }
            });

            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                throw new Error('Failed to load dashboard');
            }

            const data = await response.json();
            clients = data.data.clients;

            // Update stats
            document.getElementById('totalClients').textContent = data.data.summary.totalClients;
            document.getElementById('activeToday').textContent = data.data.summary.activeClientsToday;
            document.getElementById('apiCallsToday').textContent = data.data.summary.totalApiCallsToday;

            // Calculate monthly revenue
            const monthlyRevenue = calculateMonthlyRevenue(clients);
            document.getElementById('monthlyRevenue').textContent = formatCurrency(monthlyRevenue);

            // Show insights if available
            showInsights(data.data);

            // Update usage chart
            updateUsageChart(clients);

            // Update top clients table
            updateTopClientsTable(clients);

        } catch (error) {
            console.error('Dashboard error:', error);
        }
    }

    // Show insights panel
    function showInsights(data) {
        const insightsPanel = document.getElementById('insightsPanel');
        const insightsContent = document.getElementById('insightsContent');

        const insights = [];

        // Most active client
        if (data.clients.length > 0) {
            const topClient = data.clients[0];
            insights.push(`🏆 Your top client today is <strong>${topClient.name}</strong> with ${topClient.todayMetrics.loads} page loads`);
        }

        // Growth trends
        if (data.summary.totalLoadsToday > 100) {
            insights.push(`📈 Great performance! You've had ${data.summary.totalLoadsToday} page loads today`);
        }

        // API usage
        if (data.publicApiKeys.length > 0) {
            const activeKeys = data.publicApiKeys.filter(k => k.totalUsage > 0).length;
            insights.push(`🔑 ${activeKeys} of ${data.publicApiKeys.length} API keys are actively being used`);
        }

        if (insights.length > 0) {
            insightsContent.innerHTML = insights.join('<br><br>');
            insightsPanel.style.display = 'block';
        }
    }

    // Calculate monthly revenue
    function calculateMonthlyRevenue(clients) {
        let total = 0;
        clients.forEach(client => {
            total += (client.last30Days.loads * 0.10) +
                    (client.last30Days.clicks * 0.50) +
                    (client.last30Days.apiCalls * 0.05);
        });
        return total;
    }

    // Format currency
    function formatCurrency(amount, currency = 'GBP') {
        const symbols = {
            GBP: '£',
            USD: '$',
            EUR: '€',
            INR: '₹',
            JPY: '¥',
            CNY: '¥',
            AUD: '$',
            CAD: '$',
            CHF: 'Fr',
            SEK: 'kr',
            NZD: '$',
            SGD: '$',
            HKD: '$',
            NOK: 'kr',
            MXN: '$'
        };
        return symbols[currency] + amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // Update currency symbol in form
    function updateCurrencySymbol() {
        const currency = document.getElementById('billingCurrency').value;
        const symbols = {
            GBP: '£',
            USD: '$',
            EUR: '€',
            INR: '₹',
            JPY: '¥',
            CNY: '¥',
            AUD: '$',
            CAD: '$',
            CHF: 'Fr',
            SEK: 'kr',
            NZD: '$',
            SGD: '$',
            HKD: '$',
            NOK: 'kr',
            MXN: '$'
        };
        document.getElementById('currencyPreview1').textContent = symbols[currency];
        document.getElementById('currencyPreview2').textContent = symbols[currency];
        document.getElementById('currencyPreview3').textContent = symbols[currency];
    }

    // Update usage chart
    function updateUsageChart(clients) {
        // Generate last 7 days labels
        const labels = [];
        const loads = [];
        const clicks = [];
        const apiCalls = [];

        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            labels.push(date.toLocaleDateString('en-GB', { weekday: 'short' }));

            // Aggregate data for each day
            let dayLoads = 0, dayClicks = 0, dayApiCalls = 0;
            clients.forEach(client => {
                const dateKey = date.toISOString().split('T')[0];
                if (client.metrics && client.metrics.daily[dateKey]) {
                    dayLoads += client.metrics.daily[dateKey].loads || 0;
                    dayClicks += client.metrics.daily[dateKey].clicks || 0;
                    dayApiCalls += client.metrics.daily[dateKey].apiCalls || 0;
                }
            });

            loads.push(dayLoads);
            clicks.push(dayClicks);
            apiCalls.push(dayApiCalls);
        }

        usageChart.data.labels = labels;
        usageChart.data.datasets[0].data = loads;
        usageChart.data.datasets[1].data = clicks;
        usageChart.data.datasets[2].data = apiCalls;
        usageChart.update();
    }

    // Update top clients table
    function updateTopClientsTable(clients) {
        const tbody = document.getElementById('topClientsTable');

        if (clients.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No client data yet</td></tr>';
            return;
        }

        // Sort by total usage
        const sortedClients = [...clients].sort((a, b) => {
            const aTotal = a.totalMetrics.loads + a.totalMetrics.clicks + a.totalMetrics.apiCalls;
            const bTotal = b.totalMetrics.loads + b.totalMetrics.clicks + b.totalMetrics.apiCalls;
            return bTotal - aTotal;
        }).slice(0, 10); // Top 10

        tbody.innerHTML = sortedClients.map(client => {
            const isIframe = client.utm_medium === 'iframe';
            const weeklyTotal = client.last7Days.loads + client.last7Days.clicks + client.last7Days.apiCalls;
            const monthlyTotal = client.last30Days.loads + client.last30Days.clicks + client.last30Days.apiCalls;
            const revenue = (client.last30Days.loads * 0.10) +
                           (client.last30Days.clicks * 0.50) +
                           (client.last30Days.apiCalls * 0.05);

            return `
                <tr>
                    <td>
                        <div class="client-name" onclick="viewClientDetails('${client.clientId}')">
                            ${client.name}
                            ${isIframe ? '<span class="badge iframe-badge">iFrame</span>' : ''}
                        </div>
                        <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">${client.domain || ''}</div>
                    </td>
                    <td>${client.utm_medium || 'widget'}</td>
                    <td>
                        <span class="metric-badge loads">${client.todayMetrics.loads} loads</span>
                        <span class="metric-badge clicks">${client.todayMetrics.clicks} clicks</span>
                    </td>
                    <td>${weeklyTotal.toLocaleString()}</td>
                    <td>${monthlyTotal.toLocaleString()}</td>
                    <td>
                        <span class="revenue-badge">${formatCurrency(revenue)}</span>
                    </td>
                    <td>
                        <button class="btn" onclick="viewClientDetails('${client.clientId}')">
                            View Details
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // View client details
    async function viewClientDetails(clientId) {
        try {
            const response = await fetch(`/api/admin/client/${clientId}`, {
                headers: {
                    'x-session-token': sessionToken
                }
            });

            const data = await response.json();

            if (data.success) {
                showClientDetailsModal(data.data);
            }
        } catch (error) {
            console.error('Error loading client details:', error);
        }
    }

    // Show client details modal
    function showClientDetailsModal(client) {
        document.getElementById('clientModalTitle').textContent = client.name;

        const content = `
            <div class="client-metrics">
                <div class="metric-item">
                    <div class="metric-label">Total Page Loads</div>
                    <div class="metric-value">${client.metrics.totalLoads.toLocaleString()}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Total Clicks</div>
                    <div class="metric-value">${client.metrics.totalClicks.toLocaleString()}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Total API Calls</div>
                    <div class="metric-value">${client.metrics.totalApiCalls.toLocaleString()}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">First Seen</div>
                    <div class="metric-value">${new Date(client.firstSeen).toLocaleDateString()}</div>
                </div>
            </div>

            <h4 style="margin: 2rem 0 1rem;">Client Information</h4>
            <table style="width: 100%;">
                <tr>
                    <td style="padding: 0.5rem 0;"><strong>Domain:</strong></td>
                    <td>${client.domain}</td>
                </tr>
                <tr>
                    <td style="padding: 0.5rem 0;"><strong>UTM Source:</strong></td>
                    <td>${client.utm_source}</td>
                </tr>
                <tr>
                    <td style="padding: 0.5rem 0;"><strong>UTM Medium:</strong></td>
                    <td>${client.utm_medium}</td>
                </tr>
                <tr>
                    <td style="padding: 0.5rem 0;"><strong>Last Seen:</strong></td>
                    <td>${new Date(client.lastSeen).toLocaleString()}</td>
                </tr>
            </table>

            <h4 style="margin: 2rem 0 1rem;">Estimated Revenue</h4>
            <div class="billing-result" style="margin-top: 1rem;">
                <div class="billing-amount">${formatCurrency(calculateClientRevenue(client))}</div>
                <div class="billing-period">Total revenue from this client</div>
            </div>

            <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                <button class="btn primary" onclick="generateClientReport('${client.clientId}')">
                    Generate Report
                </button>
                <button class="btn" onclick="viewClientApiKey('${client.clientId}')">
                    View API Key
                </button>
            </div>
        `;

        document.getElementById('clientModalContent').innerHTML = content;
        document.getElementById('clientDetailsModal').style.display = 'flex';
    }

    // Calculate client revenue
    function calculateClientRevenue(client) {
        const costPerLoad = 0.10;
        const costPerClick = 0.50;
        const costPerAPI = 0.05;

        return (client.metrics.totalLoads * costPerLoad) +
               (client.metrics.totalClicks * costPerClick) +
               (client.metrics.totalApiCalls * costPerAPI);
    }

    // Close client details modal
    function closeClientDetailsModal() {
        document.getElementById('clientDetailsModal').style.display = 'none';
    }

    // Load analytics
    function loadAnalytics() {
        // Initialize additional charts if not already done
        if (!clientDistChart) {
            const ctx2 = document.getElementById('clientDistChart').getContext('2d');
            clientDistChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Widget', 'iFrame', 'API'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#2166ac', '#8b5cf6', '#10b981'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });

            const ctx3 = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: ['Widget', 'iFrame', 'API'],
                    datasets: [{
                        label: 'Revenue (£)',
                        data: [0, 0, 0],
                        backgroundColor: ['#2166ac', '#8b5cf6', '#10b981'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            const ctx4 = document.getElementById('geoChart').getContext('2d');
            geoChart = new Chart(ctx4, {
                type: 'bar',
                data: {
                    labels: ['UK', 'US', 'Canada', 'Australia', 'Other'],
                    datasets: [{
                        label: 'Clients by Region',
                        data: [45, 25, 15, 10, 5],
                        backgroundColor: '#2166ac',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Update chart data based on actual clients
        updateAnalyticsCharts();
    }

    // Update analytics charts
    function updateAnalyticsCharts() {
        // Calculate distribution
        let widgetCount = 0, iframeCount = 0, apiCount = 0;
        let widgetRevenue = 0, iframeRevenue = 0, apiRevenue = 0;

        clients.forEach(client => {
            const revenue = calculateClientRevenue30d(client);

            if (client.utm_medium === 'iframe') {
                iframeCount++;
                iframeRevenue += revenue;
            } else if (client.utm_medium === 'api') {
                apiCount++;
                apiRevenue += revenue;
            } else {
                widgetCount++;
                widgetRevenue += revenue;
            }
        });

        // Update distribution chart
        if (clientDistChart) {
            clientDistChart.data.datasets[0].data = [widgetCount, iframeCount, apiCount];
            clientDistChart.update();
        }

        // Update revenue chart
        if (revenueChart) {
            revenueChart.data.datasets[0].data = [widgetRevenue, iframeRevenue, apiRevenue];
            revenueChart.update();
        }
    }

    // Calculate 30-day revenue
    function calculateClientRevenue30d(client) {
        return (client.last30Days.loads * 0.10) +
               (client.last30Days.clicks * 0.50) +
               (client.last30Days.apiCalls * 0.05);
    }

    // Search clients
    function searchClients(query) {
        const filtered = clients.filter(client =>
            client.name.toLowerCase().includes(query.toLowerCase()) ||
            client.domain.toLowerCase().includes(query.toLowerCase())
        );
        displayClients(filtered);
    }

    // Display clients
    function displayClients(clientsList) {
        const container = document.getElementById('clientsList');

        if (clientsList.length === 0) {
            container.innerHTML = '<div class="empty-state">No clients found</div>';
            return;
        }

        container.innerHTML = clientsList.map(client => `
            <div class="client-details-card">
                <div class="client-header">
                    <h3 class="client-title">${client.name}</h3>
                    <button class="btn primary" onclick="viewClientDetails('${client.clientId}')">
                        View Full Details
                    </button>
                </div>
                <div class="client-metrics">
                    <div class="metric-item">
                        <div class="metric-label">Page Loads (30d)</div>
                        <div class="metric-value">${client.last30Days.loads.toLocaleString()}</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Clicks (30d)</div>
                        <div class="metric-value">${client.last30Days.clicks.toLocaleString()}</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">API Calls (30d)</div>
                        <div class="metric-value">${client.last30Days.apiCalls.toLocaleString()}</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Revenue (30d)</div>
                        <div class="metric-value">${formatCurrency(calculateClientRevenue30d(client))}</div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Load clients
    function loadClients() {
        displayClients(clients);
    }

    // Load billing
    function loadBilling() {
        // Populate client dropdown
        const select = document.getElementById('billingClient');
        select.innerHTML = '<option value="">Choose a client...</option>' +
            clients.map(client => `<option value="${client.clientId}">${client.name}</option>`).join('');

        // Update revenue table
        updateRevenueTable();
    }

    // Update revenue table
    function updateRevenueTable() {
        const tbody = document.getElementById('revenueTable');

        if (clients.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No revenue data yet</td></tr>';
            return;
        }

        tbody.innerHTML = clients.slice(0, 10).map(client => {
            const thisMonth = calculateClientRevenue30d(client);
            const total = calculateClientRevenue(client);

            return `
                <tr>
                    <td>
                        <div class="client-name">${client.name}</div>
                    </td>
                    <td>${formatCurrency(thisMonth)}</td>
                    <td>${formatCurrency(thisMonth * 0.8)}</td>
                    <td>${formatCurrency(total)}</td>
                    <td><span class="badge" style="background: #d1fae5; color: #065f46;">Active</span></td>
                </tr>
            `;
        }).join('');
    }

    // Calculate billing
    async function calculateBilling() {
        const clientId = document.getElementById('billingClient').value;
        const currency = document.getElementById('billingCurrency').value;
        const costPerLoad = parseFloat(document.getElementById('costPerLoad').value);
        const costPerClick = parseFloat(document.getElementById('costPerClick').value);
        const costPerAPI = parseFloat(document.getElementById('costPerAPI').value);
        const period = document.getElementById('billingPeriod').value;

        if (!clientId) {
            alert('Please select a client');
            return;
        }

        try {
            const response = await fetch('/api/admin/calculate-billing', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-session-token': sessionToken
                },
                body: JSON.stringify({
                    clientId,
                    costPerLoad,
                    costPerClick,
                    costPerAPI,
                    period,
                    currency
                })
            });

            const data = await response.json();

            if (data.success) {
                const billing = data.billing;
                document.getElementById('totalAmount').textContent = formatCurrency(billing.total, currency);
                document.getElementById('billingDetails').textContent = billing.period;
                document.getElementById('breakdownLoads').textContent = billing.breakdown.loads.count.toLocaleString();
                document.getElementById('breakdownClicks').textContent = billing.breakdown.clicks.count.toLocaleString();
                document.getElementById('breakdownAPI').textContent = billing.breakdown.apiCalls.count.toLocaleString();
                document.getElementById('billingResult').style.display = 'block';
            }
        } catch (error) {
            console.error('Billing calculation error:', error);
            alert('Failed to calculate billing');
        }
    }

    // Load health status
    async function loadHealth() {
        try {
            const response = await fetch('/health');
            const data = await response.json();

            const healthStatus = document.getElementById('healthStatus');
            healthStatus.innerHTML = `
                <div class="status-card">
                    <div class="status-header">
                        <div class="status-icon ${data.status.toLowerCase()}">${data.status === 'OK' ? '✓' : data.status === 'PARTIAL' ? '!' : '✗'}</div>
                        <div class="status-title">Overall Status</div>
                    </div>
                    <div class="status-details">
                        Status: ${data.status}<br>
                        Server Time: ${new Date(data.serverTime).toLocaleString()}<br>
                        Uptime: ${Math.floor(data.uptime / 3600)} hours
                    </div>
                </div>

                <div class="status-card">
                    <div class="status-header">
                        <div class="status-icon ${data.dynamoDB.connected ? 'ok' : 'error'}">${data.dynamoDB.connected ? '✓' : '✗'}</div>
                        <div class="status-title">DynamoDB</div>
                    </div>
                    <div class="status-details">
                        Connected: ${data.dynamoDB.connected ? 'Yes' : 'No'}<br>
                        Table: ${data.dynamoDB.tableName}<br>
                        Region: ${data.dynamoDB.region}<br>
                        Profile: ${data.dynamoDB.profile}<br>
                        ${data.dynamoDB.lastError ? `Error: ${data.dynamoDB.lastError}` : ''}
                    </div>
                </div>

                <div class="status-card">
                    <div class="status-header">
                        <div class="status-icon ok">✓</div>
                        <div class="status-title">Jobs Cache</div>
                    </div>
                    <div class="status-details">
                        Jobs Count: ${data.cache.jobs_count}<br>
                        Source: ${data.cache.source || 'N/A'}<br>
                        Age: ${data.cache.age_seconds ? `${Math.floor(data.cache.age_seconds / 60)} minutes` : 'N/A'}<br>
                        Last Fetch: ${data.cache.last_fetch ? new Date(data.cache.last_fetch).toLocaleString() : 'Never'}
                    </div>
                </div>

                <div class="status-card">
                    <div class="status-header">
                        <div class="status-icon ok">✓</div>
                        <div class="status-title">API Stats</div>
                    </div>
                    <div class="status-details" id="apiStatsDetails">
                        Loading...
                    </div>
                </div>
            `;

            // Load API stats
            const statsResponse = await fetch('/api/stats');
            const statsData = await statsResponse.json();

            document.getElementById('apiStatsDetails').innerHTML = `
                Total API Calls: ${statsData.data.summary.total_api_calls.toLocaleString()}<br>
                Calls Today: ${statsData.data.summary.calls_today.toLocaleString()}<br>
                Calls This Hour: ${statsData.data.summary.calls_this_hour.toLocaleString()}<br>
                Memory Usage: ${Math.round(statsData.data.server_info.memory_usage.heapUsed / 1024 / 1024)} MB
            `;
        } catch (error) {
            console.error('Error loading health:', error);
            document.getElementById('healthStatus').innerHTML =
                '<div class="empty-state">Error loading health status</div>';
        }
    }

    // Load jobs data
    async function loadJobs() {
        try {
            // Update public API URL
            document.getElementById('publicApiUrl').textContent = `${window.location.origin}/api/v1/jobs`;

            const response = await fetch('/api/jobs');
            const data = await response.json();

            // Format JSON with syntax highlighting
            const formattedJson = JSON.stringify(data, null, 2);
            document.getElementById('jobsData').innerHTML = `<pre style="margin: 0; color: #e6e6e6;">${escapeHtml(formattedJson)}</pre>`;
        } catch (error) {
            console.error('Error loading jobs:', error);
            document.getElementById('jobsData').textContent = 'Error loading jobs data';
        }
    }

    // Escape HTML for display
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    // Load API clients
    async function loadApiClients() {
        try {
            const response = await fetch('/api/admin/dashboard', {
                headers: {
                    'x-session-token': sessionToken
                }
            });

            const data = await response.json();
            apiKeys = data.data.publicApiKeys || [];

            const tbody = document.getElementById('apiKeysTableBody');
            if (apiKeys.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No API keys generated yet</td></tr>';
            } else {
                tbody.innerHTML = apiKeys.map(key => `
                    <tr>
                        <td>${key.clientName}</td>
                        <td>
                            <code style="background: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 4px;">${key.apiKey}</code>
                            <button class="copy-btn" onclick="copyFullApiKey('${key.clientId}')">Copy Full Key</button>
                        </td>
                        <td>${new Date(key.createdAt).toLocaleDateString()}</td>
                        <td>${key.totalUsage.toLocaleString()}</td>
                        <td>${key.lastUsed ? new Date(key.lastUsed).toLocaleString() : 'Never'}</td>
                        <td>
                            <button class="regenerate-btn" onclick="regenerateApiKey('${key.clientId}', '${key.clientName}')">
                                Regenerate
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading API clients:', error);
        }
    }

    // Copy to clipboard
    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        const text = element.textContent;

        navigator.clipboard.writeText(text).then(() => {
            // Change button text temporarily
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'Copied!';
            btn.style.background = '#10b981';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy:', err);
            alert('Failed to copy to clipboard');
        });
    }

    // Copy full API key
    async function copyFullApiKey(clientId) {
        try {
            const response = await fetch(`/api/admin/api-key/${clientId}`, {
                headers: {
                    'x-session-token': sessionToken
                }
            });

            const data = await response.json();

            if (data.success) {
                navigator.clipboard.writeText(data.apiKey).then(() => {
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    btn.style.background = '#10b981';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 2000);
                });
            }
        } catch (error) {
            console.error('Error getting API key:', error);
            alert('Failed to get API key');
        }
    }

    // Regenerate API key
    async function regenerateApiKey(clientId, clientName) {
        if (!confirm(`Are you sure you want to regenerate the API key for ${clientName}?\n\nThe old key will stop working immediately.`)) {
            return;
        }

        try {
            const response = await fetch('/api/admin/generate-api-key', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-session-token': sessionToken
                },
                body: JSON.stringify({ clientId, clientName, regenerate: true })
            });

            const data = await response.json();

            if (response.ok) {
                // Show the new key in a modal
                showApiKeyModal(data.apiKey, clientName);
                loadApiClients();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Network error. Please try again.');
        }
    }

    // Show API key modal
    function showApiKeyModal(apiKey, clientName) {
        alert(`New API key generated for ${clientName}:\n\n${apiKey}\n\nPlease copy this key now as it won't be shown again!`);
    }

    // Show generate key modal
    function showGenerateKeyModal() {
        document.getElementById('generateKeyModal').style.display = 'flex';
        document.getElementById('clientId').focus();
    }

    // Close generate key modal
    function closeGenerateKeyModal() {
        document.getElementById('generateKeyModal').style.display = 'none';
        document.getElementById('generateKeyForm').reset();
        document.getElementById('generatedKeyDisplay').style.display = 'none';
    }

    // Generate key form submit
    document.getElementById('generateKeyForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const clientId = document.getElementById('clientId').value.trim();
        const clientName = document.getElementById('clientName').value.trim();

        try {
            const response = await fetch('/api/admin/generate-api-key', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-session-token': sessionToken
                },
                body: JSON.stringify({ clientId, clientName })
            });

            const data = await response.json();

            if (response.ok) {
                document.getElementById('apiKeyDisplay').textContent = data.apiKey;
                document.getElementById('generatedKeyDisplay').style.display = 'block';

                // Reload API clients
                loadApiClients();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Network error. Please try again.');
        }
    });

    // Load activity
    async function loadActivity() {
        try {
            const response = await fetch('/api/admin/activity/recent', {
                headers: {
                    'x-session-token': sessionToken
                }
            });

            if (response.ok) {
                const data = await response.json();
                updateActivityFeeds(data.activities);
            }
        } catch (error) {
            console.error('Error loading activity:', error);
        }
    }

    // Update activity feeds
    function updateActivityFeeds(activities) {
        const loadsFeed = document.getElementById('loadsFeed');
        const clicksFeed = document.getElementById('clicksFeed');
        const apiFeed = document.getElementById('apiFeed');

        // Update loads feed
        if (activities.loads && activities.loads.length > 0) {
            loadsFeed.innerHTML = activities.loads.map(item => `
                <div class="activity-item">
                    <div class="activity-client">${item.client}</div>
                    <div class="activity-action">${item.action}</div>
                    <div class="activity-time">${item.time}</div>
                </div>
            `).join('');
        } else {
            loadsFeed.innerHTML = '<div class="empty-state">No recent page loads</div>';
        }

        // Update clicks feed
        if (activities.clicks && activities.clicks.length > 0) {
            clicksFeed.innerHTML = activities.clicks.map(item => `
                <div class="activity-item">
                    <div class="activity-client">${item.client}</div>
                    <div class="activity-action">${item.action}</div>
                    <div class="activity-time">${item.time}</div>
                </div>
            `).join('');
        } else {
            clicksFeed.innerHTML = '<div class="empty-state">No recent clicks</div>';
        }

        // Update API feed
        if (activities.apiCalls && activities.apiCalls.length > 0) {
            apiFeed.innerHTML = activities.apiCalls.map(item => `
                <div class="activity-item">
                    <div class="activity-client">${item.client}</div>
                    <div class="activity-action">${item.action}</div>
                    <div class="activity-time">${item.time}</div>
                </div>
            `).join('');
        } else {
            apiFeed.innerHTML = '<div class="empty-state">No recent API calls</div>';
        }

        // Update iframe clients section
        updateIframeClients();
    }

    // Update iframe clients
    function updateIframeClients() {
        const iframeClients = clients.filter(c => c.utm_medium === 'iframe');

        if (iframeClients.length > 0) {
            document.getElementById('iframeClients').innerHTML = `
                <h4>Active iFrame Embeddings (${iframeClients.length})</h4>
                ${iframeClients.map(client => `
                    <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; margin-top: 0.75rem; border-left: 4px solid #8b5cf6;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <strong style="color: #1f2937;">${client.name}</strong>
                                <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;">
                                    Embedded at: ${client.domain}<br>
                                    First detected: ${new Date(client.firstSeen).toLocaleDateString()}<br>
                                    Total loads: ${client.totalMetrics.loads.toLocaleString()}
                                </div>
                            </div>
                            <button class="btn" onclick="viewClientDetails('${client.clientId}')" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;">
                                Details
                            </button>
                        </div>
                    </div>
                `).join('')}
            `;
        } else {
            document.getElementById('iframeClients').innerHTML = '<p style="color: #6b7280;">No iFrame embeddings detected yet</p>';
        }
    }

    // Start real-time updates
    function startRealtimeUpdates() {
        // Update activity feed every 30 seconds when on activity tab
        activityInterval = setInterval(() => {
            const activeSection = document.querySelector('.section.active');
            if (activeSection && activeSection.id === 'activity') {
                loadActivity();
            }
        }, 30000);
    }

    // Chart update function
    function updateChart(period) {
        document.querySelectorAll('.chart-filters .filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        // Update chart based on period
        let days = 7;
        if (period === '30d') days = 30;
        if (period === '90d') days = 90;

        const labels = [];
        const loads = [];
        const clicks = [];
        const apiCalls = [];

        for (let i = days - 1; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);

            if (days <= 7) {
                labels.push(date.toLocaleDateString('en-GB', { weekday: 'short' }));
            } else if (days <= 30) {
                labels.push(date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }));
            } else {
                // For 90 days, show weekly
                if (i % 7 === 0) {
                    labels.push(date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }));
                }
            }

            // Aggregate data
            let dayLoads = 0, dayClicks = 0, dayApiCalls = 0;
            clients.forEach(client => {
                const dateKey = date.toISOString().split('T')[0];
                if (client.metrics && client.metrics.daily[dateKey]) {
                    dayLoads += client.metrics.daily[dateKey].loads || 0;
                    dayClicks += client.metrics.daily[dateKey].clicks || 0;
                    dayApiCalls += client.metrics.daily[dateKey].apiCalls || 0;
                }
            });

            if (days <= 30 || i % 7 === 0) {
                loads.push(dayLoads);
                clicks.push(dayClicks);
                apiCalls.push(dayApiCalls);
            }
        }

        usageChart.data.labels = labels;
        usageChart.data.datasets[0].data = loads;
        usageChart.data.datasets[1].data = clicks;
        usageChart.data.datasets[2].data = apiCalls;
        usageChart.update();
    }

    // Export client data
    function exportClientData() {
        const csvContent = [
            ['Client Name', 'Domain', 'Type', 'Total Loads', 'Total Clicks', 'Total API Calls', 'Revenue (£)', 'First Seen', 'Last Seen'],
            ...clients.map(client => [
                client.name,
                client.domain,
                client.utm_medium || 'widget',
                client.totalMetrics.loads,
                client.totalMetrics.clicks,
                client.totalMetrics.apiCalls,
                calculateClientRevenue(client).toFixed(2),
                new Date(client.firstSeen).toLocaleDateString(),
                new Date(client.lastSeen).toLocaleDateString()
            ])
        ].map(row => row.join(',')).join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', `bmj-careers-clients-${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // Generate client report
    function generateClientReport(clientId) {
        const client = clients.find(c => c.clientId === clientId);
        if (!client) return;

        const report = `
BMJ Careers Client Report
Generated: ${new Date().toLocaleString()}

CLIENT INFORMATION
==================
Name: ${client.name}
Domain: ${client.domain}
Type: ${client.utm_medium || 'widget'}
First Seen: ${new Date(client.firstSeen).toLocaleDateString()}
Last Seen: ${new Date(client.lastSeen).toLocaleDateString()}

USAGE METRICS
=============
Total Page Loads: ${client.totalMetrics.loads.toLocaleString()}
Total Clicks: ${client.totalMetrics.clicks.toLocaleString()}
Total API Calls: ${client.totalMetrics.apiCalls.toLocaleString()}

Today's Activity:
- Loads: ${client.todayMetrics.loads}
- Clicks: ${client.todayMetrics.clicks}
- API Calls: ${client.todayMetrics.apiCalls}

Last 7 Days:
- Loads: ${client.last7Days.loads}
- Clicks: ${client.last7Days.clicks}
- API Calls: ${client.last7Days.apiCalls}

Last 30 Days:
- Loads: ${client.last30Days.loads}
- Clicks: ${client.last30Days.clicks}
- API Calls: ${client.last30Days.apiCalls}

REVENUE SUMMARY
===============
Total Revenue: £${calculateClientRevenue(client).toFixed(2)}
Last 30 Days: £${calculateClientRevenue30d(client).toFixed(2)}

PRICING BREAKDOWN
=================
Page Loads: ${client.totalMetrics.loads} × £0.10 = £${(client.totalMetrics.loads * 0.10).toFixed(2)}
Clicks: ${client.totalMetrics.clicks} × £0.50 = £${(client.totalMetrics.clicks * 0.50).toFixed(2)}
API Calls: ${client.totalMetrics.apiCalls} × £0.05 = £${(client.totalMetrics.apiCalls * 0.05).toFixed(2)}
        `;

        const blob = new Blob([report], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', `${client.name.replace(/[^a-z0-9]/gi, '_')}_report_${new Date().toISOString().split('T')[0]}.txt`);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // View client API key
    async function viewClientApiKey(clientId) {
        try {
            const response = await fetch(`/api/admin/api-key/${clientId}`, {
                headers: {
                    'x-session-token': sessionToken
                }
            });

            const data = await response.json();

            if (data.success) {
                alert(`API Key for ${data.clientData.clientName}:\n\n${data.apiKey}`);
            } else {
                alert('No API key found for this client. Generate one in the API Management section.');
            }
        } catch (error) {
            console.error('Error getting API key:', error);
            alert('Failed to get API key');
        }
    }

    // Generate invoice
    function generateInvoice() {
        alert('Invoice generation feature coming soon!');
    }

    // Settings functions
    function saveSettings() {
        const settings = {
            cacheDuration: document.getElementById('cacheDuration').value,
            jobsPerPage: document.getElementById('jobsPerPage').value,
            refreshInterval: document.getElementById('refreshInterval').value
        };

        // In a real implementation, this would save to the server
        localStorage.setItem('bmjAdminSettings', JSON.stringify(settings));

        // Show success message
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'Settings Saved!';
        btn.style.background = '#10b981';
        setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = '';
        }, 2000);
    }

    function saveEmailSettings() {
        const settings = {
            adminEmail: document.getElementById('adminEmail').value,
            dailyReports: document.getElementById('dailyReports').value,
            alertThreshold: document.getElementById('alertThreshold').value
        };

        // In a real implementation, this would save to the server
        localStorage.setItem('bmjEmailSettings', JSON.stringify(settings));

        // Show success message
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'Email Settings Saved!';
        btn.style.background = '#10b981';
        setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = '';
        }, 2000);
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (activityInterval) {
            clearInterval(activityInterval);
        }
    });

    // Load saved settings
    function loadSavedSettings() {
        const settings = JSON.parse(localStorage.getItem('bmjAdminSettings') || '{}');
        if (settings.cacheDuration) document.getElementById('cacheDuration').value = settings.cacheDuration;
        if (settings.jobsPerPage) document.getElementById('jobsPerPage').value = settings.jobsPerPage;
        if (settings.refreshInterval) document.getElementById('refreshInterval').value = settings.refreshInterval;

        const emailSettings = JSON.parse(localStorage.getItem('bmjEmailSettings') || '{}');
        if (emailSettings.adminEmail) document.getElementById('adminEmail').value = emailSettings.adminEmail;
        if (emailSettings.dailyReports) document.getElementById('dailyReports').value = emailSettings.dailyReports;
        if (emailSettings.alertThreshold) document.getElementById('alertThreshold').value = emailSettings.alertThreshold;
    }

    // Load settings on page load
    loadSavedSettings();
</script>
</body>
</html>
