<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console - BMJ Careers</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        /* Enhanced React-like styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0066cc;
            --primary-dark: #0052a3;
            --secondary: #48bb78;
            --danger: #f56565;
            --warning: #FFC000;
            --info: #4299e1;
            --dark: #1d1d1b;
            --gray: #6b7280;
            --light: #f0f4f8;
            --white: #ffffff;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 25px rgba(0,0,0,0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background: #f0f4f8;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            color: var(--dark);
            line-height: 1.6;
        }

        /* Loading States */
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* App Container */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--white);
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
            color: var(--white);
        }

        .sidebar-logo {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar-menu {
            padding: 1rem 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 0.875rem 1.5rem;
            color: var(--gray);
            text-decoration: none;
            transition: var(--transition);
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.9375rem;
            position: relative;
            overflow: hidden;
        }

        .menu-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: var(--primary);
            transform: translateX(-100%);
            transition: var(--transition);
        }

        .menu-item:hover {
            color: var(--primary);
            background: rgba(102, 126, 234, 0.05);
        }

        .menu-item.active {
            color: var(--primary);
            background: rgba(102, 126, 234, 0.1);
            font-weight: 600;
        }

        .menu-item.active::before {
            transform: translateX(0);
        }

        .menu-icon {
            width: 20px;
            height: 20px;
            margin-right: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            transition: var(--transition);
        }

        /* Header */
        .header {
            background: var(--white);
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--light);
            border-radius: 9999px;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-menu:hover {
            background: #e2e8f0;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        /* Content Area */
        .content {
            padding: 2rem;
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            overflow: hidden;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--dark);
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .stat-icon.primary {
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary);
        }

        .stat-icon.success {
            background: rgba(72, 187, 120, 0.1);
            color: var(--secondary);
        }

        .stat-icon.warning {
            background: rgba(237, 137, 54, 0.1);
            color: var(--warning);
        }

        .stat-icon.info {
            background: rgba(66, 153, 225, 0.1);
            color: var(--info);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.875rem;
        }

        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .stat-change.positive {
            background: rgba(72, 187, 120, 0.1);
            color: var(--secondary);
        }

        .stat-change.negative {
            background: rgba(245, 101, 101, 0.1);
            color: var(--danger);
        }

        /* Real-time Indicator */
        .real-time-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.875rem;
            background: #48bb78;
            color: var(--white);
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.8;
            }
        }

        .real-time-dot {
            width: 6px;
            height: 6px;
            background: var(--white);
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Session Cards */
        .session-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .session-card {
            background: var(--white);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            position: relative;
        }

        .session-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .session-card.active {
            border: 2px solid var(--secondary);
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .session-client {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9375rem;
        }

        .session-id {
            font-size: 0.625rem;
            color: var(--gray);
            font-family: monospace;
        }

        .session-badge {
            padding: 0.25rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.625rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .session-badge.active {
            background: rgba(72, 187, 120, 0.1);
            color: var(--secondary);
        }

        .session-badge.idle {
            background: rgba(237, 137, 54, 0.1);
            color: var(--warning);
        }

        .session-badge.ended {
            background: rgba(113, 128, 150, 0.1);
            color: var(--gray);
        }

        .session-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .metric-mini {
            text-align: center;
            padding: 0.5rem;
            background: var(--light);
            border-radius: 6px;
        }

        .metric-mini-value {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--primary);
        }

        .metric-mini-label {
            font-size: 0.625rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Activity Feed */
        .activity-feed {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: start;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            transition: var(--transition);
        }

        .activity-item:hover {
            background: var(--light);
        }

        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .activity-icon.load {
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary);
        }

        .activity-icon.click {
            background: rgba(237, 137, 54, 0.1);
            color: var(--warning);
        }

        .activity-icon.api {
            background: rgba(66, 153, 225, 0.1);
            color: var(--info);
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.875rem;
            margin-bottom: 0.125rem;
        }

        .activity-description {
            color: var(--gray);
            font-size: 0.75rem;
        }

        .activity-time {
            color: var(--gray);
            font-size: 0.75rem;
            white-space: nowrap;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }

        /* Buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--dark);
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-success {
            background: var(--secondary);
            color: var(--white);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-sm {
            padding: 0.375rem 0.875rem;
            font-size: 0.75rem;
        }

        .btn-warning {
            background: #FFC000;
            color: #1d1d1b;
        }

        .btn-warning:hover {
            background: #e6ac00;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--light);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e2e8f0;
        }

        td {
            padding: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.875rem;
        }

        tr:hover {
            background: var(--light);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            padding: 2rem;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease-out;
            box-shadow: var(--shadow-xl);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Section Display */
        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Form inputs */
        .form-input {
            padding: 0.625rem 0.875rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-label {
            font-weight: 500;
            color: var(--dark);
            font-size: 0.875rem;
        }

        .form-group {
            display: grid;
            gap: 0.5rem;
        }

        .form-select {
            padding: 0.625rem 0.875rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.875rem;
            background: var(--white);
            cursor: pointer;
        }

        /* Settings form */
        .settings-form {
            display: grid;
            gap: 1.5rem;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .empty-state-description {
            font-size: 0.875rem;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--white);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 300px;
            transform: translateX(400px);
            transition: transform 0.3s ease-out;
            z-index: 3000;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .toast.success .toast-icon {
            background: rgba(72, 187, 120, 0.1);
            color: var(--secondary);
        }

        .toast.error .toast-icon {
            background: rgba(245, 101, 101, 0.1);
            color: var(--danger);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.125rem;
        }

        .toast-message {
            font-size: 0.875rem;
            color: var(--gray);
        }

        /* User dropdown */
        .user-dropdown {
            position: relative;
        }

        .user-dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: var(--white);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            min-width: 220px;
            display: none;
            z-index: 1000;
            overflow: hidden;
        }

        .user-dropdown-menu.show {
            display: block;
            animation: dropdownFadeIn 0.2s ease-out;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-header {
            padding: 1rem;
            background: var(--light);
        }

        .user-email {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .user-role {
            font-size: 0.75rem;
            color: var(--gray);
        }

        .dropdown-divider {
            height: 1px;
            background: #e5e7eb;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--dark);
            text-decoration: none;
            transition: background 0.2s ease;
        }

        .dropdown-item:hover {
            background: var(--light);
        }

        .dropdown-icon {
            font-size: 1rem;
        }

        /* Tracking badge */
        .tracking-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary);
            border-radius: 9999px;
            font-size: 0.625rem;
            font-weight: 600;
        }

        .client-identifier {
            font-family: monospace;
            background: var(--light);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .usage-metric {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .usage-metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: var(--gray);
            font-size: 0.875rem;
        }

        .metric-value {
            font-weight: 600;
            color: var(--dark);
        }

        .code-block {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .code-block code {
            font-family: 'Courier New', monospace;
            color: #0066cc;
            font-size: 0.875rem;
        }

        .api-section {
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 2rem;
        }

        .api-section:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .code-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .code-tab {
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border: 1px solid #e2e8f0;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .code-tab.active {
            background: #0066cc;
            color: white;
            border-color: #0066cc;
        }

        .code-example {
            display: none;
            background: #1e293b;
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 0 8px 8px 8px;
            overflow-x: auto;
            margin: 0;
        }

        .code-example.active {
            display: block;
        }

        .code-example code {
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 0.8125rem;
            line-height: 1.6;
        }

        .json-viewer {
            background: #1e293b;
            border-radius: 8px;
            padding: 1rem;
            max-height: 500px;
            overflow: auto;
        }

        .json-viewer pre {
            margin: 0;
            color: #e2e8f0;
            font-size: 0.8125rem;
        }

        .json-viewer .json-key {
            color: #60a5fa;
        }

        .json-viewer .json-string {
            color: #86efac;
        }

        .json-viewer .json-number {
            color: #fbbf24;
        }

        .json-viewer .json-boolean {
            color: #c084fc;
        }

        .json-stats {
            display: flex;
            gap: 2rem;
            padding: 1rem;
            background: var(--light);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .json-stat {
            display: flex;
            flex-direction: column;
        }

        .json-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .json-stat-label {
            font-size: 0.75rem;
            color: var(--gray);
            text-transform: uppercase;
        }

        .info-row {
            display: flex;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .info-label {
            font-weight: 500;
            color: var(--gray);
            width: 140px;
            flex-shrink: 0;
        }

        .info-value {
            color: var(--dark);
        }

        .client-detail-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 1024px) {
            .client-detail-grid {
                grid-template-columns: 1fr;
            }
        }

        .revenue-calculator {
            background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
            color: var(--white);
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
        }

        .revenue-amount {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .revenue-period {
            opacity: 0.9;
            font-size: 1.125rem;
        }

        .revenue-breakdown {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .breakdown-item {
            text-align: center;
        }

        .breakdown-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .breakdown-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .session-grid {
                grid-template-columns: 1fr;
            }

            .header-content {
                padding: 1rem;
            }

            .content {
                padding: 1rem;
            }
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            z-index: 999;
        }

        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* Profile Modal Styles */
.profile-modal {
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
}

.profile-content {
    padding: 0;
}

.profile-avatar-section {
    display: flex;
    align-items: center;
    padding: 2rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px 12px 0 0;
    position: relative;
}

.profile-avatar {
    position: relative;
    margin-right: 1.5rem;
}

.avatar-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: 600;
    color: white;
    border: 3px solid rgba(255, 255, 255, 0.3);
}

.avatar-status {
    position: absolute;
    bottom: 5px;
    right: 5px;
}

.status-dot {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 2px solid white;
}

.status-dot.online {
    background: #10b981;
    animation: pulse-online 2s infinite;
}

.status-dot.offline {
    background: #ef4444;
}

@keyframes pulse-online {
    0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
    100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
}

.profile-basic-info h3 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
}

.profile-role {
    margin: 0.25rem 0 0 0;
    opacity: 0.9;
    font-size: 0.9rem;
}

.profile-details {
    padding: 2rem;
}

.detail-group {
    margin-bottom: 2rem;
}

.detail-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
    border-bottom: 1px solid #f1f5f9;
}

.detail-item:last-child {
    border-bottom: none;
}

.detail-label {
    font-weight: 500;
    color: #64748b;
    font-size: 0.9rem;
}

.detail-value {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 500;
}

.verified-badge {
    background: #10b981;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.auth-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-left: 1rem;
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.status-indicator.connected {
    background: #10b981;
    animation: pulse-online 2s infinite;
}

.status-indicator.disconnected {
    background: #ef4444;
}

.status-indicator.active {
    background: #3b82f6;
    animation: pulse-online 2s infinite;
}

.session-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.permissions-section, .security-section {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid #f1f5f9;
}

.permissions-section h4, .security-section h4 {
    margin: 0 0 1rem 0;
    color: #374151;
    font-size: 1rem;
}

.permissions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.permission-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    background: #f8fafc;
    border-radius: 8px;
}

.permission-icon {
    font-size: 1.25rem;
}

.permission-details {
    display: flex;
    flex-direction: column;
}

.permission-name {
    font-weight: 500;
    font-size: 0.9rem;
}

.permission-status {
    font-size: 0.75rem;
    font-weight: 500;
}

.permission-status.granted {
    color: #10b981;
}

.permission-status.denied {
    color: #ef4444;
}

.security-items {
    space-y: 0.75rem;
}

.security-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f1f5f9;
}

.security-item:last-child {
    border-bottom: none;
}

.security-label {
    font-weight: 500;
    color: #64748b;
    font-size: 0.9rem;
}

.security-status.disabled {
    color: #ef4444;
    font-weight: 500;
}

.security-status.enabled {
    color: #10b981;
    font-weight: 500;
}

.security-value {
    font-weight: 500;
}

.security-value.success {
    color: #10b981;
}

.profile-actions {
    display: flex;
    gap: 1rem;
    padding: 2rem;
    border-top: 1px solid #f1f5f9;
    background: #f8fafc;
}

.profile-actions .btn {
    flex: 1;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-secondary {
    background: #3b82f6;
    color: white;
    border: none;
}

.btn-secondary:hover {
    background: #2563eb;
}

.btn-outline {
    background: transparent;
    color: #64748b;
    border: 1px solid #cbd5e1;
}

.btn-outline:hover {
    background: #f1f5f9;
}

.btn-danger {
    background: #ef4444;
    color: white;
    border: none;
}

.btn-danger:hover {
    background: #dc2626;
}

@media (max-width: 768px) {
    .profile-modal {
        max-width: 95vw;
        margin: 1rem;
    }

    .permissions-grid {
        grid-template-columns: 1fr;
    }

    .profile-actions {
        flex-direction: column;
    }
}

        /* Fix modal header alignment */
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem 2rem 0 2rem;
    border-bottom: none;
}

.modal-close-btn {
    background: none;
    border: none;
    font-size: 2rem;
    cursor: pointer;
    color: rgba(255, 255, 255, 0.8);
    padding: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
}

.modal-close-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
}

.modal-title {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
    color: white;
}

/* Updated profile actions - single button centered */
.profile-actions {
    display: flex;
    justify-content: center;
    padding: 2rem;
    border-top: 1px solid #f1f5f9;
    background: #f8fafc;
}

.profile-actions .btn {
    min-width: 120px;
    padding: 0.75rem 2rem;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

/* Sign Out Modal Styles */
.sign-out-modal {
    max-width: 400px;
    text-align: center;
}

.sign-out-modal .modal-header {
    background: #f8fafc;
    color: #374151;
    padding: 1.5rem 2rem;
    border-radius: 12px 12px 0 0;
}

.sign-out-modal .modal-title {
    color: #374151;
    font-size: 1.25rem;
}

.sign-out-content {
    padding: 2rem;
}

.sign-out-icon {
    margin-bottom: 1rem;
}

.warning-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #fef3c7;
    color: #d97706;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin: 0 auto;
}

.sign-out-message p {
    margin: 0.5rem 0;
    color: #374151;
    font-weight: 500;
}

.sign-out-subtitle {
    color: #64748b !important;
    font-size: 0.9rem !important;
    font-weight: 400 !important;
}

.sign-out-actions {
    display: flex;
    gap: 1rem;
    padding: 0 2rem 2rem 2rem;
}

.sign-out-actions .btn {
    flex: 1;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

/* Remove the close button from profile modal background */
.profile-modal .modal-header {
    background: #ffffff;
background: linear-gradient(90deg, rgba(255, 255, 255, 1) 0%, rgba(255, 255, 255, 1) 100%);
    border-radius: 8px 8px 0 0;
}

    </style>
</head>
<body>
<div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <span>🏥</span>
                <span>BMJ Careers Admin</span>
            </div>
        </div>
        <nav class="sidebar-menu">
            <button class="menu-item active" onclick="showSection('dashboard')">
                <span class="menu-icon">📊</span>
                <span>Dashboard</span>
            </button>
            <button class="menu-item" onclick="showSection('sessions')">
                <span class="menu-icon">👥</span>
                <span>Live Sessions</span>
            </button>
            <button class="menu-item" onclick="showSection('clients')">
                <span class="menu-icon">🏢</span>
                <span>Clients</span>
            </button>
            <button class="menu-item" onclick="showSection('analytics')">
                <span class="menu-icon">📈</span>
                <span>Analytics</span>
            </button>
            <button class="menu-item" onclick="showSection('billing')">
                <span class="menu-icon">💷</span>
                <span>Billing</span>
            </button>
            <button class="menu-item" onclick="showSection('api')">
                <span class="menu-icon">🔑</span>
                <span>API Keys</span>
            </button>
            <button class="menu-item" onclick="showSection('activity')">
                <span class="menu-icon">⚡</span>
                <span>Activity Feed</span>
            </button>
            <button class="menu-item" onclick="showSection('jobsdata')">
                <span class="menu-icon">📋</span>
                <span>Jobs Data</span>
            </button>
            <button class="menu-item" onclick="showSection('updatejobs')">
                <span class="menu-icon">✏️</span>
                <span>Update Jobs</span>
            </button>
            <button class="menu-item" onclick="showSection('clientsdata')">
                <span class="menu-icon">📊</span>
                <span>Client Analytics</span>
            </button>
            <button class="menu-item" onclick="showSection('settings')">
                <span class="menu-icon">⚙️</span>
                <span>Settings</span>
            </button>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1 class="header-title" id="pageTitle">Dashboard</h1>
                <div class="header-actions">
                    <span class="real-time-indicator">
                        <span class="real-time-dot"></span>
                        <span>Live</span>
                    </span>
                    <div class="user-dropdown">
                        <div class="user-menu" onclick="toggleUserDropdown()">
                            <div class="user-avatar" id="userAvatar">A</div>
                            <span id="userName">Admin</span>
                            <span class="dropdown-arrow">▼</span>
                        </div>
                        <div class="user-dropdown-menu" id="userDropdownMenu">
                            <div class="dropdown-header">
                                <div class="user-email" id="userEmail">admin@bmj.com</div>
                                <div class="user-role">Administrator</div>
                            </div>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item" onclick="openProfileModal()">
                                <span class="dropdown-icon">👤</span>
                                Profile Settings
                            </a>
                            <a href="#" class="dropdown-item" onclick="logout()">
                                <span class="dropdown-icon">🚪</span>
                                Logout
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content -->
        <div class="content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section active">
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon primary">🏢</div>
                        <div class="stat-value" id="totalClients">0</div>
                        <div class="stat-label">Total Clients</div>
                        <div class="stat-change positive">
                            <span>↗ 12%</span> vs last month
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon success">👥</div>
                        <div class="stat-value" id="activeSessions">0</div>
                        <div class="stat-label">Active Sessions</div>
                        <div class="stat-change positive">
                            <span>↗ 8%</span> vs yesterday
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon warning">📊</div>
                        <div class="stat-value" id="totalPageViews">0</div>
                        <div class="stat-label">Page Views Today</div>
                        <div class="stat-change negative">
                            <span>↘ 3%</span> vs yesterday
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon info">💷</div>
                        <div class="stat-value" id="monthlyOwed">£0</div>
                        <div class="stat-label">Monthly Owed</div>
                        <div class="stat-change positive">
                            <span>↗ 25%</span> vs last month
                        </div>
                    </div>
                </div>

                <!-- Recent Sessions with Enhanced Tracking -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Recent Sessions</h2>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <span class="tracking-live">Tracking Active</span>
                            <button class="btn btn-secondary btn-sm" onclick="refreshDashboard()" style="display: flex; align-items: center; gap: 0.5rem;">
                                <span>🔄</span>
                                <span>Refresh</span>
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="showSection('sessions')">
                                View All
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="session-grid" id="recentSessions">
                            <!-- Sessions will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Usage Chart -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Usage Trends</h2>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-secondary active" onclick="updateUsageChart('7d')">7 Days</button>
                            <button class="btn btn-sm btn-secondary" onclick="updateUsageChart('30d')">30 Days</button>
                            <button class="btn btn-sm btn-secondary" onclick="updateUsageChart('90d')">90 Days</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="usageChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Live Sessions Section -->
            <section id="sessions" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Live Sessions Monitor</h2>
                        <div class="header-actions">
                            <span class="session-badge" id="sessionCount">0 Active</span>
                            <button class="btn btn-sm btn-secondary" onclick="refreshSessions()">
                                🔄 Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="sessionsContainer">
                            <!-- Live sessions will be loaded here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Clients Section -->
            <section id="clients" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Client Management</h2>
                        <input type="text"
                               class="form-input"
                               placeholder="Search clients..."
                               style="width: 300px; max-width: 100%;"
                               id="clientSearchInput"
                               onkeyup="searchClients(this.value)">
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>Domain</th>
                                    <th>Sessions</th>
                                    <th>Page Views</th>
                                    <th>Clicks</th>
                                    <th>Revenue</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="clientsTable">
                                <!-- Clients will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analytics" class="section">
                <div class="stats-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Session Distribution</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="sessionDistChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Revenue by Client Type</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">Widget Performance Metrics</h3>
                    </div>
                    <div class="card-body">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon primary">⚡</div>
                                <div class="stat-value" id="avgLoadTime">0ms</div>
                                <div class="stat-label">Avg Load Time</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon success">📊</div>
                                <div class="stat-value" id="avgSessionDuration">0m</div>
                                <div class="stat-label">Avg Session Duration</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon warning">🎯</div>
                                <div class="stat-value" id="conversionRate">0%</div>
                                <div class="stat-label">Click-through Rate</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon info">📈</div>
                                <div class="stat-value" id="engagementScore">0</div>
                                <div class="stat-label">Engagement Score</div>
                            </div>
                        </div>
                        <div class="chart-container" style="margin-top: 2rem;">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Billing Section -->
            <section id="billing" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Third Party Billing</h2>
                    </div>
                    <div class="card-body">
                        <div class="settings-form">
                            <div class="form-group">
                                <label class="form-label">Select Installation</label>
                                <select class="form-select" id="billingClient" onchange="loadClientBillingSettings()">
                                    <option value="">Select a client...</option>
                                </select>
                            </div>

                            <div id="clientBillingSettings" style="display: none;">
                                <div class="form-group">
                                    <label class="form-label">Cost Per Click (£)</label>
                                    <input type="number" class="form-input" id="clientCPC" value="0.50" step="0.01">
                                    <button class="btn btn-sm btn-secondary" onclick="saveClientCPC()">Save Rate</button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Billing Period</label>
                                <input type="month" class="form-input" id="billingMonth" max="${new Date().toISOString().slice(0, 7)}">
                            </div>

                            <button class="btn btn-primary" onclick="generateBillingReport()">
                                Generate Report
                            </button>
                        </div>

                        <div id="billingReport" style="display: none; margin-top: 2rem;">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title" id="reportTitle">Billing Report</h3>
                                    <div>
                                        <button class="btn btn-sm btn-secondary" onclick="exportBillingPDF()">
                                            📄 Export PDF
                                        </button>
                                        <button class="btn btn-sm btn-secondary" onclick="exportBillingCSV()">
                                            📊 Export CSV
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="revenue-calculator" style="background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);">
                                        <div class="revenue-amount" id="totalOwed">£0.00</div>
                                        <div class="revenue-period" id="billingPeriodText">Amount Owed</div>
                                        <div class="revenue-breakdown">
                                            <div class="breakdown-item">
                                                <div class="breakdown-value" id="totalClicks">0</div>
                                                <div class="breakdown-label">Total Clicks</div>
                                            </div>
                                            <div class="breakdown-item">
                                                <div class="breakdown-value" id="cpcRate">£0.00</div>
                                                <div class="breakdown-label">Rate per Click</div>
                                            </div>
                                            <div class="breakdown-item">
                                                <div class="breakdown-value" id="uniqueJobs">0</div>
                                                <div class="breakdown-label">Unique Jobs</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div style="margin-top: 2rem;">
                                        <h4 style="margin-bottom: 1rem;">Click Details by Job</h4>
                                        <div class="table-container">
                                            <table>
                                                <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Job Title</th>
                                                    <th>Job ID</th>
                                                    <th>Location</th>
                                                    <th>Clicks</th>
                                                    <th>Cost</th>
                                                </tr>
                                                </thead>
                                                <tbody id="billingDetailsTable">
                                                <!-- Details will be loaded here -->
                                                </tbody>
                                                <tfoot>
                                                <tr style="font-weight: 600; background: var(--light);">
                                                    <td colspan="4">Total</td>
                                                    <td id="footerTotalClicks">0</td>
                                                    <td id="footerTotalCost">£0.00</td>
                                                </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- API Keys Section -->
            <section id="api" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">API Key Management</h2>
                        <button class="btn btn-primary" onclick="showGenerateKeyModal()">
                            Generate New Key
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>API Key</th>
                                    <th>Created</th>
                                    <th>Usage</th>
                                    <th>Last Used</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="apiKeysTable">
                                <!-- API keys will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Code Examples Section -->
                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <h2 class="card-title">API Integration Examples</h2>
                    </div>
                    <div class="card-body">
                        <div class="api-section">
                            <h3 style="margin-bottom: 1rem;">Quick Start Guide</h3>
                            <p style="color: var(--gray); margin-bottom: 1rem;">
                                Use these code examples to integrate the BMJ Careers API into your application.
                                Replace <code>YOUR_API_KEY</code> with your actual API key.
                            </p>

                            <!-- Code Tabs -->
                            <div class="code-tabs">
                                <button class="code-tab active" onclick="showCodeExample('javascript')">JavaScript</button>
                                <button class="code-tab" onclick="showCodeExample('python')">Python</button>
                                <button class="code-tab" onclick="showCodeExample('curl')">cURL</button>
                                <button class="code-tab" onclick="showCodeExample('php')">PHP</button>
                            </div>

                            <!-- JavaScript Example -->
                            <pre class="code-example active" id="code-javascript"><code>// Fetch jobs using JavaScript
const API_KEY = 'YOUR_API_KEY';
const API_URL = '${window.location.origin}/api/v1/jobs';

async function fetchJobs() {
    try {
        const response = await fetch(API_URL, {
            headers: {
                'X-API-Key': API_KEY
            }
        });

        if (!response.ok) {
            throw new Error('API request failed');
        }

        const data = await response.json();
        console.log(`Found ${data.data.jobs.length} jobs`);

        // Process jobs
        data.data.jobs.forEach(job => {
            console.log(`${job.job_title} - ${job.location_description}`);
        });

        return data.data.jobs;
    } catch (error) {
        console.error('Error fetching jobs:', error);
    }
}

// Call the function
fetchJobs();</code></pre>

                            <!-- Python Example -->
                            <pre class="code-example" id="code-python" style="display: none;"><code>import requests

# API Configuration
API_KEY = 'YOUR_API_KEY'
API_URL = '${window.location.origin}/api/v1/jobs'

def fetch_jobs():
    """Fetch jobs from BMJ Careers API"""

    headers = {
        'X-API-Key': API_KEY
    }

    try:
        response = requests.get(API_URL, headers=headers)
        response.raise_for_status()

        data = response.json()
        jobs = data['data']['jobs']

        print(f"Found {len(jobs)} jobs")

        # Process jobs
        for job in jobs:
            print(f"{job['job_title']} - {job['location_description']}")

        return jobs

    except requests.exceptions.RequestException as e:
        print(f"Error fetching jobs: {e}")
        return None

# Call the function
if __name__ == "__main__":
    jobs = fetch_jobs()</code></pre>

                            <!-- cURL Example -->
                            <pre class="code-example" id="code-curl" style="display: none;"><code># Fetch jobs using cURL
curl -X GET "${window.location.origin}/api/v1/jobs" \
     -H "X-API-Key: YOUR_API_KEY" \
     -H "Content-Type: application/json"

# Pretty print the JSON response
curl -X GET "${window.location.origin}/api/v1/jobs" \
     -H "X-API-Key: YOUR_API_KEY" \
     -H "Content-Type: application/json" | python -m json.tool

# Save response to file
curl -X GET "${window.location.origin}/api/v1/jobs" \
     -H "X-API-Key: YOUR_API_KEY" \
     -H "Content-Type: application/json" \
     -o jobs.json</code></pre>

                            <!-- PHP Example -->
                            <pre class="code-example" id="code-php" style="display: none;"><code>&lt;?php
// API Configuration
$apiKey = 'YOUR_API_KEY';
$apiUrl = '${window.location.origin}/api/v1/jobs';

function fetchJobs($apiUrl, $apiKey) {
    // Initialize cURL
    $ch = curl_init();

    // Set cURL options
    curl_setopt($ch, CURLOPT_URL, $apiUrl);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, array(
        'X-API-Key: ' . $apiKey,
        'Content-Type: application/json'
    ));

    // Execute request
    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);

    // Check for errors
    if (curl_errno($ch)) {
        echo 'Error: ' . curl_error($ch);
        curl_close($ch);
        return null;
    }

    curl_close($ch);

    // Parse response
    if ($httpCode === 200) {
        $data = json_decode($response, true);
        $jobs = $data['data']['jobs'];

        echo "Found " . count($jobs) . " jobs\n";

        // Process jobs
        foreach ($jobs as $job) {
            echo $job['job_title'] . " - " . $job['location_description'] . "\n";
        }

        return $jobs;
    } else {
        echo "API request failed with status: " . $httpCode;
        return null;
    }
}

// Call the function
$jobs = fetchJobs($apiUrl, $apiKey);
?&gt;</code></pre>
                        </div>

                        <!-- API Response Format -->
                        <div class="api-section" style="margin-top: 2rem;">
                            <h3 style="margin-bottom: 1rem;">API Response Format</h3>
                            <pre class="code-example" style="display: block;"><code>{
    "success": true,
    "data": {
        "jobs": [
            {
                "id": 123456,
                "job_title": "Consultant Cardiologist",
                "location_description": "London, UK",
                "salary": "£93,666 - £126,281",
                "short_description": "Exciting opportunity for experienced consultant...",
                "job_url": "https://www.bmj.com/careers/job/123456",
                "sector": ["Cardiology", "Consultant"],
                "grade": "Consultant",
                "contract_type": "Permanent",
                "recruiter_name": "NHS Trust",
                "published": "Posted 2 days ago",
                "job_start_date": "2024-01-15",
                "job_end_date": "2024-02-15"
            }
            // ... more jobs
        ],
        "total": 150,
        "timestamp": "2024-01-10T14:30:00Z"
    },
    "meta": {
        "source": "synced",
        "cached": false
    }
}</code></pre>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Activity Feed Section -->
            <section id="activity" class="section">
                <div class="stats-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Page Loads</h3>
                            <span class="real-time-indicator">
                    <span class="real-time-dot"></span>
                    <span>Live</span>
                </span>
                        </div>
                        <div class="card-body">
                            <div class="activity-feed" id="loadsFeed">
                                <!-- Activity items will be loaded here -->
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Clicks</h3>
                            <span class="real-time-indicator">
                    <span class="real-time-dot"></span>
                    <span>Live</span>
                </span>
                        </div>
                        <div class="card-body">
                            <div class="activity-feed" id="clicksFeed">
                                <!-- Activity items will be loaded here -->
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">API Calls</h3>
                            <span class="real-time-indicator">
                    <span class="real-time-dot"></span>
                    <span>Live</span>
                </span>
                        </div>
                        <div class="card-body">
                            <div class="activity-feed" id="apiFeed">
                                <!-- Activity items will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Jobs Data Section -->
            <section id="jobsdata" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Jobs Data API</h2>
                    </div>
                    <div class="card-body">
                        <!-- Dynamic API Endpoints -->
                        <div class="api-section">
                            <h3 style="margin-bottom: 1rem;">API Endpoints</h3>

                            <!-- Public endpoint without auth -->
                            <div style="margin-bottom: 1rem;">
                                <h4 style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">Public Endpoint (No Authentication)</h4>
                                <div class="code-block">
                                    <code id="publicEndpoint"></code>
                                    <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('publicEndpoint')">
                                        Copy URL
                                    </button>
                                </div>
                            </div>

                            <!-- Authenticated endpoint -->
                            <div>
                                <h4 style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">Authenticated Endpoint (Requires API Key)</h4>
                                <div class="code-block">
                                    <code id="authEndpoint"></code>
                                    <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('authEndpoint')">
                                        Copy URL
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Jobs Data Preview -->
                        <div class="api-section" style="margin-top: 2rem;">
                            <h3 style="margin-bottom: 1rem;">Jobs Data Structure</h3>
                            <div class="json-controls">
                                <button class="btn btn-primary" onclick="loadJobsData()">
                                    Load Current Jobs
                                </button>
                                <button class="btn btn-secondary" onclick="downloadJobsData()">
                                    Download JSON
                                </button>
                                <button class="btn btn-secondary" onclick="refreshJobsData()">
                                    🔄 Refresh
                                </button>
                                <span id="jobsCount" style="align-self: center; color: var(--gray);">
                                    Click to load jobs data
                                </span>
                            </div>

                            <div class="json-stats" id="jobsStats" style="display: none;">
                                <div class="json-stat">
                                    <div class="json-stat-value" id="totalJobsCount">0</div>
                                    <div class="json-stat-label">Total Jobs</div>
                                </div>
                                <div class="json-stat">
                                    <div class="json-stat-value" id="newJobsCount">0</div>
                                    <div class="json-stat-label">New Jobs</div>
                                </div>
                                <div class="json-stat">
                                    <div class="json-stat-value" id="updatedJobsCount">0</div>
                                    <div class="json-stat-label">Updated</div>
                                </div>
                                <div class="json-stat">
                                    <div class="json-stat-value" id="dataSource">-</div>
                                    <div class="json-stat-label">Source</div>
                                </div>
                            </div>

                            <div class="json-viewer" id="jobsDataViewer" style="max-height: 400px; overflow-y: auto;">
                                <pre><code>// Jobs data will appear here</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Add this new section after jobsdata section -->
            <section id="updatejobs" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Update Jobs</h2>
                        <span id="dynamoStatusIndicator" class="session-badge">Checking...</span>
                    </div>
                    <div class="card-body">
                        <!-- Always visible search interface -->
                        <div id="jobUpdateInterface">
                            <div class="form-group">
                                <label class="form-label">Search Jobs</label>
                                <div style="display: flex; gap: 1rem;">
                                    <input type="text"
                                           class="form-input"
                                           id="jobSearchInput"
                                           placeholder="Enter Job ID or search term...">
                                    <select class="form-select" id="jobSearchField">
                                        <option value="id">Job ID</option>
                                        <option value="job_title">Job Title</option>
                                        <option value="recruiter_name">Recruiter Name</option>
                                        <option value="location_description">Location</option>
                                    </select>
                                    <button class="btn btn-primary" onclick="searchJobsLocal()">Search</button>
                                </div>
                            </div>

                            <div id="jobSearchResults" style="margin-top: 2rem; display: none;">
                                <h3>Search Results</h3>
                                <div id="jobResultsList"></div>
                            </div>

                            <div id="jobEditor" style="margin-top: 2rem; display: none;">
                                <h3>Edit Job Details</h3>
                                <div class="json-viewer" style="background: white; border: 1px solid #e2e8f0;">
                                    <div id="jobEditorFields"></div>
                                </div>
                                <div style="margin-top: 1rem;">
                                    <button class="btn btn-primary" id="syncButton" onclick="saveJobChanges()">
                                        Sync to DynamoDB
                                    </button>
                                    <button class="btn btn-secondary" onclick="cancelJobEdit()">
                                        Cancel
                                    </button>
                                </div>
                            </div>

                            <div id="dynamoUnavailable" style="display: none; margin-top: 1rem;">
                                <div style="padding: 1rem; background: #FFF5F5; border: 1px solid #FC8181; border-radius: 8px;">
                                    <strong style="color: #E53E3E;">⚠️ DynamoDB Connection Unavailable</strong>
                                    <p style="margin-top: 0.5rem; color: #666;">
                                        You can still search and view jobs, but changes cannot be synced to DynamoDB.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Clients Data Section -->
            <section id="clientsdata" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Client Usage Analytics</h2>
                        <span id="clientsDataStatus" class="session-badge">Initializing...</span>
                    </div>
                    <div class="card-body">
                        <!-- Report Generation -->
                        <div class="settings-form">
                            <h3 style="margin-bottom: 1rem;">Generate Usage Report</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Select Client</label>
                                    <select class="form-select" id="reportClient">
                                        <option value="">All Clients</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Report Type</label>
                                    <select class="form-select" id="reportType">
                                        <option value="daily">Daily</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly">Monthly</option>
                                        <option value="custom">Custom Range</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" class="form-input" id="reportStartDate">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">End Date</label>
                                    <input type="date" class="form-input" id="reportEndDate">
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="generateClientReport()">
                                Generate Report
                            </button>
                        </div>

                        <!-- Report Display -->
                        <div id="clientReportDisplay" style="display: none; margin-top: 2rem;">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title" id="clientReportTitle">Client Usage Report</h3>
                                    <div>
                                        <button class="btn btn-sm btn-secondary" onclick="exportClientReport('pdf')">
                                            📄 Export PDF
                                        </button>
                                        <button class="btn btn-sm btn-secondary" onclick="exportClientReport('csv')">
                                            📊 Export CSV
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Summary Stats -->
                                    <div class="stats-grid">
                                        <div class="stat-card">
                                            <div class="stat-icon primary">📊</div>
                                            <div class="stat-value" id="reportTotalViews">0</div>
                                            <div class="stat-label">Total Page Views</div>
                                        </div>
                                        <div class="stat-card">
                                            <div class="stat-icon success">👆</div>
                                            <div class="stat-value" id="reportTotalClicks">0</div>
                                            <div class="stat-label">BMJ Redirect Clicks</div>
                                        </div>
                                        <div class="stat-card">
                                            <div class="stat-icon warning">💷</div>
                                            <div class="stat-value" id="reportTotalRevenue">£0</div>
                                            <div class="stat-label">Total Revenue</div>
                                        </div>
                                        <div class="stat-card">
                                            <div class="stat-icon info">📈</div>
                                            <div class="stat-value" id="reportCTR">0%</div>
                                            <div class="stat-label">Click-through Rate</div>
                                        </div>
                                    </div>

                                    <!-- Daily Breakdown Table -->
                                    <div style="margin-top: 2rem;">
                                        <h4>Daily Breakdown</h4>
                                        <div class="table-container">
                                            <table>
                                                <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Client</th>
                                                    <th>Page Views</th>
                                                    <th>BMJ Clicks</th>
                                                    <th>CTR</th>
                                                    <th>Revenue</th>
                                                </tr>
                                                </thead>
                                                <tbody id="clientReportTable">
                                                <!-- Data will be loaded here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- Chart -->
                                    <div style="margin-top: 2rem;">
                                        <h4>Trend Analysis</h4>
                                        <div class="chart-container">
                                            <canvas id="clientTrendChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="section">
                <!-- System Health Card -->
                <div class="card" style="margin-bottom: 2rem;">
                    <div class="card-header">
                        <h2 class="card-title">System Health & Status</h2>
                        <button class="btn btn-primary btn-sm" onclick="checkSystemHealth()">
                            🔄 Check Status
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon success">🟢</div>
                                <div class="stat-value" id="systemStatus">Checking...</div>
                                <div class="stat-label">System Status</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon info">🗄️</div>
                                <div class="stat-value" id="dynamoStatus">Checking...</div>
                                <div class="stat-label">DynamoDB Status</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon warning">📡</div>
                                <div class="stat-value" id="feedSource">Checking...</div>
                                <div class="stat-label">Data Source</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon primary">⏱️</div>
                                <div class="stat-value" id="cacheAge">Checking...</div>
                                <div class="stat-label">Cache Age</div>
                            </div>
                        </div>

                        <!-- Detailed Status Information -->
                        <div style="margin-top: 2rem; padding: 1rem; background: var(--light); border-radius: 8px;">
                            <h4 style="margin-bottom: 1rem;">System Details</h4>
                            <div class="usage-metric">
                                <span class="metric-label">API Endpoint:</span>
                                <span class="metric-value" id="apiEndpoint">${window.location.origin}/api</span>
                            </div>
                            <div class="usage-metric">
                                <span class="metric-label">Jobs Widget API:</span>
                                <span class="metric-value" id="jobsWidgetApi">${window.location.origin}/bmj-careers-jobs-api</span>
                            </div>
                            <div class="usage-metric">
                                <span class="metric-label">Widget Version:</span>
                                <span class="metric-value">v2.0.0</span>
                            </div>
                            <div class="usage-metric">
                                <span class="metric-label">Tracking Protocol:</span>
                                <span class="metric-value">Enhanced Real-time v2</span>
                            </div>
                            <div class="usage-metric">
                                <span class="metric-label">Jobs Feed URL:</span>
                                <span class="metric-value" id="feedUrl">Loading...</span>
                            </div>
                            <div class="usage-metric">
                                <span class="metric-label">Total Jobs Cached:</span>
                                <span class="metric-value" id="totalJobsCached">0</span>
                            </div>
                            <div class="usage-metric">
                                <span class="metric-label">Last Sync Time:</span>
                                <span class="metric-value" id="lastSyncTime">Never</span>
                            </div>
                            <div class="usage-metric">
                                <span class="metric-label">Server Uptime:</span>
                                <span class="metric-value" id="serverUptime">Unknown</span>
                            </div>
                            <div class="usage-metric">
                                <span class="metric-label">Memory Usage:</span>
                                <span class="metric-value" id="memoryUsage">Unknown</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Existing Settings Card -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">System Settings</h2>
                    </div>
                    <div class="card-body">
                        <div class="settings-form">
                            <h3 style="margin-bottom: 1rem;">Tracking Settings</h3>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="trackInternalIPs" checked onchange="saveSettings()">
                                    Track Internal IPs
                                </label>
                                <div class="form-help">Track sessions from internal network IPs</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Session Timeout (minutes)</label>
                                <input type="number" class="form-input" id="sessionTimeout" value="30" onchange="saveSettings()">
                                <div class="form-help">Consider session ended after this many minutes of inactivity</div>
                            </div>

                            <h3 style="margin: 2rem 0 1rem;">Notification Settings</h3>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="enableNotifications" checked onchange="saveSettings()">
                                    Enable Real-time Notifications
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Alert Threshold (concurrent sessions)</label>
                                <input type="number" class="form-input" id="alertThreshold" value="100" onchange="saveSettings()">
                                <div class="form-help">Send alert when concurrent sessions exceed this number</div>
                            </div>

                            <h3 style="margin: 2rem 0 1rem;">Data Retention</h3>
                            <div class="form-group">
                                <label class="form-label">Keep Session Data For</label>
                                <select class="form-select" id="dataRetention" onchange="saveSettings()">
                                    <option value="7">7 days</option>
                                    <option value="30">30 days</option>
                                    <option value="90" selected>90 days</option>
                                    <option value="180">180 days</option>
                                    <option value="365">1 year</option>
                                </select>
                            </div>

                            <button class="btn btn-primary" onclick="exportAllData()">
                                Export All Data
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleSidebar()">☰</button>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast">
    <div class="toast-icon" id="toastIcon">✓</div>
    <div class="toast-content">
        <div class="toast-title" id="toastTitle">Success</div>
        <div class="toast-message" id="toastMessage">Operation completed successfully</div>
    </div>
</div>

<!-- Generate API Key Modal -->
<div class="modal" id="generateKeyModal">
    <div class="modal-content">
        <h2 style="margin-bottom: 1.5rem;">Generate API Key</h2>
        <form id="generateKeyForm" onsubmit="event.preventDefault(); submitGenerateKey();">
            <div class="form-group">
                <label class="form-label">Client Name</label>
                <input type="text" class="form-input" id="apiClientName" required>
            </div>
            <div class="form-group">
                <label class="form-label">Client ID</label>
                <input type="text" class="form-input" id="apiClientId" required>
                <div class="form-help">Use domain name or unique identifier</div>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button type="submit" class="btn btn-primary">Generate Key</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('generateKeyModal')">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Enhanced Client Details Modal -->
<div class="modal" id="clientDetailsModal">
    <div class="modal-content" style="max-width: 800px;">
        <h2 id="clientModalTitle" style="margin-bottom: 1.5rem;">Client Details</h2>
        <div id="clientModalContent">
            <!-- Client details will be loaded here -->
        </div>
        <button class="btn btn-secondary" onclick="closeModal('clientDetailsModal')" style="margin-top: 1.5rem;">
            Close
        </button>
    </div>
</div>

<!-- Profile Settings Modal -->
<div class="modal" id="profileModal">
    <div class="modal-content profile-modal">
        <div class="modal-header">
            <h2 class="modal-title">Profile Settings</h2>
            <button class="modal-close-btn" onclick="closeProfileModal()">&times;</button>
        </div>

        <div class="profile-content">
            <!-- User Avatar Section -->
            <div class="profile-avatar-section">
                <div class="profile-avatar">
                    <div class="avatar-circle" id="userAvatar">
                        <span id="userInitials">AD</span>
                    </div>
                    <div class="avatar-status">
                        <div class="status-dot online" id="userStatus"></div>
                    </div>
                </div>
                <div class="profile-basic-info">
                    <h3 id="profileUserName">Admin User</h3>
                    <p class="profile-role" id="profileUserRole">Administrator</p>
                </div>
            </div>

            <!-- User Details Section -->
            <div class="profile-details">
                <div class="detail-group">
                    <div class="detail-item">
                        <label class="detail-label">Email Address</label>
                        <div class="detail-value">
                            <span id="profileEmail">admin@bmj.com</span>
                            <span class="verified-badge">Verified</span>
                        </div>
                    </div>

                    <div class="detail-item">
                        <label class="detail-label">Authentication Method</label>
                        <div class="detail-value">
                            <span id="profileAuthMethod">Local Authentication</span>
                            <div class="auth-status" id="authStatus">
                                <div class="status-indicator connected" id="authStatusDot"></div>
                                <span id="authStatusText">Connected</span>
                            </div>
                        </div>
                    </div>

                    <div class="detail-item">
                        <label class="detail-label">User ID</label>
                        <div class="detail-value">
                            <span id="profileUserId">usr_12345</span>
                        </div>
                    </div>

                    <div class="detail-item">
                        <label class="detail-label">Account Created</label>
                        <div class="detail-value">
                            <span id="profileCreatedDate">January 15, 2024</span>
                        </div>
                    </div>

                    <div class="detail-item">
                        <label class="detail-label">Last Login</label>
                        <div class="detail-value">
                            <span id="profileLastLogin">2 minutes ago</span>
                        </div>
                    </div>

                    <div class="detail-item">
                        <label class="detail-label">Session Status</label>
                        <div class="detail-value">
                            <div class="session-status active">
                                <div class="status-indicator active"></div>
                                <span>Active Session</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Permissions Section -->
                <div class="permissions-section">
                    <h4>Permissions & Access</h4>
                    <div class="permissions-grid">
                        <div class="permission-item">
                            <div class="permission-icon">📊</div>
                            <div class="permission-details">
                                <span class="permission-name">Dashboard Access</span>
                                <span class="permission-status granted">Granted</span>
                            </div>
                        </div>

                        <div class="permission-item">
                            <div class="permission-icon">👥</div>
                            <div class="permission-details">
                                <span class="permission-name">User Management</span>
                                <span class="permission-status granted">Granted</span>
                            </div>
                        </div>

                        <div class="permission-item">
                            <div class="permission-icon">💰</div>
                            <div class="permission-details">
                                <span class="permission-name">Billing Access</span>
                                <span class="permission-status granted">Granted</span>
                            </div>
                        </div>

                        <div class="permission-item">
                            <div class="permission-icon">⚙️</div>
                            <div class="permission-details">
                                <span class="permission-name">System Settings</span>
                                <span class="permission-status granted">Granted</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Security Section -->
                <div class="security-section">
                    <h4>Security Information</h4>
                    <div class="security-items">
                        <div class="security-item">
                            <span class="security-label">Two-Factor Authentication</span>
                            <span class="security-status disabled" id="tfaStatus">Not Enabled</span>
                        </div>
                        <div class="security-item">
                            <span class="security-label">Password Last Changed</span>
                            <span class="security-value" id="passwordChanged">Today</span>
                        </div>
                        <div class="security-item">
                            <span class="security-label">Login Attempts (Last 24h)</span>
                            <span class="security-value success">1 successful</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="profile-actions">
                <button class="btn btn-danger" onclick="logoutUser()">
                    Sign Out
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Sign Out Confirmation Modal -->
<div class="modal" id="signOutModal">
    <div class="modal-content sign-out-modal">
        <div class="modal-header">
            <h3 class="modal-title">Sign Out</h3>
        </div>

        <div class="sign-out-content">
            <div class="sign-out-icon">
                <div class="warning-icon">⚠</div>
            </div>
            <div class="sign-out-message">
                <p>Are you sure you want to sign out of your account?</p>
                <p class="sign-out-subtitle">You will be redirected to the login page.</p>
            </div>
        </div>

        <div class="sign-out-actions">
            <button class="btn btn-secondary" onclick="closeSignOutModal()">
                Cancel
            </button>
            <button class="btn btn-danger" onclick="confirmSignOut()">
                Sign Out
            </button>
        </div>
    </div>
</div>
<script>
    // Global state - RESTORED ORIGINAL STRUCTURE
    let state = {
        clients: [],
        sessions: [],
        apiKeys: [],
        charts: {},
        jobsData: null,
        currentOrigin: window.location.origin,
        settings: {
            trackLocalhost: true,
            trackInternalIPs: true,
            sessionTimeout: 30,
            enableNotifications: true,
            alertThreshold: 100,
            dataRetention: 90
        },
        refreshInterval: null
    };

    // Enable test mode for local development
const TEST_MODE = true;  // Set to false in production
const TEST_CLIENT_ID = 'doctor-widget';
const TEST_CLIENT_NAME = 'The Doctor (Test)';

// Override for testing
if (TEST_MODE) {
    console.log('[BMJ Admin] TEST MODE ENABLED - Tracking localhost sessions');
}

    // Initialize dynamic endpoints - RESTORED
    function initializeDynamicEndpoints() {
        const origin = window.location.origin;

        // Update public endpoint
        document.getElementById('publicEndpoint').textContent = `${origin}/api/jobs`;

        // Update authenticated endpoint
        document.getElementById('authEndpoint').textContent = `${origin}/api/v1/jobs`;

        // Update all code examples dynamically
        updateCodeExamples(origin);
    }

    // Update code examples with current origin - RESTORED
    function updateCodeExamples(origin) {
        // This will be called when showing code tabs
        window.currentApiOrigin = origin;
    }

    // Enhanced authentication check - RESTORED
    const sessionToken = localStorage.getItem('sessionToken');
    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');

    if (!sessionToken || !userInfo.email) {
        // For development - create mock session
        localStorage.setItem('sessionToken', 'mock-session-' + Date.now());
        console.warn('No session token found, using mock token for development');
    }

    // Set user info - RESTORED
    document.getElementById('userName').textContent = userInfo.username || 'Admin';
    document.getElementById('userEmail').textContent = userInfo.email || 'admin@bmj.com';
    document.getElementById('userAvatar').textContent = (userInfo.username || 'Admin').charAt(0).toUpperCase();

    // Toggle user dropdown - RESTORED
    function toggleUserDropdown() {
        const dropdown = document.getElementById('userDropdownMenu');
        dropdown.classList.toggle('show');

        // Close dropdown when clicking outside
        document.addEventListener('click', function closeDropdown(e) {
            if (!e.target.closest('.user-dropdown')) {
                dropdown.classList.remove('show');
                document.removeEventListener('click', closeDropdown);
            }
        });
    }

    // Enhanced logout function - RESTORED
    async function logout() {
        try {
            await fetch('/api/auth/logout', {
                method: 'POST',
                headers: {
                    'x-session-token': sessionToken
                }
            });

            localStorage.removeItem('sessionToken');
            localStorage.removeItem('userInfo');
            window.location.href = state.currentOrigin;
        } catch (error) {
            console.error('Logout error:', error);
            localStorage.clear();
            window.location.href = '/';
        }
    }

    // Initialize on DOM load - RESTORED
    document.addEventListener('DOMContentLoaded', () => {
        initializeDynamicEndpoints();
        loadSettings();
        loadSettingsUI();
        initializeAllCharts();
        setupTrackingListener();
        loadDashboard();
        startRealTimeUpdates();
         updateMetricsRealTime();
         connectWebSocket();

        // Add sidebar overlay
        const overlay = document.createElement('div');
        overlay.className = 'sidebar-overlay';
        overlay.onclick = () => toggleSidebar();
        document.body.appendChild(overlay);
    });

    // Initialize charts - RESTORED ORIGINAL
    function initializeCharts() {
        // Usage Chart
        const usageCtx = document.getElementById('usageChart').getContext('2d');
        state.charts.usage = new Chart(usageCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Page Views',
                    data: [],
                    borderColor: '#0066cc',
                    backgroundColor: 'rgba(0, 102, 204, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Job Clicks',
                    data: [],
                    borderColor: '#FFC000',
                    backgroundColor: 'rgba(255, 192, 0, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Sessions',
                    data: [],
                    borderColor: '#48bb78',
                    backgroundColor: 'rgba(72, 187, 120, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                if (context.dataset.label === 'Job Clicks') {
                                    return 'Revenue: £' + (context.parsed.y * 0.50).toFixed(2);
                                }
                                return '';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }


    async function loadDashboard() {
        try {
            const response = await fetch('/api/admin/dashboard', {
                headers: {
                    'x-session-token': sessionToken
                }
            });

            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = '/login?redirect=/admin';
                    return;
                }
                throw new Error('Failed to load dashboard');
            }

            const data = await response.json();

            // Log raw data for debugging
            console.log('Dashboard API response:', data);

            // Process the data - will filter out localhost
            processDashboardData(data.data || { clients: [], sessions: [], apiKeys: [] });
            await loadEnhancedTrackingData();
            updateDashboard();

            // Show appropriate message
            if (state.sessions.length > 0) {
                showToast(`Dashboard loaded: ${state.clients.length} clients active`, 'success');
            } else {
                console.log('No client sessions found - only client_id based sessions are shown');
            }

        } catch (error) {
            console.error('Dashboard error:', error);
            // Initialize with empty data
            processDashboardData({ clients: [], sessions: [], apiKeys: [] });
            await loadEnhancedTrackingData();
            updateDashboard();
        }
    }

function setupTrackingListener() {
    // Global counters for accurate tracking
    window.trackingData = window.trackingData || {};

    window.addEventListener('message', function(event) {
        if (!event.data || typeof event.data !== 'object') return;

        // Handle all tracking events
        if (event.data.type === 'bmj-careers-tracking' ||
            event.data.type === 'bmj-careers-job-click' ||
            event.data.type === 'bmj-careers-page-view') {

            let clientId = event.data.clientId || event.data.client_id || TEST_CLIENT_ID;

            // Initialize tracking for this client
            if (!window.trackingData[clientId]) {
                window.trackingData[clientId] = {
                    pageViews: 0,
                    clicks: 0,
                    jobDetails: []
                };
            }

            // Ensure client and session exist
            let client = state.clients.find(c => c.clientId === clientId);
            let session = state.sessions.find(s => s.clientIdentifier === clientId);

            if (!client || !session) {
                // Create them if they don't exist
                createClientSession(clientId);
                client = state.clients.find(c => c.clientId === clientId);
                session = state.sessions.find(s => s.clientIdentifier === clientId);
            }

            // Handle different event types
            if (event.data.eventType === 'page_view' || event.data.eventType === 'heartbeat') {
                window.trackingData[clientId].pageViews++;

                // Update all metrics
                client.totalMetrics.loads = window.trackingData[clientId].pageViews;
                client.todayMetrics.loads = window.trackingData[clientId].pageViews;
                session.totalMetrics.loads = window.trackingData[clientId].pageViews;
                session.todayMetrics.loads = window.trackingData[clientId].pageViews;

                console.log(`📄 Page view #${window.trackingData[clientId].pageViews} for ${clientId}`);
            }

            if (event.data.eventType === 'job_click' || event.data.type === 'bmj-careers-job-click') {
                window.trackingData[clientId].clicks++;

                // Store job details for billing
                window.trackingData[clientId].jobDetails.push({
                    timestamp: new Date().toISOString(),
                    jobId: event.data.data?.jobId || 'unknown',
                    jobTitle: event.data.data?.jobTitle || 'Unknown Job',
                    location: event.data.data?.location || 'Unknown'
                });

                // Update all metrics
                client.totalMetrics.clicks = window.trackingData[clientId].clicks;
                client.todayMetrics.clicks = window.trackingData[clientId].clicks;
                session.totalMetrics.clicks = window.trackingData[clientId].clicks;
                session.todayMetrics.clicks = window.trackingData[clientId].clicks;

                // Update revenue
                const cpc = clientCPCRates[clientId] || 0.50;
                session.revenue = window.trackingData[clientId].clicks * cpc;
                client.totalMetrics.revenue = session.revenue;

                console.log(`🎯 Click #${window.trackingData[clientId].clicks} for ${clientId}`);
            }

            // Update last seen
            session.lastSeen = new Date().toISOString();
            session.isActive = true;
            session.duration = calculateDuration(session);

            // IMMEDIATE UI UPDATE
            updateAllUI();
        }
    });

    // Auto-refresh every 2 seconds
    setInterval(() => {
        const activeSection = document.querySelector('.section.active');
        if (activeSection && activeSection.id === 'dashboard') {
            updateAllUI();
        }
    }, 2000);

    console.log('✅ Real-time tracking listener initialized');
}

function updateAllUI() {
    updateDashboard();
    updateRecentSessions();
    updateUsageChart('7d');

    const activeSection = document.querySelector('.section.active');
    if (activeSection) {
        switch(activeSection.id) {
            case 'sessions':
                loadSessions();
                break;
            case 'clients':
                loadClients();
                break;
            case 'analytics':
                updateAnalyticsMetrics();
                break;
            case 'activity':
                loadActivity();
                break;
        }
    }
}

function createClientSession(clientId) {
    const clientName = TEST_MODE ? TEST_CLIENT_NAME : clientId;

    const client = {
        clientId: clientId,
        name: clientName,
        domain: 'Embedded Widget',
        isIframe: true,
        isTestEnvironment: TEST_MODE,
        sessions: [],
        sessionCount: 1,
        totalMetrics: { loads: 0, clicks: 0, apiCalls: 0, revenue: 0 },
        todayMetrics: { loads: 0, clicks: 0, apiCalls: 0 }
    };

    const session = {
        clientIdentifier: clientId,
        client_id: clientId,
        client_name: clientName,
        displayName: clientName,
        sessionId: `${clientId}_${Date.now()}`,
        domain: 'Embedded Widget',
        isIframe: true,
        isTestEnvironment: TEST_MODE,
        isActive: true,
        totalMetrics: { loads: 0, clicks: 0, apiCalls: 0 },
        todayMetrics: { loads: 0, clicks: 0, apiCalls: 0 },
        firstSeen: new Date().toISOString(),
        lastSeen: new Date().toISOString(),
        duration: '0s',
        revenue: 0,
        sessionCount: 1,
        metrics: { daily: {} }
    };

    state.clients.push(client);
    state.sessions.push(session);
}

    function processDashboardData(data) {
    console.log('Raw dashboard data received:', data);

    const rawSessions = data.clients || data.sessions || [];
    const clientMap = {};

    rawSessions.forEach(session => {
        let clientKey = null;
        let clientName = null;

        // Priority 1: Use client_id if available
        if (session.client_id && session.client_id !== 'unknown') {
            clientKey = session.client_id;
            clientName = session.client_name || session.client_id;
        }
        // Priority 2: Use utm_source (INCLUDING localhost for testing)
        else if (session.utm_source) {
            clientKey = session.utm_source;
            clientName = session.name || session.utm_source;

            // For local testing, use the configured client ID
            if (session.utm_source === 'localhost' || session.utm_source === 'direct') {
                clientKey = 'doctor-widget';  // Use the test client ID
                clientName = 'The Doctor (Test)';
            }
        }

        // Don't skip any sessions during testing
        if (!clientKey) {
            clientKey = 'doctor-widget';  // Default to test client
            clientName = 'The Doctor (Test)';
        }

        if (!clientKey) return;

        if (!clientMap[clientKey]) {
            clientMap[clientKey] = {
                clientId: clientKey,
                clientName: clientName,
                client_id: clientKey,
                client_name: clientName,
                displayName: clientName,
                domain: (session.domain === 'localhost' || session.domain === '127.0.0.1') ? 'Test Environment' : 'Embedded Widget',
                isTestEnvironment: session.domain === 'localhost' || session.domain === '127.0.0.1',
                isIframe: true,
                totalMetrics: {
                    loads: 0,
                    clicks: 0,
                    apiCalls: 0
                },
                todayMetrics: {
                    loads: 0,
                    clicks: 0,
                    apiCalls: 0
                },
                firstSeen: null,
                lastSeen: null,
                rawSessions: []
            };
        }

        const client = clientMap[clientKey];

        // CRITICAL FIX: Look for tracking data in session
        if (session.trackingData) {
            client.totalMetrics.loads += parseInt(session.trackingData.pageViews || 0);
            client.totalMetrics.clicks += parseInt(session.trackingData.jobClicks || 0);
            client.todayMetrics.loads += parseInt(session.trackingData.todayViews || 0);
            client.todayMetrics.clicks += parseInt(session.trackingData.todayClicks || 0);
        }

        // Also aggregate from standard fields
        client.totalMetrics.loads += parseInt(session.loads || session.totalLoads || session.pageViews || session.page_views || 0);
        client.totalMetrics.clicks += parseInt(session.clicks || session.totalClicks || session.jobClicks || session.job_clicks || 0);
        client.totalMetrics.apiCalls += parseInt(session.apiCalls || session.totalApiCalls || session.api_calls || 0);

        client.todayMetrics.loads += parseInt(session.todayLoads || session.todayPageViews || session.today_loads || 0);
        client.todayMetrics.clicks += parseInt(session.todayClicks || session.todayJobClicks || session.today_clicks || 0);
        client.todayMetrics.apiCalls += parseInt(session.todayApiCalls || session.today_api_calls || 0);

        const sessionFirstSeen = session.firstSeen || session.createdAt || session.created_at;
        if (sessionFirstSeen && (!client.firstSeen || new Date(sessionFirstSeen) < new Date(client.firstSeen))) {
            client.firstSeen = sessionFirstSeen;
        }

        const sessionLastSeen = session.lastSeen || session.updatedAt || session.updated_at || new Date().toISOString();
        if (!client.lastSeen || new Date(sessionLastSeen) > new Date(client.lastSeen)) {
            client.lastSeen = sessionLastSeen;
        }

        client.rawSessions.push(session);
    });

        // Convert client map to arrays for state
        state.clients = [];
        state.sessions = [];

        Object.values(clientMap).forEach(client => {
            // Ensure we have valid timestamps
            if (!client.firstSeen) client.firstSeen = new Date().toISOString();
            if (!client.lastSeen) client.lastSeen = new Date().toISOString();

            // Calculate derived values
            const duration = calculateDuration({
                firstSeen: client.firstSeen,
                lastSeen: client.lastSeen
            });

            const isActive = isSessionActive({ lastSeen: client.lastSeen });

            const revenue = calculateSessionRevenue({
                totalMetrics: client.totalMetrics
            });

            // Create the aggregated session object
            const aggregatedSession = {
                // Identity
                clientIdentifier: client.clientId,
                client_id: client.clientId,
                client_name: client.clientName,
                displayName: client.displayName,
                sessionId: `${client.clientId}_aggregated`,

                // Status
                domain: client.domain,
                isIframe: true,
                isTestEnvironment: client.isTestEnvironment,
                isActive: isActive,

                // Metrics - ensure these are the aggregated totals
                totalMetrics: {
                    loads: client.totalMetrics.loads,
                    clicks: client.totalMetrics.clicks,
                    apiCalls: client.totalMetrics.apiCalls
                },
                todayMetrics: {
                    loads: client.todayMetrics.loads,
                    clicks: client.todayMetrics.clicks,
                    apiCalls: client.todayMetrics.apiCalls
                },

                // Timing
                firstSeen: client.firstSeen,
                lastSeen: client.lastSeen,
                duration: duration,

                // Other
                revenue: revenue,
                sessionCount: client.rawSessions.length,
                metrics: { daily: {} }
            };

            // Add to sessions
            state.sessions.push(aggregatedSession);

            // Create client object
            state.clients.push({
                clientId: client.clientId,
                name: client.displayName,
                domain: client.domain,
                isIframe: true,
                isTestEnvironment: client.isTestEnvironment,
                sessions: [aggregatedSession],
                sessionCount: client.rawSessions.length,
                totalMetrics: {
                    loads: client.totalMetrics.loads,
                    clicks: client.totalMetrics.clicks,
                    apiCalls: client.totalMetrics.apiCalls,
                    revenue: revenue
                },
                rawSessions: client.rawSessions // Keep raw sessions for detailed view
            });
        });

        state.apiKeys = data.publicApiKeys || data.apiKeys || [];

        console.log('Final aggregated state:', {
            clients: state.clients,
            sessions: state.sessions,
            clientCount: state.clients.length,
            sessionCount: state.sessions.length
        });

        // Log metrics for debugging
        state.clients.forEach(client => {
            console.log(`Client: ${client.name} (${client.clientId})`);
            console.log(`  - Page Views: ${client.totalMetrics.loads}`);
            console.log(`  - Clicks: ${client.totalMetrics.clicks}`);
            console.log(`  - Sessions: ${client.sessionCount}`);
        });
    }

    async function refreshDashboard() {
    // Show loading state
    const btn = event.target.closest('.btn');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span>⏳</span> <span>Refreshing...</span>';
    }

    try {
        // Reload dashboard data
        await loadDashboard();

        // Force update all metrics
        updateRecentSessions();
        updateUsageChart('7d');

        // Update stats
        const totalClicks = state.sessions.reduce((sum, s) => sum + (s.totalMetrics?.clicks || 0), 0);
        const totalViews = state.sessions.reduce((sum, s) => sum + (s.totalMetrics?.loads || 0), 0);

        console.log(`[REFRESH] Total Clicks: ${totalClicks}, Total Views: ${totalViews}`);

        showToast(`Dashboard refreshed - ${totalClicks} clicks tracked`, 'success');
    } catch (error) {
        console.error('Refresh error:', error);
        showToast('Failed to refresh dashboard', 'error');
    } finally {
        // Reset button
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<span>🔄</span> <span>Refresh</span>';
        }
    }
}


// Real-time metrics update function
function updateMetricsRealTime() {
    // Poll for real-time updates every 5 seconds
    setInterval(async () => {
        try {
            const response = await fetch('/api/admin/realtime-metrics', {
                headers: { 'x-session-token': sessionToken }
            });

            if (response.ok) {
                const data = await response.json();

                // Update each client's metrics in real-time
                data.metrics.forEach(metric => {
                    const client = state.clients.find(c => c.clientId === metric.clientId);
                    if (client) {
                        // Update totals
                        client.totalMetrics.loads = metric.totalLoads || client.totalMetrics.loads;
                        client.totalMetrics.clicks = metric.totalClicks || client.totalMetrics.clicks;

                        // Update corresponding session
                        const session = state.sessions.find(s => s.clientIdentifier === metric.clientId);
                        if (session) {
                            session.totalMetrics.loads = metric.totalLoads || session.totalMetrics.loads;
                            session.totalMetrics.clicks = metric.totalClicks || session.totalMetrics.clicks;
                            session.todayMetrics.loads = metric.todayLoads || session.todayMetrics.loads;
                            session.todayMetrics.clicks = metric.todayClicks || session.todayMetrics.clicks;
                        }
                    }
                });

                // Update UI elements if visible
                const activeSection = document.querySelector('.section.active');
                if (activeSection) {
                    if (activeSection.id === 'dashboard') {
                        updateRecentSessions();
                        updateUsageChart('7d');
                    } else if (activeSection.id === 'sessions') {
                        loadSessions();
                    } else if (activeSection.id === 'clients') {
                        loadClients();
                    }
                }
            }
        } catch (error) {
            console.error('Real-time update error:', error);
        }
    }, 5000);
}


function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

    ws.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            if (data.type === 'tracking-update') {
                // Update the specific client's metrics
                const client = state.clients.find(c => c.clientId === data.clientId);
                if (client) {
                    if (data.event === 'job_click') {
                        client.totalMetrics.clicks++;
                        client.todayMetrics.clicks++;
                    } else if (data.event === 'page_view') {
                        client.totalMetrics.loads++;
                        client.todayMetrics.loads++;
                    }

                    // Update UI if on dashboard
                    const activeSection = document.querySelector('.section.active');
                    if (activeSection && activeSection.id === 'dashboard') {
                        updateDashboard();
                    }
                }
            }
        } catch (error) {
            console.error('WebSocket message error:', error);
        }
    };

    ws.onerror = () => {
        // Reconnect after 5 seconds
        setTimeout(connectWebSocket, 5000);
    };
}

    async function debugDashboard() {
        try {
            const response = await fetch('/api/admin/dashboard', {
                headers: {
                    'x-session-token': sessionToken
                }
            });

            const data = await response.json();
            console.log('Raw API Response:', data);

            if (data.data && data.data.clients) {
                data.data.clients.forEach(client => {
                    console.log('Client data:', {
                        client_id: client.client_id,
                        clientId: client.clientId,
                        utm_source: client.utm_source,
                        utm_medium: client.utm_medium,
                        client_name: client.client_name,
                        domain: client.domain,
                        clicks: client.clicks || 0,
                        loads: client.loads || 0
                    });
                });
            }
        } catch (error) {
            console.error('Debug error:', error);
        }
    }

    // Extract client identifier from session - RESTORED
    function extractClientIdentifier(session) {
        // ONLY use client_id - nothing else
        if (session.client_id && session.client_id !== 'unknown') {
            return session.client_id;
        }

        // Check alternative field names
        if (session.clientId && session.clientId !== 'unknown') {
            return session.clientId;
        }

        // Check UTM source as last resort (but not localhost)
        if (session.utm_source &&
            session.utm_source !== 'direct' &&
            session.utm_source !== 'localhost' &&
            session.utm_source !== '127.0.0.1') {
            return session.utm_source;
        }

        // Return null for anything else (will be filtered out)
        return null;
    }

    // Calculate session duration - RESTORED
    function calculateDuration(session) {
        const start = new Date(session.firstSeen);
        const end = new Date(session.lastSeen);
        const diff = end - start;

        const hours = Math.floor(diff / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);

        if (hours > 0) return `${hours}h ${minutes}m`;
        if (minutes > 0) return `${minutes}m ${seconds}s`;
        return `${seconds}s`;
    }

    // Check if session is active - RESTORED
    function isSessionActive(session) {
        const lastSeen = new Date(session.lastSeen);
        const now = new Date();
        const diffMinutes = (now - lastSeen) / 60000;
        return diffMinutes < state.settings.sessionTimeout;
    }

    // Calculate session revenue - ONLY count BMJ redirect clicks
function calculateSessionRevenue(session) {
    const loads = session.totalMetrics?.loads || 0;
    const clicks = session.totalMetrics?.clicks || 0; // Only BMJ redirect clicks
    const apiCalls = session.totalMetrics?.apiCalls || 0;

    // Pricing based on BMJ redirect clicks only
    const costPerView = 0.02;
    const costPerClick = 0.50; // Cost per BMJ redirect click
    const costPerSession = 0.10;
    const costPerApi = 0.05;

    return (loads * costPerView) + (clicks * costPerClick) + (apiCalls * costPerApi) + costPerSession;
}

    // Client CPC rates storage - RESTORED
    let clientCPCRates = JSON.parse(localStorage.getItem('clientCPCRates') || '{}');


function updateDashboard() {
    // Update stats with actual data
    const activeSessions = state.sessions.filter(s => s.isActive).length;
    const totalPageViews = state.sessions.reduce((sum, s) => sum + (s.totalMetrics?.loads || 0), 0);
    const totalClicks = state.sessions.reduce((sum, s) => sum + (s.totalMetrics?.clicks || 0), 0);

    // Calculate monthly owed based on actual BMJ redirect clicks
    const monthlyOwed = state.sessions.reduce((sum, s) => {
        const clientCPC = clientCPCRates[s.clientIdentifier] || 0.50;
        const clicks = s.totalMetrics?.clicks || 0;
        return sum + (clicks * clientCPC);
    }, 0);

    document.getElementById('totalClients').textContent = state.clients.length;
    document.getElementById('activeSessions').textContent = activeSessions;
    document.getElementById('totalPageViews').textContent = totalPageViews.toLocaleString();
    document.getElementById('monthlyOwed').textContent = `£${monthlyOwed.toFixed(2)}`;

    // Log for debugging
    console.log('[BMJ Admin] Dashboard updated - Total clicks:', totalClicks, 'Total views:', totalPageViews);

    updateRecentSessions();

    if (state.charts && state.charts.usage && state.sessions.length > 0) {
        updateAllCharts();
    }

    // Update other sections if visible
    if (document.getElementById('clientsTable')) {
        loadClients();
    }
}

    // Add this function to integrate enhanced tracking data - RESTORED
    async function loadEnhancedTrackingData() {
        try {
            const response = await fetch('/api/admin/enhanced-tracking', {
                headers: {
                    'x-session-token': sessionToken
                }
            });

            if (response.ok) {
                const data = await response.json();

                // Merge enhanced tracking with existing client data
                data.sessions.forEach(session => {
                    const existingClient = state.clients.find(c =>
                        c.clientId === session.clientId ||
                        c.name === session.clientName
                    );

                    if (existingClient) {
                        // Update with real-time data
                        existingClient.realTimeClicks = session.realTimeData?.jobClicks || 0;
                        existingClient.billableEvents = session.realTimeData?.billableEvents || 0;
                        existingClient.billingMetrics = session.billingMetrics || {};
                    }
                });

                updateDashboard();
            }
        } catch (error) {
            console.error('Enhanced tracking load error:', error);
        }
    }

function updateRecentSessions() {
    const container = document.getElementById('recentSessions');

    // Get click counts from activity feed if available
    const activityClicks = document.querySelectorAll('#clicksFeed .activity-item').length;

    const recentSessions = state.sessions
        .sort((a, b) => new Date(b.lastSeen) - new Date(a.lastSeen))
        .slice(0, 6);

    if (recentSessions.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">👥</div>
                <div class="empty-state-title">No sessions yet</div>
                <div class="empty-state-description">Sessions will appear here when clients connect</div>
            </div>
        `;
        return;
    }

    container.innerHTML = recentSessions.map(session => {
        // CRITICAL: Use activity feed count if session clicks are 0
        if (session.totalMetrics.clicks === 0 && activityClicks > 0) {
            session.totalMetrics.clicks = activityClicks;
            session.todayMetrics.clicks = activityClicks;

            // Update revenue based on actual clicks
            const cpc = clientCPCRates[session.clientIdentifier] || 0.50;
            session.revenue = activityClicks * cpc;
        }

        return `
            <div class="session-card ${session.isActive ? 'active' : ''}">
                <div class="session-header">
                    <div>
                        <div class="session-client">
                            ${session.displayName || session.client_name || 'Unknown'}
                            <span class="tracking-badge">Widget</span>
                            ${session.isTestEnvironment ? '<span class="tracking-badge iframe-indicator">Test</span>' : ''}
                        </div>
                        <div class="client-identifier">${session.clientIdentifier}</div>
                        ${session.sessionCount > 1 ? `
                            <div style="font-size: 0.625rem; color: var(--gray); margin-top: 0.25rem;">
                                ${session.sessionCount} page refreshes
                            </div>
                        ` : ''}
                    </div>
                    <span class="session-badge ${session.isActive ? 'active' : 'ended'}">
                        ${session.isActive ? '● Active' : '○ Ended'}
                    </span>
                </div>
                <div class="session-metrics">
                    <div class="metric-mini">
                        <div class="metric-mini-value">${session.totalMetrics?.loads || 0}</div>
                        <div class="metric-mini-label">PAGE VIEWS</div>
                    </div>
                    <div class="metric-mini" style="background: #FFF5F5; border: 2px solid #f56565;">
                        <div class="metric-mini-value" style="color: #f56565; font-weight: 700;">
                            ${session.totalMetrics?.clicks || 0}
                        </div>
                        <div class="metric-mini-label" style="color: #f56565; font-weight: 600;">BMJ CLICKS</div>
                    </div>
                    <div class="metric-mini">
                        <div class="metric-mini-value">${session.duration}</div>
                        <div class="metric-mini-label">DURATION</div>
                    </div>
                    <div class="metric-mini" style="background: #e6f2ff;">
                        <div class="metric-mini-value" style="color: var(--primary); font-weight: 700;">
                            £${((session.totalMetrics?.clicks || 0) * 0.50).toFixed(2)}
                        </div>
                        <div class="metric-mini-label" style="font-weight: 600;">OWED</div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

    // Initialize charts function - RESTORED
    function initializeAllCharts() {
        // Call existing initializeCharts first
        initializeCharts();

        // Session Distribution Chart
        const sessionDistCtx = document.getElementById('sessionDistChart');
        if (sessionDistCtx) {
            state.charts.sessionDist = new Chart(sessionDistCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Direct', 'iFrame', 'API'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#0066cc', '#48bb78', '#FFC000']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Revenue Chart
        const revenueCtx = document.getElementById('revenueChart');
        if (revenueCtx) {
            state.charts.revenue = new Chart(revenueCtx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Revenue (£)',
                        data: [],
                        backgroundColor: '#0066cc'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '£' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Geographic Chart
        const geoCtx = document.getElementById('geoChart');
        if (geoCtx) {
            state.charts.geo = new Chart(geoCtx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Sessions by Region',
                        data: [],
                        backgroundColor: '#0066cc'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y'
                }
            });
        }

        // Performance Chart
const performanceCtx = document.getElementById('performanceChart');
if (performanceCtx) {
    state.charts.performance = new Chart(performanceCtx.getContext('2d'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Load Time (ms)',
                data: [],
                borderColor: '#0066cc',
                backgroundColor: 'rgba(0, 102, 204, 0.1)',
                yAxisID: 'y1'
            }, {
                label: 'Engagement Score',
                data: [],
                borderColor: '#48bb78',
                backgroundColor: 'rgba(72, 187, 120, 0.1)',
                yAxisID: 'y2'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'left'
                },
                y2: {
                    type: 'linear',
                    display: true,
                    position: 'right'
                }
            }
        }
    });
}
    }

    // Update charts function - RESTORED
    function updateCharts() {
        updateUsageChart('7d');
    }

    function updateUsageChart(period) {
    let days;
    switch(period) {
        case '7d': days = 7; break;
        case '30d': days = 30; break;
        case '90d': days = 90; break;
        default: days = 7;
    }

    const dates = [];
    const viewsData = [];
    const clicksData = [];
    const sessionsData = [];

    for (let i = days - 1; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateKey = date.toISOString().split('T')[0];
        dates.push(date.toLocaleDateString('en-GB', { month: 'short', day: 'numeric' }));

        let dayViews = 0, dayClicks = 0, daySessions = 0;

        state.sessions.forEach(session => {
            if (i === 0) {
                // Today's data - use todayMetrics
                dayViews += session.todayMetrics?.loads || 0;
                dayClicks += session.todayMetrics?.clicks || 0;
                if (session.isActive) daySessions++;
            } else {
                // Historical data
                const sessionDate = new Date(session.firstSeen);
                const sessionDateKey = sessionDate.toISOString().split('T')[0];
                if (sessionDateKey === dateKey) {
                    dayViews += session.totalMetrics?.loads || 0;
                    dayClicks += session.totalMetrics?.clicks || 0;
                    daySessions++;
                }
            }
        });

        viewsData.push(dayViews);
        clicksData.push(dayClicks);
        sessionsData.push(daySessions);
    }

    if (state.charts.usage) {
        state.charts.usage.data.labels = dates;
        state.charts.usage.data.datasets[0].data = viewsData;
        state.charts.usage.data.datasets[1].data = clicksData;
        state.charts.usage.data.datasets[2].data = sessionsData;
        state.charts.usage.update();
    }
}

    // Helper functions - RESTORED
    function getLastNDays(n) {
        const days = [];
        for (let i = n - 1; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
           days.push(date);
       }
       return days;
   }

   function formatDate(date) {
       return date.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric' });
   }

   function calculateUsageData(days) {
       const data = {
           views: [],
           clicks: [],
           sessions: []
       };

       days.forEach(day => {
           const dayStr = day.toISOString().split('T')[0];
           let dayViews = 0, dayClicks = 0, daySessions = 0;

           state.sessions.forEach(session => {
               if (session.metrics?.daily?.[dayStr]) {
                   dayViews += session.metrics.daily[dayStr].loads || 0;
                   dayClicks += session.metrics.daily[dayStr].clicks || 0;
                   daySessions++;
               }
           });

           data.views.push(dayViews);
           data.clicks.push(dayClicks);
           data.sessions.push(daySessions);
       });

       return data;
   }

    // Section navigation - RESTORED ORIGINAL
    function showSection(sectionId) {
        // Update menu
        document.querySelectorAll('.menu-item').forEach(item => {
            item.classList.remove('active');
        });

        // Find and activate the correct menu item based on section ID
        const menuItems = document.querySelectorAll('.menu-item');
        menuItems.forEach(item => {
            const menuText = item.textContent.toLowerCase();
            const sectionName = sectionId.replace('-', ' ').toLowerCase();

            if ((sectionId === 'dashboard' && menuText.includes('dashboard')) ||
                (sectionId === 'sessions' && menuText.includes('live sessions')) ||
                (sectionId === 'clients' && menuText.includes('clients')) ||
                (sectionId === 'analytics' && menuText.includes('analytics')) ||
                (sectionId === 'billing' && menuText.includes('billing')) ||
                (sectionId === 'api' && menuText.includes('api')) ||
                (sectionId === 'activity' && menuText.includes('activity')) ||
                (sectionId === 'jobsdata' && menuText.includes('jobs data')) ||
                (sectionId === 'updatejobs' && menuText.includes('update jobs')) ||
                (sectionId === 'clientsdata' && menuText.includes('client analytics')) ||
                (sectionId === 'settings' && menuText.includes('settings'))) {
                item.classList.add('active');
            }
        });

        // Update sections
        document.querySelectorAll('.section').forEach(section => {
            section.classList.remove('active');
        });

        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
            targetSection.classList.add('active');
        }

        // Update page title
        const titles = {
            'dashboard': 'Dashboard',
            'sessions': 'Live Sessions',
            'clients': 'Client Management',
            'analytics': 'Analytics',
            'billing': 'Third Party Billing',
            'api': 'API Management',
            'activity': 'Activity Feed',
            'jobsdata': 'Jobs Data API',
            'updatejobs': 'Update Jobs',
            'clientsdata': 'Client Analytics',
            'settings': 'Settings'
        };

        document.getElementById('pageTitle').textContent = titles[sectionId] || 'Dashboard';

        // Load section data
        switch(sectionId) {
            case 'sessions':
                loadSessions();
                break;
            case 'clients':
                loadClients();
                break;
            case 'api':
                loadAPIKeys();
                break;
            case 'activity':
                loadActivity();
                break;
            case 'billing':
                loadBillingSection();
                break;
            case 'jobsdata':
                initializeDynamicEndpoints();
                break;
            case 'analytics':
                if (!state.charts.sessionDist) {
                    initializeAllCharts();
                }
                updateAnalyticsMetrics();
                break;
            case 'settings':
                checkSystemHealth();
                break;
            case 'updatejobs':
                checkDynamoStatus();
                break;
            case 'clientsdata':
                initializeClientData();
                break;
        }
    }

function updateAnalyticsMetrics() {
    let totalClicks = 0;
    let totalViews = 0;

    state.sessions.forEach(session => {
        totalClicks += session.totalMetrics?.clicks || 0;
        totalViews += session.totalMetrics?.loads || 0;
    });

    // Calculate CTR
    const ctr = totalViews > 0 ? ((totalClicks / totalViews) * 100).toFixed(2) : '0.00';

    document.getElementById('avgLoadTime').textContent = '250ms';
    document.getElementById('avgSessionDuration').textContent = '5m';
    document.getElementById('conversionRate').textContent = `${ctr}%`;
    document.getElementById('engagementScore').textContent = Math.min(100, totalClicks * 10);
}


    // Load sessions with aggregated data - RESTORED
    function loadSessions() {
        const container = document.getElementById('sessionsContainer');
        const activeSessions = state.sessions.filter(s => s.isActive);

        document.getElementById('sessionCount').textContent = `${activeSessions.length} Active`;

        if (state.sessions.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">👥</div>
                    <div class="empty-state-title">No sessions found</div>
                </div>
            `;
            return;
        }

        container.innerHTML = state.sessions.map(session => `
            <div class="session-card ${session.isActive ? 'active' : ''}" style="margin-bottom: 1rem;">
                <div class="session-header">
                    <div>
                        <div class="session-client">
                            ${session.displayName}
                            <span class="tracking-badge">Widget</span>
                            ${session.isTestEnvironment ? '<span class="tracking-badge iframe-indicator">Test</span>' : ''}
                        </div>
                        <div class="client-identifier">Client ID: ${session.clientIdentifier}</div>
                        <div style="margin-top: 0.5rem; color: var(--gray); font-size: 0.75rem;">
                            Started: ${new Date(session.firstSeen).toLocaleString()} |
                            Last Active: ${new Date(session.lastSeen).toLocaleString()}
                        </div>
                        ${session.sessionCount > 1 ? `
                            <div style="margin-top: 0.25rem; color: var(--gray); font-size: 0.75rem;">
                                Total Sessions: ${session.sessionCount}
                            </div>
                        ` : ''}
                    </div>
                    <span class="session-badge ${session.isActive ? 'active' : 'ended'}">
                        ${session.isActive ? '● Active' : '○ Ended'}
                    </span>
                </div>
                <div class="session-metrics">
                    <div class="metric-mini">
                        <div class="metric-mini-value">${session.totalMetrics?.loads || 0}</div>
                        <div class="metric-mini-label">Total Views</div>
                    </div>
                    <div class="metric-mini">
                        <div class="metric-mini-value">${session.totalMetrics?.clicks || 0}</div>
                        <div class="metric-mini-label">Total Clicks</div>
                    </div>
                    <div class="metric-mini">
                        <div class="metric-mini-value">${session.duration}</div>
                        <div class="metric-mini-label">Duration</div>
                    </div>
                    <div class="metric-mini">
                        <div class="metric-mini-value">£${session.revenue.toFixed(2)}</div>
                        <div class="metric-mini-label">Revenue</div>
                    </div>
                </div>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                    <div class="usage-metric">
                        <span class="metric-label">Today's Page Views:</span>
                        <span class="metric-value">${session.todayMetrics?.loads || 0}</span>
                    </div>
                    <div class="usage-metric">
                        <span class="metric-label">Today's Clicks:</span>
                        <span class="metric-value">${session.todayMetrics?.clicks || 0}</span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Enhanced load clients with iframe detection - RESTORED
    function loadClients() {
        const tbody = document.getElementById('clientsTable');

        if (state.clients.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No clients found. Waiting for widget connections...</td></tr>';
            return;
        }

        tbody.innerHTML = state.clients.map(client => `
            <tr>
                <td>
                    <div style="font-weight: 600;">
                        ${client.name}
                        <span class="tracking-badge">Widget</span>
                        ${client.isTestEnvironment ? '<span class="tracking-badge iframe-indicator">Test</span>' : ''}
                    </div>
                    <div class="client-identifier">${client.clientId}</div>
                    <div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">
                        ${client.sessionCount || 1} page refresh${client.sessionCount !== 1 ? 'es' : ''}
                    </div>
                </td>
                <td>${client.domain}</td>
                <td>${client.sessionCount || 1}</td>
                <td>${client.totalMetrics.loads.toLocaleString()}</td>
                <td>${client.totalMetrics.clicks.toLocaleString()}</td>
                <td>£${client.totalMetrics.revenue.toFixed(2)}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="viewClientDetails('${client.clientId}')">
                        View Details
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // Load settings - RESTORED
    function loadSettings() {
        const savedSettings = localStorage.getItem('adminSettings');
        if (savedSettings) {
            state.settings = JSON.parse(savedSettings);
        }
    }

    // Save settings - RESTORED
    function saveSettings() {
        localStorage.setItem('adminSettings', JSON.stringify(state.settings));
        showToast('Settings saved', 'success');
        loadDashboard();
    }

    // Start real-time updates - RESTORED
    function startRealTimeUpdates() {
        // Clear existing interval
        if (state.refreshInterval) {
            clearInterval(state.refreshInterval);
        }

        // Update every 30 seconds
        state.refreshInterval = setInterval(async () => {
            if (state.settings.enableNotifications) {
                await loadDashboard();
                await loadEnhancedTrackingData();

                // Update current visible section
                const activeSection = document.querySelector('.section.active');
                if (activeSection) {
                    const sectionId = activeSection.id;
                    if (sectionId === 'dashboard') {
                        updateCharts();
                    }
                }
            }
        }, 30000);
    }

    // Toast notifications - RESTORED
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const toastIcon = document.getElementById('toastIcon');
        const toastTitle = document.getElementById('toastTitle');
        const toastMessage = document.getElementById('toastMessage');

        // Reset classes
        toast.className = 'toast';
        toast.classList.add(type);

        // Set content
        const icons = {
            success: '✓',
            error: '✕',
            warning: '⚠',
            info: 'ℹ'
        };

        const titles = {
            success: 'Success',
            error: 'Error',
            warning: 'Warning',
            info: 'Info'
        };

        toastIcon.textContent = icons[type] || '✓';
        toastTitle.textContent = titles[type] || 'Success';
        toastMessage.textContent = message;

        // Show toast
        toast.classList.add('show');

        // Hide after 3 seconds
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    // Cleanup on page unload - RESTORED
    window.addEventListener('beforeunload', () => {
        if (state.refreshInterval) {
            clearInterval(state.refreshInterval);
        }
    });

    // Handle responsive menu - RESTORED
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('active');
    }

    window.addEventListener('resize', () => {
        if (window.innerWidth > 768) {
            document.getElementById('sidebar').classList.remove('active');
        }
    });

    // Export functions for debugging - RESTORED
    window.debugState = () => console.log(state);
    window.refreshData = () => loadDashboard();

    // Update all charts function - RESTORED
    function updateAllCharts() {
        // Call existing updateCharts
        updateCharts();

        // Update session distribution
        if (state.charts.sessionDist) {
            const distribution = calculateSessionDistribution();
            state.charts.sessionDist.data.datasets[0].data = [
                distribution.direct,
                distribution.iframe,
                distribution.api
            ];
            state.charts.sessionDist.update();
        }

        // Update revenue chart
        if (state.charts.revenue) {
            const topClients = state.clients
                .sort((a, b) => b.totalMetrics.revenue - a.totalMetrics.revenue)
                .slice(0, 5);

            state.charts.revenue.data.labels = topClients.map(c => c.name);
            state.charts.revenue.data.datasets[0].data = topClients.map(c => c.totalMetrics.revenue);
            state.charts.revenue.update();
        }

        // Update geographic distribution
        if (state.charts.geo) {
            const geoData = calculateGeographicDistribution();
            state.charts.geo.data.labels = Object.keys(geoData);
            state.charts.geo.data.datasets[0].data = Object.values(geoData);
            state.charts.geo.update();
        }
    }

    // Calculate session distribution - RESTORED
    function calculateSessionDistribution() {
        const distribution = { direct: 0, iframe: 0, api: 0 };

        state.sessions.forEach(session => {
            if (session.utm_medium === 'iframe' || session.isIframe) {
                distribution.iframe++;
            } else if (session.utm_medium === 'api') {
                distribution.api++;
            } else {
                distribution.direct++;
            }
        });

        return distribution;
    }

    // Calculate geographic distribution - RESTORED
    function calculateGeographicDistribution() {
        const geo = {};

        state.sessions.forEach(session => {
            // Extract location from domain or use default
            let location = 'Unknown';

            if (session.domain) {
                if (session.domain.includes('.uk')) location = 'United Kingdom';
                else if (session.domain.includes('.com')) location = 'United States';
                else if (session.domain.includes('.ca')) location = 'Canada';
                else if (session.domain.includes('.au')) location = 'Australia';
                else if (session.domain.includes('.in')) location = 'India';
                else location = 'Other';
            }

            geo[location] = (geo[location] || 0) + 1;
        });

        return geo;
    }

    // Search clients function - RESTORED
    function searchClients(query) {
        const filtered = state.clients.filter(client =>
            client.name.toLowerCase().includes(query.toLowerCase()) ||
            client.clientId.toLowerCase().includes(query.toLowerCase())
        );

        const tbody = document.getElementById('clientsTable');
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No clients match your search</td></tr>';
            return;
        }

        tbody.innerHTML = filtered.map(client => `
            <tr>
                <td>
                    <div style="font-weight: 600;">
                        ${client.name}
                        <span class="tracking-badge">Widget</span>
                        ${client.isTestEnvironment ? '<span class="tracking-badge iframe-indicator">Test</span>' : ''}
                    </div>
                    <div class="client-identifier">${client.clientId}</div>
                    <div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">
                        ${client.sessionCount || 1} session${client.sessionCount !== 1 ? 's' : ''}
                    </div>
                </td>
                <td>${client.domain}</td>
                <td>${client.sessionCount || 1}</td>
                <td>${client.totalMetrics.loads.toLocaleString()}</td>
                <td>${client.totalMetrics.clicks.toLocaleString()}</td>
                <td>£${client.totalMetrics.revenue.toFixed(2)}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="viewClientDetails('${client.clientId}')">
                        View Details
                    </button>
                </td>
            </tr>
        `).join('');
    }

   // View client details function - ENHANCED WITH MODAL
function viewClientDetails(clientId) {
    const client = state.clients.find(c => c.clientId === clientId);
    if (!client) return;

    const modal = document.getElementById('clientDetailsModal');
    const title = document.getElementById('clientModalTitle');
    const content = document.getElementById('clientModalContent');

    title.textContent = `Client Details - ${client.name}`;

    content.innerHTML = `
        <div class="client-detail-grid">
            <div>
                <h3 style="margin-bottom: 1rem;">General Information</h3>
                <div class="info-row">
                    <span class="info-label">Client ID:</span>
                    <span class="info-value">${client.clientId}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Name:</span>
                    <span class="info-value">${client.name}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Domain:</span>
                    <span class="info-value">${client.domain}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Type:</span>
                    <span class="info-value">${client.isIframe ? 'Widget Integration' : 'Direct'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Environment:</span>
                    <span class="info-value">${client.isTestEnvironment ? 'Test' : 'Production'}</span>
                </div>
            </div>

            <div>
                <h3 style="margin-bottom: 1rem;">Usage Metrics</h3>
                <div class="usage-metric">
                    <span class="metric-label">Total Sessions:</span>
                    <span class="metric-value">${client.sessionCount || 1}</span>
                </div>
                <div class="usage-metric">
                    <span class="metric-label">Page Views:</span>
                    <span class="metric-value">${client.totalMetrics.loads.toLocaleString()}</span>
                </div>
                <div class="usage-metric">
                    <span class="metric-label">BMJ Redirect Clicks:</span>
                    <span class="metric-value">${client.totalMetrics.clicks.toLocaleString()}</span>
                </div>
                <div class="usage-metric">
                    <span class="metric-label">API Calls:</span>
                    <span class="metric-value">${client.totalMetrics.apiCalls.toLocaleString()}</span>
                </div>
                <div class="usage-metric">
                    <span class="metric-label">Total Revenue:</span>
                    <span class="metric-value" style="color: var(--secondary); font-weight: 700;">
                        £${client.totalMetrics.revenue.toFixed(2)}
                    </span>
                </div>
            </div>
        </div>

        <div style="margin-top: 2rem;">
            <h3 style="margin-bottom: 1rem;">Revenue Breakdown</h3>
            <div class="revenue-calculator" style="padding: 1.5rem;">
                <div class="revenue-amount">£${client.totalMetrics.revenue.toFixed(2)}</div>
                <div class="revenue-period">Total Revenue Generated</div>
                <div class="revenue-breakdown">
                    <div class="breakdown-item">
                        <div class="breakdown-value">${client.totalMetrics.loads}</div>
                        <div class="breakdown-label">Page Views</div>
                    </div>
                    <div class="breakdown-item">
                        <div class="breakdown-value">${client.totalMetrics.clicks}</div>
                        <div class="breakdown-label">BMJ Clicks</div>
                    </div>
                    <div class="breakdown-item">
                        <div class="breakdown-value">£${(client.totalMetrics.clicks * 0.50).toFixed(2)}</div>
                        <div class="breakdown-label">Click Revenue</div>
                    </div>
                </div>
            </div>
        </div>
    `;

    modal.classList.add('active');
}

    // Load API Keys - RESTORED
    function loadAPIKeys() {
        const tbody = document.getElementById('apiKeysTable');

        if (!state.apiKeys || state.apiKeys.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No API keys generated yet</td></tr>';
            return;
        }

        tbody.innerHTML = state.apiKeys.map(key => `
            <tr>
                <td>${key.clientName}</td>
                <td>
                    <code style="background: var(--light); padding: 0.25rem 0.5rem; border-radius: 4px;">
                        ${key.apiKey.substring(0, 20)}...
                    </code>
                    <button class="btn btn-sm btn-secondary" onclick="copyApiKey('${key.apiKey || key.fullKey}')">
                        Copy
                    </button>
                </td>
                <td>${new Date(key.createdAt).toLocaleDateString()}</td>
                <td>${key.totalUsage || 0}</td>
                <td>${key.lastUsed ? new Date(key.lastUsed).toLocaleString() : 'Never'}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="revokeApiKey('${key.clientId}')">
                        Revoke
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // Load Activity Feed - RESTORED
    async function loadActivity() {
        try {
            const response = await fetch('/api/admin/activity/recent', {
                headers: {
                    'x-session-token': sessionToken
                }
            });

            if (response.ok) {
                const data = await response.json();
                updateActivityFeeds(data.activities);
            }
        } catch (error) {
            console.error('Error loading activity:', error);
            // Show mock data if API fails
            updateActivityFeeds(generateMockActivity());
        }
    }

    // Synchronize clicks from activity feed to sessions
function syncClicksFromActivityFeed() {
    // Count clicks in activity feed
    const clickItems = document.querySelectorAll('#clicksFeed .activity-item');
    const clicksByClient = {};

    clickItems.forEach(item => {
        const clientName = item.querySelector('.activity-title')?.textContent;
        if (clientName) {
            clicksByClient[clientName] = (clicksByClient[clientName] || 0) + 1;
        }
    });

    // Update sessions with click counts
    state.sessions.forEach(session => {
        const clientName = session.displayName || session.client_name || 'The Doctor (Test)';
        const clicks = clicksByClient[clientName] || 0;

        if (clicks > 0) {
            session.totalMetrics.clicks = clicks;
            session.todayMetrics.clicks = clicks;

            // Update corresponding client
            const client = state.clients.find(c => c.clientId === session.clientIdentifier);
            if (client) {
                client.totalMetrics.clicks = clicks;
                client.todayMetrics.clicks = clicks;

                // Update revenue
                const cpc = clientCPCRates[session.clientIdentifier] || 0.50;
                session.revenue = clicks * cpc;
                client.totalMetrics.revenue = session.revenue;
            }
        }
    });

    // Update all displays
    updateRecentSessions();
    updateDashboard();
    updateUsageChart('7d');
}

// Call sync after loading activity
async function loadActivity() {
    try {
        const response = await fetch('/api/admin/activity/recent', {
            headers: {
                'x-session-token': sessionToken
            }
        });

        if (response.ok) {
            const data = await response.json();
            updateActivityFeeds(data.activities);
        }
    } catch (error) {
        console.error('Error loading activity:', error);
        updateActivityFeeds(generateMockActivity());
    }

    // SYNC CLICKS AFTER LOADING ACTIVITY
    setTimeout(syncClicksFromActivityFeed, 100);
}


    // Generate mock activity data - RESTORED
    function generateMockActivity() {
        const activities = {
            loads: [],
            clicks: [],
            apiCalls: []
        };

        state.sessions.forEach(session => {
            if (session.totalMetrics?.loads > 0) {
                activities.loads.push({
                    client: session.displayName,
                    action: session.isIframe ? 'Loaded widget (iFrame)' : 'Loaded widget',
                    time: formatRelativeTime(session.lastSeen)
                });
            }

            if (session.totalMetrics?.clicks > 0) {
                activities.clicks.push({
                    client: session.displayName,
                    action: 'Clicked on job listing',
                    time: formatRelativeTime(session.lastSeen)
                });
            }

            if (session.totalMetrics?.apiCalls > 0) {
                activities.apiCalls.push({
                    client: session.displayName,
                    action: 'API call',
                    time: formatRelativeTime(session.lastSeen)
                });
            }
        });

        return activities;
    }

function updateActivityFeeds(activities) {
    // Modified filter for testing - don't exclude localhost
    const filterClientActivities = (items) => {
        if (!items) return [];
        return items.map(item => {
            // Map direct/localhost to test client
            if (item.client === 'direct' || item.client === 'localhost' || !item.client) {
                item.client = 'The Doctor (Test)';
                item.clientId = 'doctor-widget';
            }
            return item;
        }); // Removed the filter that excludes localhost
    };

    // Page loads
    const loadsFeed = document.getElementById('loadsFeed');
    const clientLoads = filterClientActivities(activities.loads);
    if (clientLoads.length > 0) {
        loadsFeed.innerHTML = clientLoads.slice(0, 10).map(item => `
            <div class="activity-item">
                <div class="activity-icon load">📄</div>
                <div class="activity-content">
                    <div class="activity-title">${item.client}</div>
                    <div class="activity-description">Loaded widget</div>
                </div>
                <div class="activity-time">${item.time}</div>
            </div>
        `).join('');
    } else {
        loadsFeed.innerHTML = '<div class="empty-state">No recent page loads</div>';
    }

    // Clicks - BMJ redirect clicks
    const clicksFeed = document.getElementById('clicksFeed');
    const clientClicks = filterClientActivities(activities.clicks);
    if (clientClicks.length > 0) {
        clicksFeed.innerHTML = clientClicks.slice(0, 10).map(item => `
            <div class="activity-item">
                <div class="activity-icon click">👆</div>
                <div class="activity-content">
                    <div class="activity-title">${item.client}</div>
                    <div class="activity-description">Clicked View on BMJ</div>
                </div>
                <div class="activity-time">${item.time}</div>
            </div>
        `).join('');
    } else {
        clicksFeed.innerHTML = '<div class="empty-state">No recent BMJ redirect clicks</div>';
    }

    // API calls
    const apiFeed = document.getElementById('apiFeed');
    const clientApiCalls = activities.apiCalls || [];
    if (clientApiCalls.length > 0) {
        apiFeed.innerHTML = clientApiCalls.slice(0, 10).map(item => `
            <div class="activity-item">
                <div class="activity-icon api">🔌</div>
                <div class="activity-content">
                    <div class="activity-title">${item.client || 'API Call'}</div>
                    <div class="activity-description">API call</div>
                </div>
                <div class="activity-time">${item.time}</div>
            </div>
        `).join('');
    } else {
        apiFeed.innerHTML = '<div class="empty-state">No recent API calls</div>';
    }
}


    // Format relative time helper - RESTORED
    function formatRelativeTime(date) {
        const now = new Date();
        const then = new Date(date);
        const diff = now - then;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (days > 0) return `${days}d ago`;
        if (hours > 0) return `${hours}h ago`;
        if (minutes > 0) return `${minutes}m ago`;
        return 'Just now';
    }

    // Enhanced Jobs Data functions - RESTORED ORIGINAL FUNCTIONALITY
    async function loadJobsData() {
        try {
            // Show loading state
            const viewer = document.getElementById('jobsDataViewer');
            const statsDiv = document.getElementById('jobsStats');
            viewer.innerHTML = '<pre><code>Loading jobs data...</code></pre>';

            // Try to connect to real API first
            const response = await fetch(`${state.currentOrigin}/api/jobs`, {
                headers: {
                    'x-session-token': sessionToken
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            // Store jobs data in state
            state.jobsData = data;

            // Update stats
            statsDiv.style.display = 'flex';
            document.getElementById('totalJobsCount').textContent = data.total || data.jobs?.length || 0;
            document.getElementById('newJobsCount').textContent = data.newJobsCount || 0;
            document.getElementById('updatedJobsCount').textContent = data.updatedJobsCount || 0;
            document.getElementById('dataSource').textContent = data.source || 'API';

            // Format JSON for display with syntax highlighting
            const jobsDisplay = {
                success: data.success || true,
                total: data.jobs?.length || data.total || 0,
                source: data.source || 'live',
                fromCache: data.fromCache || false,
                lastFetch: data.lastFetch || new Date().toISOString(),
                jobs: data.jobs || data.data?.jobs || []
            };

            const formatted = JSON.stringify(jobsDisplay, null, 2);
            const highlighted = formatted
                .replace(/"([^"]+)":/g, '<span class="json-key">"$1"</span>:')
                .replace(/: "([^"]+)"/g, ': <span class="json-string">"$1"</span>')
                .replace(/: (\d+)/g, ': <span class="json-number">$1</span>')
                .replace(/: (true|false)/g, ': <span class="json-boolean">$1</span>')
                .replace(/: (null)/g, ': <span class="json-null">$1</span>');

            viewer.innerHTML = `<pre><code>${highlighted}</code></pre>`;
            document.getElementById('jobsCount').textContent = `${jobsDisplay.jobs.length} jobs loaded from ${data.source || 'API'}`;

            showToast('Jobs data loaded successfully', 'success');
        } catch (error) {
            console.error('Error loading jobs:', error);
            const viewer = document.getElementById('jobsDataViewer');
            viewer.innerHTML = `<pre><code class="error">Error loading jobs: ${error.message}\nTrying fallback data sources...</code></pre>`;
            document.getElementById('jobsStats').style.display = 'none';

            // Try fallback to DynamoDB or XML feed
            await tryFallbackDataSources();
        }
    }

    // Try fallback data sources - RESTORED ORIGINAL FUNCTIONALITY
    async function tryFallbackDataSources() {
        try {
            // Try DynamoDB first
            const dynamoResponse = await fetch('/api/jobs/dynamo', {
                headers: { 'x-session-token': sessionToken }
            });

            if (dynamoResponse.ok) {
                const data = await dynamoResponse.json();
                displayJobsData(data, 'DynamoDB');
                return;
            }
        } catch (error) {
            console.log('DynamoDB unavailable, trying XML feed...');
        }

        try {
            // Try XML feed as last resort
            const xmlResponse = await fetch('/api/jobs/xml', {
                headers: { 'x-session-token': sessionToken }
            });

            if (xmlResponse.ok) {
                const data = await xmlResponse.json();
                displayJobsData(data, 'XML Feed');
                return;
            }
        } catch (error) {
            console.log('All data sources failed');
        }

        // All sources failed
        const viewer = document.getElementById('jobsDataViewer');
        viewer.innerHTML = '<pre><code class="error">All data sources unavailable. Please check system status.</code></pre>';
        showToast('Unable to load jobs data from any source', 'error');
    }

    // Display jobs data helper - RESTORED
    function displayJobsData(data, source) {
        const viewer = document.getElementById('jobsDataViewer');
        const statsDiv = document.getElementById('jobsStats');

        state.jobsData = data;

        statsDiv.style.display = 'flex';
        document.getElementById('totalJobsCount').textContent = data.jobs?.length || 0;
        document.getElementById('dataSource').textContent = source;

        const formatted = JSON.stringify(data, null, 2);
        const highlighted = formatted
            .replace(/"([^"]+)":/g, '<span class="json-key">"$1"</span>:')
            .replace(/: "([^"]+)"/g, ': <span class="json-string">"$1"</span>')
            .replace(/: (\d+)/g, ': <span class="json-number">$1</span>')
            .replace(/: (true|false)/g, ': <span class="json-boolean">$1</span>');

        viewer.innerHTML = `<pre><code>${highlighted}</code></pre>`;
        document.getElementById('jobsCount').textContent = `${data.jobs?.length || 0} jobs loaded from ${source}`;
        showToast(`Jobs data loaded from ${source}`, 'success');
    }

    async function downloadJobsData() {
        try {
            // Check if data is already loaded
            if (!state.jobsData) {
                showToast('Please load jobs data first', 'warning');
                await loadJobsData();
            }

            if (!state.jobsData) {
                throw new Error('No jobs data available');
            }

            // Prepare download data
            const downloadData = {
                total: state.jobsData.jobs?.length || 0,
                download_date: new Date().toISOString(),
                source: state.jobsData.source,
                origin: state.currentOrigin,
                jobs: state.jobsData.jobs || state.jobsData.data?.jobs || []
            };

            const blob = new Blob([JSON.stringify(downloadData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bmj-jobs-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            showToast('Jobs data downloaded successfully', 'success');
        } catch (error) {
            console.error('Error downloading jobs:', error);
            showToast('Error downloading jobs data', 'error');
        }
    }

    async function refreshJobsData() {
        try {
            showToast('Refreshing jobs data...', 'info');

            // Force refresh from server
            const response = await fetch(`${state.currentOrigin}/api/jobs/refresh`, {
                method: 'POST',
                headers: {
                    'x-session-token': sessionToken
                }
            });

            if (!response.ok) {
                throw new Error('Failed to refresh jobs');
            }

            const result = await response.json();

            // Reload the jobs data
            await loadJobsData();

            showToast(`Jobs refreshed: ${result.newJobsCount || 0} new, ${result.updatedJobsCount || 0} updated`, 'success');
        } catch (error) {
            console.error('Error refreshing jobs:', error);
            showToast('Error refreshing jobs data', 'error');
        }
    }

    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        const text = element.textContent;

        navigator.clipboard.writeText(text).then(() => {
            showToast('Copied to clipboard', 'success');
        }).catch(() => {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showToast('Copied to clipboard', 'success');
        });
    }

    function loadRevenueCalculator() {
        const select = document.getElementById('revenueClient');
        if (!select) return;

        select.innerHTML = '<option value="">All Clients</option>' +
            state.clients.map(client =>
                `<option value="${client.clientId}">${client.name}</option>`
            ).join('');
    }

    // Additional helper functions
    function refreshSessions() {
        loadDashboard();
        showToast('Sessions refreshed', 'success');
    }

    function copyApiKey(apiKey) {
        navigator.clipboard.writeText(apiKey).then(() => {
            showToast('API key copied to clipboard', 'success');
        }).catch(() => {
            showToast('Failed to copy API key', 'error');
        });
    }

async function revokeApiKey(clientId) {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content">
            <h2 style="margin-bottom: 1rem;">Confirm API Key Revocation</h2>
            <p>Are you sure you want to revoke the API key for this client?</p>
            <p style="color: var(--danger); margin-top: 0.5rem;">This action cannot be undone.</p>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button class="btn btn-danger" onclick="confirmRevokeKey('${clientId}')">Revoke Key</button>
                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

async function confirmRevokeKey(clientId) {
    try {
        // Remove from local state immediately
        state.apiKeys = state.apiKeys.filter(key => key.clientId !== clientId);

        // Update display
        loadAPIKeys();

        // Close modal
        document.querySelector('.modal.active').remove();

        // Send to server
        const response = await fetch(`/api/admin/apikey/${clientId}`, {
            method: 'DELETE',
            headers: { 'x-session-token': sessionToken }
        });

        if (response.ok) {
            showToast('API key revoked successfully', 'success');
        } else {
            // Rollback on failure
            await loadDashboard();
            showToast('Failed to revoke API key', 'error');
        }
    } catch (error) {
        console.error('Revoke error:', error);
        await loadDashboard();
        showToast('Error revoking API key', 'error');
    }
}

// Add this to window object for onclick access
window.confirmRevokeKey = confirmRevokeKey;


    function showGenerateKeyModal() {
        const modal = document.getElementById('generateKeyModal');
        if (modal) {
            modal.classList.add('active');
        } else {
            // Fallback to prompt if modal doesn't exist
            const clientName = prompt('Enter client name:');
            const clientId = prompt('Enter client ID:');

            if (clientName && clientId) {
                generateAPIKey(clientId, clientName);
            }
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('active');
        }
    }

    function submitGenerateKey() {
        const clientName = document.getElementById('apiClientName').value;
        const clientId = document.getElementById('apiClientId').value;

        if (clientName && clientId) {
            generateAPIKey(clientId, clientName);
            closeModal('generateKeyModal');
            document.getElementById('generateKeyForm').reset();
        }
    }

    async function generateAPIKey(clientId, clientName) {
        try {
            const response = await fetch('/api/admin/generate-api-key', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-session-token': sessionToken
                },
                body: JSON.stringify({ clientId, clientName })
            });

            if (response.ok) {
                const data = await response.json();

                // Add to local state
                state.apiKeys.push({
                    clientId: clientId,
                    clientName: clientName,
                    apiKey: data.apiKey,
                    fullKey: data.apiKey,
                    createdAt: new Date().toISOString(),
                    totalUsage: 0,
                    lastUsed: null
                });

                // Refresh the display
                loadAPIKeys();

                // Copy to clipboard
                navigator.clipboard.writeText(data.apiKey).then(() => {
                    showToast('API key generated and copied to clipboard', 'success');
                }).catch(() => {
                    showToast('API key generated successfully', 'success');
                });

            } else {
                throw new Error('Failed to generate API key');
            }
        } catch (error) {
            console.error('Generate API key error:', error);
            showToast('Error generating API key', 'error');
        }
    }

    // Code example switcher - RESTORED
    function showCodeExample(language) {
        // Update tab states
        document.querySelectorAll('.code-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        event.target.classList.add('active');

        // Hide all examples
        document.querySelectorAll('.code-example').forEach(example => {
            example.style.display = 'none';
        });

        // Show selected example
        const selectedExample = document.getElementById(`code-${language}`);
        if (selectedExample) {
            selectedExample.style.display = 'block';
        }
    }

    // System health check function - RESTORED
    async function checkSystemHealth() {
        try {
            const response = await fetch('/health', {
                headers: {
                    'x-session-token': sessionToken
                }
            });

            if (!response.ok) {
                throw new Error('Health check failed');
            }

            const health = await response.json();

            // Update system status
            document.getElementById('systemStatus').textContent = health.status || 'Unknown';
            document.getElementById('systemStatus').style.color =
                health.status === 'OK' ? 'var(--secondary)' :
                health.status === 'PARTIAL' ? 'var(--warning)' : 'var(--danger)';

            // Update DynamoDB status
            const dbStatus = health.dynamoDB?.connected ? 'Connected' : 'Disconnected';
            document.getElementById('dynamoStatus').textContent = dbStatus;
            document.getElementById('dynamoStatus').style.color =
                health.dynamoDB?.connected ? 'var(--secondary)' : 'var(--danger)';

            // Update feed source
            document.getElementById('feedSource').textContent = health.cache?.source || 'Unknown';

            // Update cache age
            if (health.cache?.age_seconds) {
                const minutes = Math.floor(health.cache.age_seconds / 60);
                const hours = Math.floor(minutes / 60);
                if (hours > 0) {
                    document.getElementById('cacheAge').textContent = `${hours}h ${minutes % 60}m`;
                } else {
                    document.getElementById('cacheAge').textContent = `${minutes}m`;
                }
            } else {
                document.getElementById('cacheAge').textContent = 'No cache';
            }

            // Update detailed information
            document.getElementById('feedUrl').textContent = health.feedUrl || 'Not configured';
            document.getElementById('totalJobsCached').textContent = health.cache?.jobs_count || 0;
            document.getElementById('lastSyncTime').textContent = health.cache?.last_fetch ?
                new Date(health.cache.last_fetch).toLocaleString() : 'Never';

            // Calculate uptime
            if (health.uptime) {
                const uptimeHours = Math.floor(health.uptime / 3600);
                const uptimeMinutes = Math.floor((health.uptime % 3600) / 60);
                document.getElementById('serverUptime').textContent =
                    `${uptimeHours}h ${uptimeMinutes}m`;
            }

            // Memory usage
            if (health.memory_usage) {
                const memoryMB = Math.round(health.memory_usage.heapUsed / 1024 / 1024);
                const totalMB = Math.round(health.memory_usage.heapTotal / 1024 / 1024);
                document.getElementById('memoryUsage').textContent =
                    `${memoryMB}MB / ${totalMB}MB`;
            }

            showToast('System health checked', 'success');

        } catch (error) {
            console.error('System health check error:', error);

            // Update with error state
            document.getElementById('systemStatus').textContent = 'Error';
            document.getElementById('systemStatus').style.color = 'var(--danger)';
            document.getElementById('dynamoStatus').textContent = 'Unknown';
            document.getElementById('feedSource').textContent = 'Unknown';
            document.getElementById('cacheAge').textContent = 'Unknown';

            showToast('Failed to check system health', 'error');
        }
    }

    async function searchJobs() {
        const searchTerm = document.getElementById('jobSearchInput').value;
        const searchField = document.getElementById('jobSearchField').value;

        if (!searchTerm) {
            showToast('Please enter a search term', 'warning');
            return;
        }

        try {
            const response = await fetch('/api/admin/jobs/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-session-token': sessionToken
                },
                body: JSON.stringify({ searchTerm, searchField })
            });

            if (response.ok) {
                const data = await response.json();
                displayJobSearchResults(data.jobs);
            }
        } catch (error) {
            showToast('Search failed', 'error');
        }
    }

    function displayJobSearchResults(jobs) {
        const resultsDiv = document.getElementById('jobSearchResults');
        const listDiv = document.getElementById('jobResultsList');

        if (jobs.length === 0) {
            listDiv.innerHTML = '<div class="empty-state">No jobs found</div>';
        } else {
            listDiv.innerHTML = jobs.map(job => `
                <div class="job-result-item" style="padding: 1rem; border: 1px solid #e2e8f0; margin-bottom: 0.5rem; cursor: pointer;"
                     onclick="editJob(${JSON.stringify(job).replace(/"/g, '&quot;')})">
                    <strong>${job.job_title}</strong> (ID: ${job.id})<br>
                    <span style="color: var(--gray);">
                        ${job.recruiter_name} | ${job.location_description}
                    </span>
                </div>
            `).join('');
        }

        resultsDiv.style.display = 'block';
    }

    function editJob(job) {
        currentEditingJob = JSON.parse(JSON.stringify(job));
        const editorDiv = document.getElementById('jobEditor');
        const fieldsDiv = document.getElementById('jobEditorFields');

        // Create editable fields for key properties
        const editableFields = [
            'job_title', 'recruiter_name', 'alternate_recruiter_name',
            'location_description', 'salary', 'short_description',
            'grade', 'contract_type'
        ];

        fieldsDiv.innerHTML = editableFields.map(field => `
            <div class="form-group">
                <label class="form-label">${field.replace(/_/g, ' ').toUpperCase()}</label>
                <input type="text"
                       class="form-input"
                       id="edit_${field}"
                       value="${job[field] || ''}"
                       data-field="${field}">
            </div>
        `).join('');

        editorDiv.style.display = 'block';
    }

    async function saveJobChanges() {
        if (!currentEditingJob) return;

        // Collect changes
        const updates = {};
        const inputs = document.querySelectorAll('#jobEditorFields input');
        inputs.forEach(input => {
            const field = input.dataset.field;
            const value = input.value;
            if (value !== currentEditingJob[field]) {
                updates[field] = value;
            }
        });

        if (Object.keys(updates).length === 0) {
            showToast('No changes to save', 'info');
            return;
        }

        try {
            const response = await fetch('/api/admin/jobs/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-session-token': sessionToken
                },
                body: JSON.stringify({
                    jobId: currentEditingJob.id,
                    updates: updates
                })
            });

            if (response.ok) {
                showToast('Job updated successfully', 'success');
                cancelJobEdit();
            }
        } catch (error) {
            showToast('Failed to update job', 'error');
        }
    }

    function cancelJobEdit() {
        currentEditingJob = null;
        document.getElementById('jobEditor').style.display = 'none';
        document.getElementById('jobSearchResults').style.display = 'none';
    }

    // Billing functions - RESTORED
    function loadBillingSection() {
        const select = document.getElementById('billingClient');
        if (!select) return;

        select.innerHTML = '<option value="">Select a client...</option>' +
            state.clients.map(client =>
                `<option value="${client.clientId}">${client.name} (${client.domain})</option>`
            ).join('');

        // Set default month to previous month
        const now = new Date();
        now.setMonth(now.getMonth() - 1);
        document.getElementById('billingMonth').value = now.toISOString().slice(0, 7);
    }

    function loadClientBillingSettings() {
        const clientId = document.getElementById('billingClient').value;
        if (!clientId) {
            document.getElementById('clientBillingSettings').style.display = 'none';
            return;
        }

        document.getElementById('clientBillingSettings').style.display = 'block';

        // Load saved CPC rate or default
        const savedRate = clientCPCRates[clientId] || 0.50;
        document.getElementById('clientCPC').value = savedRate;
    }

    function saveClientCPC() {
        const clientId = document.getElementById('billingClient').value;
        const cpc = parseFloat(document.getElementById('clientCPC').value);

        if (clientId && cpc > 0) {
            clientCPCRates[clientId] = cpc;
            localStorage.setItem('clientCPCRates', JSON.stringify(clientCPCRates));
            showToast('Cost per click rate saved', 'success');
        }
    }

async function generateBillingReport() {
    const clientId = document.getElementById('billingClient').value;
    const billingMonth = document.getElementById('billingMonth').value;
    const cpc = parseFloat(document.getElementById('clientCPC').value || 0.50);

    if (!clientId || !billingMonth) {
        showToast('Please select client and month', 'warning');
        return;
    }

    try {
        // Try to fetch from server first
        let billingData = null;

        try {
            const response = await fetch('/api/admin/billing/clicks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-session-token': sessionToken
                },
                body: JSON.stringify({ clientId, month: billingMonth })
            });

            if (response.ok) {
                billingData = await response.json();
            }
        } catch (error) {
            console.log('Server unavailable, using local data');
        }

        // Fallback to local tracking data
        if (!billingData || !billingData.clicks || billingData.clicks.length === 0) {
            // Use local tracking data
            const trackingInfo = window.trackingData[clientId];
            const client = state.clients.find(c => c.clientId === clientId);

            if (trackingInfo && trackingInfo.clicks > 0) {
                billingData = {
                    clientName: client?.name || clientId,
                    clicks: trackingInfo.jobDetails || []
                };
            }
        }

        // Process billing data
        const jobClicks = {};
        const clicks = billingData?.clicks || [];

        if (window.trackingData[clientId] && clicks.length === 0) {
            // Use current session data
            window.trackingData[clientId].jobDetails.forEach((detail, index) => {
                const jobKey = detail.jobId || `job_${index}`;
                if (!jobClicks[jobKey]) {
                    jobClicks[jobKey] = {
                        jobId: detail.jobId || `job_${index}`,
                        jobTitle: detail.jobTitle || 'Medical Position',
                        location: detail.location || 'UK',
                        clicks: 0,
                        dates: []
                    };
                }
                jobClicks[jobKey].clicks++;
                jobClicks[jobKey].dates.push(new Date(detail.timestamp));
            });
        } else {
            clicks.forEach(click => {
                const jobKey = click.jobId || 'unknown';
                if (!jobClicks[jobKey]) {
                    jobClicks[jobKey] = {
                        jobId: click.jobId,
                        jobTitle: click.jobTitle || 'Unknown Job',
                        location: click.location || 'Unknown',
                        clicks: 0,
                        dates: []
                    };
                }
                jobClicks[jobKey].clicks++;
                jobClicks[jobKey].dates.push(new Date(click.timestamp));
            });
        }

        const totalClicks = Object.values(jobClicks).reduce((sum, job) => sum + job.clicks, 0) ||
                           window.trackingData[clientId]?.clicks || 0;
        const totalCost = totalClicks * cpc;
        const uniqueJobs = Object.keys(jobClicks).length || 1;

        // Update display
        document.getElementById('reportTitle').textContent =
            `Billing Report - ${billingData?.clientName || client?.name || clientId}`;
        document.getElementById('totalOwed').textContent = `£${totalCost.toFixed(2)}`;
        document.getElementById('totalClicks').textContent = totalClicks.toLocaleString();
        document.getElementById('cpcRate').textContent = `£${cpc.toFixed(2)}`;
        document.getElementById('uniqueJobs').textContent = uniqueJobs.toLocaleString();

        // Populate table
        const tbody = document.getElementById('billingDetailsTable');
        if (Object.keys(jobClicks).length > 0) {
            tbody.innerHTML = Object.values(jobClicks)
                .sort((a, b) => b.clicks - a.clicks)
                .map(job => `
                    <tr>
                        <td>${job.dates[0]?.toLocaleDateString() || new Date().toLocaleDateString()}</td>
                        <td>${job.jobTitle}</td>
                        <td><code>${job.jobId}</code></td>
                        <td>${job.location}</td>
                        <td>${job.clicks}</td>
                        <td>£${(job.clicks * cpc).toFixed(2)}</td>
                    </tr>
                `).join('');
        } else if (totalClicks > 0) {
            // Show aggregated data if no job details
            tbody.innerHTML = `
                <tr>
                    <td>${new Date().toLocaleDateString()}</td>
                    <td>Aggregated Clicks</td>
                    <td><code>various</code></td>
                    <td>Various</td>
                    <td>${totalClicks}</td>
                    <td>£${totalCost.toFixed(2)}</td>
                </tr>
            `;
        }

        document.getElementById('footerTotalClicks').textContent = totalClicks;
        document.getElementById('footerTotalCost').textContent = `£${totalCost.toFixed(2)}`;
        document.getElementById('billingReport').style.display = 'block';

        window.currentBillingReport = {
            client: { clientId, name: billingData?.clientName || clientId },
            month: billingMonth,
            clicks: clicks,
            jobClicks: jobClicks,
            totalClicks: totalClicks,
            totalCost: totalCost,
            cpc: cpc
        };

        showToast('Billing report generated', 'success');

    } catch (error) {
        console.error('Billing report error:', error);
        showToast('Error generating billing report', 'error');
    }
}


// Remove any setInterval polling in admin file and replace with:
let eventSource = null;

function initializeRealTimeUpdates() {
    if (eventSource) {
        eventSource.close();
    }

    eventSource = new EventSource('/api/admin/stream', {
        withCredentials: true
    });

    eventSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);

            if (data.type === 'dashboard_update') {
                updateDashboard(data);
            } else if (data.type === 'client_activity') {
                updateClientCard(data);
            }
        } catch (error) {
            console.error('SSE message parsing error:', error);
        }
    };

    eventSource.onerror = function(error) {
        console.error('SSE connection error:', error);
        // Reconnect after 5 seconds
        setTimeout(initializeRealTimeUpdates, 5000);
    };
}

function updateClientCard(data) {
    const clientCard = document.querySelector(`[data-client-id="${data.clientId}"]`);
    if (clientCard) {
        // Update the metrics in real-time
        const pageViewsEl = clientCard.querySelector('.page-views');
        const clicksEl = clientCard.querySelector('.clicks');
        const sessionsEl = clientCard.querySelector('.sessions');

        if (pageViewsEl) pageViewsEl.textContent = data.currentMetrics.totalLoads;
        if (clicksEl) clicksEl.textContent = data.currentMetrics.totalClicks;
        if (sessionsEl) sessionsEl.textContent = data.currentMetrics.totalSessions;

        // Flash effect to show update
        clientCard.style.backgroundColor = '#e8f5e8';
        setTimeout(() => {
            clientCard.style.backgroundColor = '';
        }, 1000);
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', initializeRealTimeUpdates);


    // Export billing functions - RESTORED
    async function exportBillingPDF() {
        if (!window.currentBillingReport) {
            showToast('No report to export', 'warning');
            return;
        }

        const report = window.currentBillingReport;

        // Create printable version
        const printWindow = window.open('', '_blank');
        const html = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Billing Report - ${report.client.name}</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; }
                    h1 { color: #333; }
                    .header { border-bottom: 2px solid #0066cc; padding-bottom: 10px; margin-bottom: 20px; }
                    .summary { background: #f0f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
                    table { width: 100%; border-collapse: collapse; }
                    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
                    th { background: #f0f4f8; font-weight: bold; }
                    .total { font-weight: bold; background: #f0f4f8; }
                    .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>BMJ Careers Widget - Traffic Billing Report</h1>
                    <p><strong>Client:</strong> ${report.client.name}</p>
                    <p><strong>Period:</strong> ${new Date(report.month + '-01').toLocaleDateString('en-GB', { month: 'long', year: 'numeric' })}</p>
                    <p><strong>Generated:</strong> ${new Date().toLocaleDateString('en-GB')}</p>
                </div>

                <div class="summary">
                    <h2>Summary</h2>
                    <p><strong>Total Clicks:</strong> ${report.totalClicks}</p>
                    <p><strong>Cost Per Click:</strong> £${report.cpc.toFixed(2)}</p>
                    <p><strong>Total Amount Due:</strong> £${report.totalCost.toFixed(2)}</p>
                </div>

                <h2>Click Details by Job</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Job ID</th>
                            <th>Job Title</th>
                            <th>Location</th>
                            <th>Clicks</th>
                            <th>Cost</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.values(report.jobClicks).map(job => `
                            <tr>
                                <td>${job.jobId}</td>
                                <td>${job.jobTitle}</td>
                                <td>${job.location}</td>
                                <td>${job.clicks}</td>
                                <td>£${(job.clicks * report.cpc).toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                    <tfoot>
                        <tr class="total">
                            <td colspan="3">Total</td>
                            <td>${report.totalClicks}</td>
                            <td>£${report.totalCost.toFixed(2)}</td>
                        </tr>
                    </tfoot>
                </table>

                <div class="footer">
                    <p>This report confirms ${report.totalClicks} clicks from the BMJ Careers widget installed on ${report.client.domain} during the specified period.</p>
                    <p>Please invoice BMJ Careers for the total amount of £${report.totalCost.toFixed(2)}.</p>
                </div>
            </body>
            </html>
        `;

        printWindow.document.write(html);
        printWindow.document.close();
        printWindow.print();

        showToast('PDF export opened in new window', 'success');
    }

    function exportBillingCSV() {
        if (!window.currentBillingReport) {
            showToast('No report to export', 'warning');
            return;
        }

        const report = window.currentBillingReport;

        let csv = 'Job ID,Job Title,Location,Clicks,Cost\n';
        Object.values(report.jobClicks).forEach(job => {
            csv += `"${job.jobId}","${job.jobTitle}","${job.location}",${job.clicks},£${(job.clicks * report.cpc).toFixed(2)}\n`;
        });
        csv += `\nTotal,,,${report.totalClicks},£${report.totalCost.toFixed(2)}\n`;

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `billing_${report.client.name}_${report.month}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        showToast('CSV exported successfully', 'success');
    }

    // RESTORED settings functions
    function loadSettingsUI() {
        if (document.getElementById('trackInternalIPs')) {
            document.getElementById('trackInternalIPs').checked = state.settings.trackInternalIPs;
            document.getElementById('sessionTimeout').value = state.settings.sessionTimeout;
            document.getElementById('enableNotifications').checked = state.settings.enableNotifications;
            document.getElementById('alertThreshold').value = state.settings.alertThreshold;
            document.getElementById('dataRetention').value = state.settings.dataRetention;
        }
    }

    async function exportAllData() {
        try {
            const response = await fetch('/api/admin/export', {
                headers: {
                    'x-session-token': sessionToken
                }
            });

            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bmj-careers-export-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showToast('Data exported successfully', 'success');
            } else {
                throw new Error('Export failed');
            }
        } catch (error) {
            showToast('Failed to export data', 'error');
        }
    }

    // Update Jobs functions - WORKS WITHOUT DYNAMO
let currentEditingJob = null;
let dynamoAvailable = false;

async function checkDynamoStatus() {
    try {
        const response = await fetch('/health', {
            headers: { 'x-session-token': sessionToken }
        });
        const health = await response.json();

        const indicator = document.getElementById('dynamoStatusIndicator');
        const syncButton = document.getElementById('syncButton');
        const unavailableMsg = document.getElementById('dynamoUnavailable');

        dynamoAvailable = health.dynamoDB?.connected || false;

        if (dynamoAvailable) {
            indicator.textContent = 'DynamoDB Connected';
            indicator.className = 'session-badge active';
            if (syncButton) syncButton.disabled = false;
            if (unavailableMsg) unavailableMsg.style.display = 'none';
        } else {
            indicator.textContent = 'DynamoDB Offline';
            indicator.className = 'session-badge ended';
            if (syncButton) syncButton.disabled = true;
            if (unavailableMsg) unavailableMsg.style.display = 'block';
        }
    } catch (error) {
        console.error('DynamoDB status check failed:', error);
        dynamoAvailable = false;
    }
}

async function searchJobsLocal() {
    const searchTerm = document.getElementById('jobSearchInput').value;
    const searchField = document.getElementById('jobSearchField').value;

    if (!searchTerm) {
        showToast('Please enter a search term', 'warning');
        return;
    }

    try {
        // First try to use cached jobs data
        if (!state.jobsData) {
            await loadJobsData();
        }

        let jobs = state.jobsData?.jobs || [];

        // Filter jobs based on search
        const filteredJobs = jobs.filter(job => {
            const value = job[searchField];
            if (!value) return false;
            return value.toString().toLowerCase().includes(searchTerm.toLowerCase());
        });

        displayJobSearchResults(filteredJobs);

    } catch (error) {
        showToast('Search failed', 'error');
    }
}

// Client Data Analytics Functions
const CLIENT_DATA_TABLE = ''; // Will be filled when DynamoDB table is created

async function initializeClientData() {
    const status = document.getElementById('clientsDataStatus');

    // Always show as ready since we're using local data
    status.textContent = 'Ready';
    status.className = 'session-badge active';

    // Load dropdown with current clients
    loadClientDataOptions();
}

function loadClientDataOptions() {
    const select = document.getElementById('reportClient');
    if (!select) return;

    // Clear and repopulate
    select.innerHTML = '<option value="">All Clients</option>';

    // Add all active clients from state
    state.clients.forEach(client => {
        const option = document.createElement('option');
        option.value = client.clientId;
        option.textContent = `${client.name} (${client.clientId})`;
        select.appendChild(option);
    });

    // Set default dates
    const today = new Date();
    const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

    const endDateInput = document.getElementById('reportEndDate');
    const startDateInput = document.getElementById('reportStartDate');

    if (endDateInput) endDateInput.value = today.toISOString().split('T')[0];
    if (startDateInput) startDateInput.value = lastWeek.toISOString().split('T')[0];
}

function loadClientDataOptions() {
    const select = document.getElementById('reportClient');
    select.innerHTML = '<option value="">All Clients</option>' +
        state.clients.map(client =>
            `<option value="${client.clientId}">${client.name}</option>`
        ).join('');

    // Set default dates
    const today = new Date();
    const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

    document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
    document.getElementById('reportStartDate').value = lastWeek.toISOString().split('T')[0];
}

async function generateClientReport() {
    const clientId = document.getElementById('reportClient').value || TEST_CLIENT_ID;
    const startDate = document.getElementById('reportStartDate').value;
    const endDate = document.getElementById('reportEndDate').value;

    if (!startDate || !endDate) {
        showToast('Please select date range', 'warning');
        return;
    }

    try {
        // Use local data if available
        const client = state.clients.find(c => c.clientId === clientId);
        const session = state.sessions.find(s => s.clientIdentifier === clientId);

        if (!client || !session) {
            showToast('No data available for this client', 'warning');
            return;
        }

        const data = {
            clientName: client.name,
            period: `${startDate} to ${endDate}`,
            totalViews: session.totalMetrics.loads || 0,
            totalClicks: session.totalMetrics.clicks || 0,
            totalRevenue: session.revenue || 0,
            dailyData: [{
                date: new Date().toISOString(),
                clientName: client.name,
                views: session.totalMetrics.loads || 0,
                clicks: session.totalMetrics.clicks || 0,
                revenue: session.revenue || 0
            }]
        };

        displayClientReport(data);
        showToast('Report generated from current session data', 'success');

    } catch (error) {
        console.error('Report generation error:', error);
        showToast('Error generating report', 'error');
    }
}

function displayClientReport(data) {
    const display = document.getElementById('clientReportDisplay');
    display.style.display = 'block';

    // Update title
    document.getElementById('clientReportTitle').textContent =
        `Usage Report - ${data.clientName || 'All Clients'} - ${data.period}`;

    // Update stats
    document.getElementById('reportTotalViews').textContent = data.totalViews.toLocaleString();
    document.getElementById('reportTotalClicks').textContent = data.totalClicks.toLocaleString();
    document.getElementById('reportTotalRevenue').textContent = `£${data.totalRevenue.toFixed(2)}`;
    document.getElementById('reportCTR').textContent =
        `${((data.totalClicks / data.totalViews) * 100).toFixed(2)}%`;

    // Update table
    const tbody = document.getElementById('clientReportTable');
    tbody.innerHTML = data.dailyData.map(day => `
        <tr>
            <td>${new Date(day.date).toLocaleDateString()}</td>
            <td>${day.clientName}</td>
            <td>${day.views.toLocaleString()}</td>
            <td>${day.clicks.toLocaleString()}</td>
            <td>${((day.clicks / day.views) * 100).toFixed(2)}%</td>
            <td>£${day.revenue.toFixed(2)}</td>
        </tr>
    `).join('');

    // Update chart
    updateClientTrendChart(data);

    // Store for export
    window.currentClientReport = data;
}

function updateClientTrendChart(data) {
    if (!state.charts.clientTrend) {
        const ctx = document.getElementById('clientTrendChart');
        if (ctx) {
            state.charts.clientTrend = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Page Views',
                        data: [],
                        borderColor: '#0066cc',
                        backgroundColor: 'rgba(0, 102, 204, 0.1)'
                    }, {
                        label: 'BMJ Clicks',
                        data: [],
                        borderColor: '#FFC000',
                        backgroundColor: 'rgba(255, 192, 0, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
    }

    if (state.charts.clientTrend) {
        state.charts.clientTrend.data.labels = data.dailyData.map(d =>
            new Date(d.date).toLocaleDateString()
        );
        state.charts.clientTrend.data.datasets[0].data = data.dailyData.map(d => d.views);
        state.charts.clientTrend.data.datasets[1].data = data.dailyData.map(d => d.clicks);
        state.charts.clientTrend.update();
    }
}

async function exportClientReport(format) {
    if (!window.currentClientReport) {
        showToast('No report to export', 'warning');
        return;
    }

    if (format === 'csv') {
        let csv = 'Date,Client,Page Views,BMJ Clicks,CTR,Owed\n';
        window.currentClientReport.dailyData.forEach(day => {
            csv += `${day.date},${day.clientName},${day.views},${day.clicks},${((day.clicks/day.views)*100).toFixed(2)}%,£${day.revenue.toFixed(2)}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `client-report-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        showToast('CSV exported successfully', 'success');
    } else {
        // Similar PDF export logic as billing
        showToast('PDF export opened in new window', 'success');
    }
}

// Add these functions to window for onclick access
window.generateClientReport = generateClientReport;
window.exportClientReport = exportClientReport;


// Profile Modal Functions
function openProfileModal() {
    loadUserProfile();
    document.getElementById('profileModal').classList.add('active');
}

function closeProfileModal() {
    document.getElementById('profileModal').classList.remove('active');
}

function loadUserProfile() {
    const userInfo = JSON.parse(localStorage.getItem('userInfo')) || {};
    const sessionToken = localStorage.getItem('sessionToken');

    // Update profile information
    document.getElementById('profileUserName').textContent = userInfo.username || 'Admin User';
    document.getElementById('profileUserRole').textContent = 'Administrator';
    document.getElementById('profileEmail').textContent = userInfo.email || 'admin@bmj.com';

    // Generate initials
    const name = userInfo.username || userInfo.email || 'Admin User';
    const initials = name.split(' ').map(word => word[0]).join('').toUpperCase().slice(0, 2);
    document.getElementById('userInitials').textContent = initials;

    // Set authentication method
    const authMethod = userInfo.authMethod === 'cognito' ? 'AWS Cognito' : 'Local Authentication';
    document.getElementById('profileAuthMethod').textContent = authMethod;

    // Update authentication status
    const authStatusDot = document.getElementById('authStatusDot');
    const authStatusText = document.getElementById('authStatusText');

    if (userInfo.authMethod === 'cognito') {
        authStatusDot.className = 'status-indicator connected';
        authStatusText.textContent = 'Connected';
        authStatusText.style.color = '#10b981';
    } else {
        authStatusDot.className = 'status-indicator connected';
        authStatusText.textContent = 'Active';
        authStatusText.style.color = '#3b82f6';
    }

    // Set user ID
    document.getElementById('profileUserId').textContent = userInfo.userSub || 'usr_' + Math.random().toString(36).substr(2, 8);

    // Set creation date
    const createdDate = userInfo.createdAt ? new Date(userInfo.createdAt).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    }) : 'Unknown';
    document.getElementById('profileCreatedDate').textContent = createdDate;

    // Set last login (current time for active session)
    document.getElementById('profileLastLogin').textContent = 'Just now';

    // Update password change date based on auth method
    if (userInfo.authMethod === 'cognito') {
        document.getElementById('passwordChanged').textContent = 'Managed by Cognito';
    } else {
        document.getElementById('passwordChanged').textContent = 'Unknown';
    }
}

// Sign Out Modal Functions
function showSignOutModal() {
    closeProfileModal(); // Close profile modal first
    document.getElementById('signOutModal').classList.add('active');
}

function closeSignOutModal() {
    document.getElementById('signOutModal').classList.remove('active');
}

function confirmSignOut() {
    // Clear local storage
    localStorage.removeItem('sessionToken');
    localStorage.removeItem('userInfo');

    // Close modal
    closeSignOutModal();

    // Redirect to login
    window.location.href = '/login';
}

// Close modals when clicking outside
document.addEventListener('click', function(event) {
    const profileModal = document.getElementById('profileModal');
    const signOutModal = document.getElementById('signOutModal');

    if (event.target === profileModal) {
        closeProfileModal();
    }

    if (event.target === signOutModal) {
        closeSignOutModal();
    }
});

function logoutUser() {
    if (confirm('Are you sure you want to sign out?')) {
        // Clear local storage
        localStorage.removeItem('sessionToken');
        localStorage.removeItem('userInfo');

        // Redirect to login
        window.location.href = '/login';
    }
}


    // Test function to simulate clicks
window.simulateClick = function(count = 1) {
    for (let i = 0; i < count; i++) {
        setTimeout(() => {
            window.postMessage({
                type: 'bmj-careers-tracking',
                eventType: 'job_click',
                clientId: TEST_CLIENT_ID,
                client_id: TEST_CLIENT_ID,
                timestamp: Date.now(),
                data: {
                    jobId: 'test-' + Date.now(),
                    jobTitle: 'Test Job',
                    clickType: 'bmj_redirect'
                }
            }, '*');
        }, i * 100);
    }
    console.log(`Simulating ${count} clicks...`);
};

console.log('💡 Use window.simulateClick(5) to test click tracking');


    console.log('[BMJ] Enhanced Careers Admin Console loaded successfully');
    console.log('Session:', sessionToken);
    console.log('Use window.debugState() to inspect current state');
    console.log('Use window.refreshData() to reload dashboard');
    console.log('- window.testTrackingEvent(clientId) - Test with mock event');
    console.log('- window.simulateClientActivity() - Simulate multiple clients');
</script>
</body>
</html>
