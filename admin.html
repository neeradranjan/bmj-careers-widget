<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console - BMJ Careers</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        /* Enhanced React-like styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0066cc;
            --primary-dark: #0052a3;
            --secondary: #48bb78;
            --danger: #f56565;
            --warning: #FFC000;
            --info: #4299e1;
            --dark: #1d1d1b;
            --gray: #6b7280;
            --light: #f0f4f8;
            --white: #ffffff;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 25px rgba(0,0,0,0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background: #f0f4f8;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            color: var(--dark);
            line-height: 1.6;
        }

        /* Loading States */
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* App Container */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--white);
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
            color: var(--white);
        }

        .sidebar-logo {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar-menu {
            padding: 1rem 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 0.875rem 1.5rem;
            color: var(--gray);
            text-decoration: none;
            transition: var(--transition);
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.9375rem;
            position: relative;
            overflow: hidden;
        }

        .menu-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: var(--primary);
            transform: translateX(-100%);
            transition: var(--transition);
        }

        .menu-item:hover {
            color: var(--primary);
            background: rgba(102, 126, 234, 0.05);
        }

        .menu-item.active {
            color: var(--primary);
            background: rgba(102, 126, 234, 0.1);
            font-weight: 600;
        }

        .menu-item.active::before {
            transform: translateX(0);
        }

        .menu-icon {
            width: 20px;
            height: 20px;
            margin-right: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            transition: var(--transition);
        }

        /* Header */
        .header {
            background: var(--white);
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--light);
            border-radius: 9999px;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-menu:hover {
            background: #e2e8f0;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        /* Content Area */
        .content {
            padding: 2rem;
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            overflow: hidden;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--dark);
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .stat-icon.primary {
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary);
        }

        .stat-icon.success {
            background: rgba(72, 187, 120, 0.1);
            color: var(--secondary);
        }

        .stat-icon.warning {
            background: rgba(237, 137, 54, 0.1);
            color: var(--warning);
        }

        .stat-icon.info {
            background: rgba(66, 153, 225, 0.1);
            color: var(--info);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.875rem;
        }

        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .stat-change.positive {
            background: rgba(72, 187, 120, 0.1);
            color: var(--secondary);
        }

        .stat-change.negative {
            background: rgba(245, 101, 101, 0.1);
            color: var(--danger);
        }

        /* Real-time Indicator */
        .real-time-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.875rem;
            background: #48bb78;
            color: var(--white);
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.8;
            }
        }

        .real-time-dot {
            width: 6px;
            height: 6px;
            background: var(--white);
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Session Cards */
        .session-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .session-card {
            background: var(--white);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            position: relative;
        }

        .session-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .session-card.active {
            border: 2px solid var(--secondary);
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .session-client {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9375rem;
        }

        .session-id {
            font-size: 0.625rem;
            color: var(--gray);
            font-family: monospace;
        }

        .session-badge {
            padding: 0.25rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.625rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .session-badge.active {
            background: rgba(72, 187, 120, 0.1);
            color: var(--secondary);
        }

        .session-badge.idle {
            background: rgba(237, 137, 54, 0.1);
            color: var(--warning);
        }

        .session-badge.ended {
            background: rgba(113, 128, 150, 0.1);
            color: var(--gray);
        }

        .session-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .metric-mini {
            text-align: center;
            padding: 0.5rem;
            background: var(--light);
            border-radius: 6px;
        }

        .metric-mini-value {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--primary);
        }

        .metric-mini-label {
            font-size: 0.625rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Activity Feed */
        .activity-feed {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: start;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            transition: var(--transition);
        }

        .activity-item:hover {
            background: var(--light);
        }

        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .activity-icon.load {
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary);
        }

        .activity-icon.click {
            background: rgba(237, 137, 54, 0.1);
            color: var(--warning);
        }

        .activity-icon.api {
            background: rgba(66, 153, 225, 0.1);
            color: var(--info);
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.875rem;
            margin-bottom: 0.125rem;
        }

        .activity-description {
            color: var(--gray);
            font-size: 0.75rem;
        }

        .activity-time {
            color: var(--gray);
            font-size: 0.75rem;
            white-space: nowrap;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }

        /* Buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--dark);
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-success {
            background: var(--secondary);
            color: var(--white);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-sm {
            padding: 0.375rem 0.875rem;
            font-size: 0.75rem;
        }

        .btn-warning {
            background: #FFC000;
            color: #1d1d1b;
        }

        .btn-warning:hover {
            background: #e6ac00;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--light);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e2e8f0;
        }

        td {
            padding: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.875rem;
        }

        tr:hover {
            background: var(--light);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            padding: 2rem;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease-out;
            box-shadow: var(--shadow-xl);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .session-grid {
                grid-template-columns: 1fr;
            }

            .header-content {
                padding: 1rem;
            }

            .content {
                padding: 1rem;
            }
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Notification Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--white);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 300px;
            transform: translateX(400px);
            transition: transform 0.3s ease-out;
            z-index: 3000;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .toast.success .toast-icon {
            background: rgba(72, 187, 120, 0.1);
            color: var(--secondary);
        }

        .toast.error .toast-icon {
            background: rgba(245, 101, 101, 0.1);
            color: var(--danger);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.125rem;
        }

        .toast-message {
            font-size: 0.875rem;
            color: var(--gray);
        }

        /* Section Display */
        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            z-index: 999;
        }

        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .empty-state-description {
            font-size: 0.875rem;
        }

        /* Settings Form */
        .settings-form {
            display: grid;
            gap: 1.5rem;
        }

        .form-group {
            display: grid;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 500;
            color: var(--dark);
            font-size: 0.875rem;
        }

        .form-input {
            padding: 0.625rem 0.875rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-select {
            padding: 0.625rem 0.875rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.875rem;
            background: var(--white);
            cursor: pointer;
        }

        .form-help {
            font-size: 0.75rem;
            color: var(--gray);
        }

        /* Client Detail View */
        .client-detail-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 1024px) {
            .client-detail-grid {
                grid-template-columns: 1fr;
            }
        }

        .info-row {
            display: flex;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .info-label {
            font-weight: 500;
            color: var(--gray);
            width: 140px;
            flex-shrink: 0;
        }

        .info-value {
            color: var(--dark);
        }

        /* Revenue Calculator */
        .revenue-calculator {
            background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
            color: var(--white);
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
        }

        .revenue-amount {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .revenue-period {
            opacity: 0.9;
            font-size: 1.125rem;
        }

        .revenue-breakdown {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .breakdown-item {
            text-align: center;
        }

        .breakdown-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .breakdown-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* Code blocks and tabs */
        .code-block {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .code-block code {
            font-family: 'Courier New', monospace;
            color: #0066cc;
            font-size: 0.875rem;
        }

        .api-section {
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 2rem;
        }

        .api-section:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .code-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .code-tab {
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border: 1px solid #e2e8f0;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .code-tab.active {
            background: #0066cc;
            color: white;
            border-color: #0066cc;
        }

        .code-example {
            display: none;
            background: #1e293b;
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 0 8px 8px 8px;
            overflow-x: auto;
            margin: 0;
        }

        .code-example.active {
            display: block;
        }

        .code-example code {
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 0.8125rem;
            line-height: 1.6;
        }

        .json-viewer {
            background: #1e293b;
            border-radius: 8px;
            padding: 1rem;
            max-height: 500px;
            overflow: auto;
        }

        .json-viewer pre {
            margin: 0;
            color: #e2e8f0;
            font-size: 0.8125rem;
        }

        .json-viewer .json-key {
            color: #60a5fa;
        }

        .json-viewer .json-string {
            color: #86efac;
        }

        .json-viewer .json-number {
            color: #fbbf24;
        }

        .json-viewer .json-boolean {
            color: #c084fc;
        }

        /* User dropdown styles */
        .user-dropdown {
            position: relative;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--light);
            border-radius: 9999px;
            cursor: pointer;
            transition: var(--transition);
        }

        .dropdown-arrow {
            font-size: 0.75rem;
            transition: transform 0.3s ease;
        }

		.user-dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: var(--white);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            min-width: 220px;
            display: none;
            z-index: 1000;
            overflow: hidden;
        }

        .user-dropdown-menu.show {
            display: block;
            animation: dropdownFadeIn 0.2s ease-out;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-header {
            padding: 1rem;
            background: var(--light);
        }

        .user-email {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .user-role {
            font-size: 0.75rem;
            color: var(--gray);
        }

        .dropdown-divider {
            height: 1px;
            background: #e5e7eb;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--dark);
            text-decoration: none;
            transition: background 0.2s ease;
        }

        .dropdown-item:hover {
            background: var(--light);
        }

        .dropdown-icon {
            font-size: 1rem;
        }

        /* Enhanced tracking styles */
        .tracking-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary);
            border-radius: 9999px;
            font-size: 0.625rem;
            font-weight: 600;
        }

        .iframe-indicator {
            background: rgba(237, 137, 54, 0.1);
            color: var(--warning);
        }

        .client-identifier {
            font-family: monospace;
            background: var(--light);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .usage-metric {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .usage-metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: var(--gray);
            font-size: 0.875rem;
        }

        .metric-value {
            font-weight: 600;
            color: var(--dark);
        }

        /* Enhanced JSON viewer */
        .json-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .json-stats {
            display: flex;
            gap: 2rem;
            padding: 1rem;
            background: var(--light);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .json-stat {
            display: flex;
            flex-direction: column;
        }

        .json-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .json-stat-label {
            font-size: 0.75rem;
            color: var(--gray);
            text-transform: uppercase;
        }

        /* Live tracking indicator */
        .tracking-live {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            background: rgba(72, 187, 120, 0.1);
            color: var(--secondary);
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .tracking-live::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--secondary);
            border-radius: 50%;
            animation: pulse-dot 2s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        /* Client usage heatmap */
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            gap: 2px;
            margin-top: 1rem;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            background: var(--light);
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }

        .heatmap-cell.low { background: rgba(102, 126, 234, 0.2); }
        .heatmap-cell.medium { background: rgba(102, 126, 234, 0.5); }
        .heatmap-cell.high { background: rgba(102, 126, 234, 0.8); }
        .heatmap-cell.peak { background: var(--primary); }

        .heatmap-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: var(--white);
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
        }

        .heatmap-cell:hover .heatmap-tooltip {
            opacity: 1;
        }

        /* Enhanced Responsive Design */
@media (max-width: 1200px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .client-detail-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .sidebar {
        transform: translateX(-100%);
        width: 240px;
    }

    .sidebar.active {
        transform: translateX(0);
    }

    .main-content {
        margin-left: 0;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .session-grid {
        grid-template-columns: 1fr;
    }

    .header-content {
        padding: 0.75rem 1rem;
    }

    .header-title {
        font-size: 1.25rem;
    }

    .content {
        padding: 1rem;
    }

    .card-header {
        padding: 1rem;
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
    }

    .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .revenue-breakdown {
        grid-template-columns: 1fr;
    }

    .activity-feed {
        max-height: 300px;
    }
}

@media (max-width: 480px) {
    .sidebar {
        width: 100%;
    }

    .header-actions {
        gap: 0.5rem;
    }

    .user-menu span {
        display: none;
    }

    .user-menu .user-avatar {
        margin: 0;
    }

    .btn {
        padding: 0.5rem 0.875rem;
        font-size: 0.8125rem;
    }

    .stat-value {
        font-size: 1.5rem;
    }

    .modal-content {
        width: 95%;
        padding: 1.5rem;
    }
}

/* Sticky table headers on mobile */
@media (max-width: 768px) {
    .table-container {
        max-height: 400px;
        position: relative;
    }

    thead {
        position: sticky;
        top: 0;
        z-index: 10;
        background: var(--white);
    }
}

/* Improved mobile menu toggle */
.mobile-menu-toggle {
    display: none;
    position: fixed;
    top: 1rem;
    left: 1rem;
    width: 44px;
    height: 44px;
    background: var(--primary);
    color: var(--white);
    border: none;
    border-radius: 8px;
    font-size: 1.25rem;
    cursor: pointer;
    box-shadow: var(--shadow-md);
    z-index: 1001;
    align-items: center;
    justify-content: center;
}

@media (max-width: 768px) {
    .mobile-menu-toggle {
        display: flex;
    }
}

/* Sidebar overlay for mobile */
.sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
}

.sidebar-overlay.active {
    display: block;
}

@media (max-width: 768px) {
    .sidebar.active ~ .sidebar-overlay {
        display: block;
    }
}
    </style>
</head>
<body>
<div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <span>üè•</span>
                <span>BMJ Careers Admin</span>
            </div>
        </div>
        <nav class="sidebar-menu">
            <button class="menu-item active" onclick="showSection('dashboard')">
                <span class="menu-icon">üìä</span>
                <span>Dashboard</span>
            </button>
            <button class="menu-item" onclick="showSection('sessions')">
                <span class="menu-icon">üë•</span>
                <span>Live Sessions</span>
            </button>
            <button class="menu-item" onclick="showSection('clients')">
                <span class="menu-icon">üè¢</span>
                <span>Clients</span>
            </button>
            <button class="menu-item" onclick="showSection('analytics')">
                <span class="menu-icon">üìà</span>
                <span>Analytics</span>
            </button>
            <button class="menu-item" onclick="showSection('revenue')">
                <span class="menu-icon">üí∞</span>
                <span>Revenue</span>
            </button>
            <button class="menu-item" onclick="showSection('api')">
                <span class="menu-icon">üîë</span>
                <span>API Keys</span>
            </button>
            <button class="menu-item" onclick="showSection('activity')">
                <span class="menu-icon">‚ö°</span>
                <span>Activity Feed</span>
            </button>
            <button class="menu-item" onclick="showSection('jobsdata')">
                <span class="menu-icon">üìã</span>
                <span>Jobs Data</span>
            </button>
            <button class="menu-item" onclick="showSection('settings')">
                <span class="menu-icon">‚öôÔ∏è</span>
                <span>Settings</span>
            </button>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1 class="header-title" id="pageTitle">Dashboard</h1>
                <div class="header-actions">
                    <span class="real-time-indicator">
                        <span class="real-time-dot"></span>
                        <span>Live</span>
                    </span>
                    <div class="user-dropdown">
                        <div class="user-menu" onclick="toggleUserDropdown()">
                            <div class="user-avatar" id="userAvatar">A</div>
                            <span id="userName">Admin</span>
                            <span class="dropdown-arrow">‚ñº</span>
                        </div>
                        <div class="user-dropdown-menu" id="userDropdownMenu">
                            <div class="dropdown-header">
                                <div class="user-email" id="userEmail">admin@bmj.com</div>
                                <div class="user-role">Administrator</div>
                            </div>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item" onclick="showProfile()">
                                <span class="dropdown-icon">üë§</span>
                                Profile Settings
                            </a>
                            <a href="#" class="dropdown-item" onclick="logout()">
                                <span class="dropdown-icon">üö™</span>
                                Logout
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content -->
        <div class="content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section active">
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon primary">üè¢</div>
                        <div class="stat-value" id="totalClients">0</div>
                        <div class="stat-label">Total Clients</div>
                        <div class="stat-change positive">
                            <span>‚Üë 12%</span> vs last month
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon success">üë•</div>
                        <div class="stat-value" id="activeSessions">0</div>
                        <div class="stat-label">Active Sessions</div>
                        <div class="stat-change positive">
                            <span>‚Üë 8%</span> vs yesterday
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon warning">üìä</div>
                        <div class="stat-value" id="totalPageViews">0</div>
                        <div class="stat-label">Page Views Today</div>
                        <div class="stat-change negative">
                            <span>‚Üì 3%</span> vs yesterday
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon info">üí∞</div>
                        <div class="stat-value" id="monthlyRevenue">¬£0</div>
                        <div class="stat-label">Monthly Revenue</div>
                        <div class="stat-change positive">
                            <span>‚Üë 25%</span> vs last month
                        </div>
                    </div>
                </div>

                <!-- Recent Sessions with Enhanced Tracking -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Recent Sessions</h2>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <span class="tracking-live">Tracking Active</span>
                            <button class="btn btn-primary btn-sm" onclick="showSection('sessions')">
                                View All
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="session-grid" id="recentSessions">
                            <!-- Sessions will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Usage Chart -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Usage Trends</h2>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-secondary active" onclick="updateUsageChart('7d')">7 Days</button>
                            <button class="btn btn-sm btn-secondary" onclick="updateUsageChart('30d')">30 Days</button>
                            <button class="btn btn-sm btn-secondary" onclick="updateUsageChart('90d')">90 Days</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="usageChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Jobs Data Section -->
            <section id="jobsdata" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Jobs Data API</h2>
                    </div>
                    <div class="card-body">
                        <!-- Dynamic API Endpoints -->
                        <div class="api-section">
                            <h3 style="margin-bottom: 1rem;">API Endpoints</h3>

                            <!-- Public endpoint without auth -->
                            <div style="margin-bottom: 1rem;">
                                <h4 style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">Public Endpoint (No Authentication)</h4>
                                <div class="code-block">
                                    <code id="publicEndpoint"></code>
                                    <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('publicEndpoint')">
                                        Copy URL
                                    </button>
                                </div>
                            </div>

                            <!-- Authenticated endpoint -->
                            <div>
                                <h4 style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">Authenticated Endpoint (Requires API Key)</h4>
                                <div class="code-block">
                                    <code id="authEndpoint"></code>
                                    <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('authEndpoint')">
                                        Copy URL
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Jobs Data Preview -->
                        <div class="api-section" style="margin-top: 2rem;">
                            <h3 style="margin-bottom: 1rem;">Jobs Data Structure</h3>
                            <div class="json-controls">
                                <button class="btn btn-primary" onclick="loadJobsData()">
                                    Load Current Jobs
                                </button>
                                <button class="btn btn-secondary" onclick="downloadJobsData()">
                                    Download JSON
                                </button>
                                <button class="btn btn-secondary" onclick="refreshJobsData()">
                                    üîÑ Refresh
                                </button>
                                <span id="jobsCount" style="align-self: center; color: var(--gray);">
                                    Click to load jobs data
                                </span>
                            </div>

                            <div class="json-stats" id="jobsStats" style="display: none;">
                                <div class="json-stat">
                                    <div class="json-stat-value" id="totalJobsCount">0</div>
                                    <div class="json-stat-label">Total Jobs</div>
                                </div>
                                <div class="json-stat">
                                    <div class="json-stat-value" id="newJobsCount">0</div>
                                    <div class="json-stat-label">New Jobs</div>
                                </div>
                                <div class="json-stat">
                                    <div class="json-stat-value" id="updatedJobsCount">0</div>
                                    <div class="json-stat-label">Updated</div>
                                </div>
                                <div class="json-stat">
                                    <div class="json-stat-value" id="dataSource">-</div>
                                    <div class="json-stat-label">Source</div>
                                </div>
                            </div>

                            <div class="json-viewer" id="jobsDataViewer">
                                <pre><code>// Jobs data will appear here</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Live Sessions Section -->
            <section id="sessions" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Live Sessions Monitor</h2>
                        <div class="header-actions">
                            <span class="badge" id="sessionCount">0 Active</span>
                            <button class="btn btn-sm btn-secondary" onclick="refreshSessions()">
                                üîÑ Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="sessionsContainer">
                            <!-- Live sessions will be loaded here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Clients Section -->
            <section id="clients" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Client Management</h2>
                        <input type="text"
                               class="form-input"
                               placeholder="Search clients..."
                               style="width: 300px; max-width: 100%;"
                               id="clientSearchInput"
                               onkeyup="searchClients(this.value)">
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>Domain</th>
                                    <th>Sessions</th>
                                    <th>Page Views</th>
                                    <th>Clicks</th>
                                    <th>Revenue</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="clientsTable">
                                <!-- Clients will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analytics" class="section">
                <div class="stats-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Session Distribution</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="sessionDistChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Revenue by Client Type</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">Geographic Distribution</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="geoChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Revenue Section -->
            <section id="revenue" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Revenue Calculator</h2>
                    </div>
                    <div class="card-body">
                        <div class="settings-form">
                            <div class="form-group">
                                <label class="form-label">Select Client</label>
                                <select class="form-select" id="revenueClient">
                                    <option value="">All Clients</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Billing Period</label>
                                <select class="form-select" id="revenuePeriod">
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month" selected>This Month</option>
                                    <option value="quarter">This Quarter</option>
                                    <option value="year">This Year</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Pricing Model</label>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                    <div>
                                        <label class="form-label">Per Page View</label>
                                        <input type="number" class="form-input" id="costPerView" value="0.02" step="0.01">
                                    </div>
                                    <div>
                                        <label class="form-label">Per Click</label>
                                        <input type="number" class="form-input" id="costPerClick" value="0.50" step="0.01">
                                    </div>
                                    <div>
                                        <label class="form-label">Per Session</label>
                                        <input type="number" class="form-input" id="costPerSession" value="0.10" step="0.01">
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="calculateRevenue()">
                                Calculate Revenue
                            </button>
                        </div>

                        <div id="revenueResult" style="display: none; margin-top: 2rem;">
                            <div class="revenue-calculator">
                                <div class="revenue-amount" id="totalRevenue">¬£0.00</div>
                                <div class="revenue-period" id="revenuePeriodText">This Month</div>
                                <div class="revenue-breakdown">
                                    <div class="breakdown-item">
                                        <div class="breakdown-value" id="viewsCount">0</div>
                                        <div class="breakdown-label">Page Views</div>
                                    </div>
                                    <div class="breakdown-item">
                                        <div class="breakdown-value" id="clicksCount">0</div>
                                        <div class="breakdown-label">Clicks</div>
                                    </div>
                                    <div class="breakdown-item">
                                        <div class="breakdown-value" id="sessionsCount">0</div>
                                        <div class="breakdown-label">Sessions</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- API Keys Section -->
            <section id="api" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">API Key Management</h2>
                        <button class="btn btn-primary" onclick="showGenerateKeyModal()">
                            Generate New Key
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>API Key</th>
                                    <th>Created</th>
                                    <th>Usage</th>
                                    <th>Last Used</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="apiKeysTable">
                                <!-- API keys will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Activity Feed Section -->
            <section id="activity" class="section">
                <div class="stats-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Page Loads</h3>
                            <span class="real-time-indicator">
                    <span class="real-time-dot"></span>
                    <span>Live</span>
                </span>
                        </div>
                        <div class="card-body">
                            <div class="activity-feed" id="loadsFeed">
                                <!-- Activity items will be loaded here -->
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Clicks</h3>
                            <span class="real-time-indicator">
                    <span class="real-time-dot"></span>
                    <span>Live</span>
                </span>
                        </div>
                        <div class="card-body">
                            <div class="activity-feed" id="clicksFeed">
                                <!-- Activity items will be loaded here -->
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">API Calls</h3>
                            <span class="real-time-indicator">
                    <span class="real-time-dot"></span>
                    <span>Live</span>
                </span>
                        </div>
                        <div class="card-body">
                            <div class="activity-feed" id="apiFeed">
                                <!-- Activity items will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">System Settings</h2>
                    </div>
                    <div class="card-body">
                        <div class="settings-form">
                            <h3 style="margin-bottom: 1rem;">Tracking Settings</h3>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="trackLocalhost" checked onchange="saveSettings()">
                                    Track Localhost Sessions
                                </label>
                                <div class="form-help">Enable tracking for localhost development sessions</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="trackInternalIPs" checked onchange="saveSettings()">
                                    Track Internal IPs
                                </label>
                                <div class="form-help">Track sessions from internal network IPs</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Session Timeout (minutes)</label>
                                <input type="number" class="form-input" id="sessionTimeout" value="30" onchange="saveSettings()">
                                <div class="form-help">Consider session ended after this many minutes of inactivity</div>
                            </div>

                            <h3 style="margin: 2rem 0 1rem;">Notification Settings</h3>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="enableNotifications" checked onchange="saveSettings()">
                                    Enable Real-time Notifications
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Alert Threshold (concurrent sessions)</label>
                                <input type="number" class="form-input" id="alertThreshold" value="100" onchange="saveSettings()">
                                <div class="form-help">Send alert when concurrent sessions exceed this number</div>
                            </div>

                            <h3 style="margin: 2rem 0 1rem;">Data Retention</h3>
                            <div class="form-group">
                                <label class="form-label">Keep Session Data For</label>
                                <select class="form-select" id="dataRetention" onchange="saveSettings()">
                                    <option value="7">7 days</option>
                                    <option value="30">30 days</option>
                                    <option value="90" selected>90 days</option>
                                    <option value="180">180 days</option>
                                    <option value="365">1 year</option>
                                </select>
                            </div>

                            <button class="btn btn-primary" onclick="exportAllData()">
                                Export All Data
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast">
    <div class="toast-icon" id="toastIcon">‚úì</div>
    <div class="toast-content">
        <div class="toast-title" id="toastTitle">Success</div>
        <div class="toast-message" id="toastMessage">Operation completed successfully</div>
    </div>
</div>

<script>
    // Global state
    let state = {
        clients: [],
        sessions: [],
        apiKeys: [],
        charts: {},
        jobsData: null,
        currentOrigin: window.location.origin,
        settings: {
            trackLocalhost: true,
            trackInternalIPs: true,
            sessionTimeout: 30,
            enableNotifications: true,
            alertThreshold: 100,
            dataRetention: 90
        },
        refreshInterval: null
    };

    // Initialize dynamic endpoints
    function initializeDynamicEndpoints() {
        const origin = window.location.origin;

        // Update public endpoint
        document.getElementById('publicEndpoint').textContent = `${origin}/api/jobs`;

        // Update authenticated endpoint
        document.getElementById('authEndpoint').textContent = `${origin}/api/v1/jobs`;

        // Update all code examples dynamically
        updateCodeExamples(origin);
    }

    // Update code examples with current origin
    function updateCodeExamples(origin) {
        // This will be called when showing code tabs
        window.currentApiOrigin = origin;
    }

    // Enhanced authentication check
    const sessionToken = localStorage.getItem('sessionToken');
    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');

    if (!sessionToken || !userInfo.email) {
        window.location.href = '/login?redirect=/admin';
    }

    // Set user info
    document.getElementById('userName').textContent = userInfo.username || 'Admin';
    document.getElementById('userEmail').textContent = userInfo.email || 'admin@bmj.com';
    document.getElementById('userAvatar').textContent = (userInfo.username || 'Admin').charAt(0).toUpperCase();

    // Toggle user dropdown
    function toggleUserDropdown() {
        const dropdown = document.getElementById('userDropdownMenu');
        dropdown.classList.toggle('show');

        // Close dropdown when clicking outside
        document.addEventListener('click', function closeDropdown(e) {
            if (!e.target.closest('.user-dropdown')) {
                dropdown.classList.remove('show');
                document.removeEventListener('click', closeDropdown);
            }
        });
    }

    // Enhanced logout function
    async function logout() {
        try {
            await fetch('/api/auth/logout', {
                method: 'POST',
                headers: {
                    'x-session-token': sessionToken
                }
            });

            localStorage.removeItem('sessionToken');
            localStorage.removeItem('userInfo');
            window.location.href = state.currentOrigin;
        } catch (error) {
            console.error('Logout error:', error);
            localStorage.clear();
            window.location.href = '/';
        }
    }

    // Initialize on DOM load
    document.addEventListener('DOMContentLoaded', () => {
        initializeDynamicEndpoints();
        loadSettings();
        initializeCharts();
        loadDashboard();
        startRealTimeUpdates();
    });

    // Initialize charts
    function initializeCharts() {
        // Usage Chart
        const usageCtx = document.getElementById('usageChart').getContext('2d');
        state.charts.usage = new Chart(usageCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Page Views',
                    data: [],
                    borderColor: '#0066cc',
                    backgroundColor: 'rgba(0, 102, 204, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Job Clicks',
                    data: [],
                    borderColor: '#FFC000',
                    backgroundColor: 'rgba(255, 192, 0, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Sessions',
                    data: [],
                    borderColor: '#48bb78',
                    backgroundColor: 'rgba(72, 187, 120, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                if (context.dataset.label === 'Job Clicks') {
                                    return 'Revenue: ¬£' + (context.parsed.y * 0.50).toFixed(2);
                                }
                                return '';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Enhanced load dashboard with iframe tracking
    async function loadDashboard() {
        try {
            const response = await fetch('/api/admin/dashboard', {
                headers: {
                    'x-session-token': sessionToken
                }
            });

            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = '/login?redirect=/admin';
                    return;
                }
                throw new Error('Failed to load dashboard');
            }

            const data = await response.json();
            processDashboardData(data.data);
            updateDashboard();
            showToast('Dashboard refreshed', 'success');

        } catch (error) {
            console.error('Dashboard error:', error);
            showToast('Failed to load dashboard', 'error');
        }
    }

    // Enhanced process dashboard data
    function processDashboardData(data) {
        // Process sessions with enhanced tracking info
        state.sessions = (data.clients || []).map(session => {
            const isIframe = session.utm_medium === 'iframe';
            const clientIdentifier = extractClientIdentifier(session);

            return {
                ...session,
                clientIdentifier,
                isIframe,
                displayName: session.name || clientIdentifier,
                domain: session.domain || 'Unknown',
                duration: calculateDuration(session),
                isActive: isSessionActive(session),
                revenue: calculateSessionRevenue(session)
            };
        });

        // Aggregate unique clients
        const clientMap = {};
        state.sessions.forEach(session => {
            const key = session.clientIdentifier;

            if (!clientMap[key]) {
                clientMap[key] = {
                    clientId: key,
                    name: session.displayName,
                    domain: session.domain,
                    isIframe: session.isIframe,
                    sessions: [],
                    totalMetrics: {
                        loads: 0,
                        clicks: 0,
                        apiCalls: 0,
                        revenue: 0
                    }
                };
            }

            clientMap[key].sessions.push(session);
            clientMap[key].totalMetrics.loads += session.totalMetrics?.loads || 0;
            clientMap[key].totalMetrics.clicks += session.totalMetrics?.clicks || 0;
            clientMap[key].totalMetrics.apiCalls += session.totalMetrics?.apiCalls || 0;
            clientMap[key].totalMetrics.revenue += session.revenue;
        });

        state.clients = Object.values(clientMap);
        state.apiKeys = data.publicApiKeys || [];
    }

    // Extract client identifier from session
    function extractClientIdentifier(session) {
        // For iframe embeds, extract domain from referer
        if (session.utm_medium === 'iframe' && session.domain) {
            try {
                const url = new URL(session.domain);
                return url.hostname;
            } catch (e) {
                // Fallback
            }
        }

        // Use UTM source if available
        if (session.utm_source && session.utm_source !== 'direct') {
            return session.utm_source;
        }

        // Use client ID
        return session.clientId || 'unknown';
    }

    // Calculate session duration
    function calculateDuration(session) {
        const start = new Date(session.firstSeen);
        const end = new Date(session.lastSeen);
        const diff = end - start;

        const hours = Math.floor(diff / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);

        if (hours > 0) return `${hours}h ${minutes}m`;
        if (minutes > 0) return `${minutes}m ${seconds}s`;
        return `${seconds}s`;
    }

    // Check if session is active
    function isSessionActive(session) {
        const lastSeen = new Date(session.lastSeen);
        const now = new Date();
        const diffMinutes = (now - lastSeen) / 60000;
        return diffMinutes < state.settings.sessionTimeout;
    }

    // Calculate session revenue
    function calculateSessionRevenue(session) {
        const loads = session.totalMetrics?.loads || 0;
        const clicks = session.totalMetrics?.clicks || 0;
        const apiCalls = session.totalMetrics?.apiCalls || 0;

        // Default pricing
        const costPerView = 0.02;
        const costPerClick = 0.50;
        const costPerSession = 0.10;
        const costPerApi = 0.05;

        return (loads * costPerView) + (clicks * costPerClick) + (apiCalls * costPerApi) + costPerSession;
    }

    // Update dashboard UI
    function updateDashboard() {
        // Update stats with enhanced tracking
        const activeSessions = state.sessions.filter(s => s.isActive).length;
        const iframeSessions = state.sessions.filter(s => s.isIframe).length;
        const totalPageViews = state.sessions.reduce((sum, s) => sum + (s.todayMetrics?.loads || 0), 0);
        const monthlyRevenue = state.sessions.reduce((sum, s) => sum + s.revenue, 0);

        document.getElementById('totalClients').textContent = state.clients.length;
        document.getElementById('activeSessions').textContent = activeSessions;
        document.getElementById('totalPageViews').textContent = totalPageViews.toLocaleString();
        document.getElementById('monthlyRevenue').textContent = `¬£${monthlyRevenue.toFixed(2)}`;

        updateRecentSessions();
        updateCharts();
    }

    // Enhanced update recent sessions with iframe indicators
    function updateRecentSessions() {
        const container = document.getElementById('recentSessions');
        const recentSessions = state.sessions
            .sort((a, b) => new Date(b.lastSeen) - new Date(a.lastSeen))
            .slice(0, 6);

        if (recentSessions.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üë•</div>
                    <div class="empty-state-title">No sessions yet</div>
                    <div class="empty-state-description">Sessions will appear here when clients visit</div>
                </div>
            `;
            return;
        }

        container.innerHTML = recentSessions.map(session => `
            <div class="session-card ${session.isActive ? 'active' : ''}">
                <div class="session-header">
                    <div>
                        <div class="session-client">
                            ${session.displayName}
                            ${session.isIframe ? '<span class="tracking-badge iframe-indicator">iFrame</span>' : ''}
                        </div>
                        <div class="client-identifier">${session.clientIdentifier}</div>
                    </div>
                    <span class="session-badge ${session.isActive ? 'active' : 'ended'}">
                        ${session.isActive ? '‚óè Active' : '‚óã Ended'}
                    </span>
                </div>
                <div class="session-metrics">
                    <div class="metric-mini">
                        <div class="metric-mini-value">${session.totalMetrics?.loads || 0}</div>
                        <div class="metric-mini-label">Views</div>
                    </div>
                    <div class="metric-mini">
                        <div class="metric-mini-value">${session.totalMetrics?.clicks || 0}</div>
                        <div class="metric-mini-label">Clicks</div>
                    </div>
                    <div class="metric-mini">
                        <div class="metric-mini-value">${session.duration}</div>
                        <div class="metric-mini-label">Duration</div>
                    </div>
                    <div class="metric-mini">
                        <div class="metric-mini-value">¬£${session.revenue.toFixed(2)}</div>
                        <div class="metric-mini-label">Revenue</div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Update charts with real data
    function updateCharts() {
        const last7Days = getLastNDays(7);
        const usageData = calculateUsageData(last7Days);

        state.charts.usage.data.labels = last7Days.map(d => formatDate(d));
        state.charts.usage.data.datasets[0].data = usageData.views;
        state.charts.usage.data.datasets[1].data = usageData.clicks;
        state.charts.usage.data.datasets[2].data = usageData.sessions;
        state.charts.usage.update();
    }

    // Helper functions
    function getLastNDays(n) {
        const days = [];
        for (let i = n - 1; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
           days.push(date);
       }
       return days;
   }

   function formatDate(date) {
       return date.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric' });
   }

   function calculateUsageData(days) {
       const data = {
           views: [],
           clicks: [],
           sessions: []
       };

       days.forEach(day => {
           const dayStr = day.toISOString().split('T')[0];
           let dayViews = 0, dayClicks = 0, daySessions = 0;

           state.sessions.forEach(session => {
               if (session.metrics?.daily?.[dayStr]) {
                   dayViews += session.metrics.daily[dayStr].loads || 0;
                   dayClicks += session.metrics.daily[dayStr].clicks || 0;
                   daySessions++;
               }
           });

           data.views.push(dayViews);
           data.clicks.push(dayClicks);
           data.sessions.push(daySessions);
       });

       return data;
   }

   // Section navigation
   function showSection(sectionId) {
       // Update menu
       document.querySelectorAll('.menu-item').forEach(item => {
           item.classList.remove('active');
       });
       event.target.closest('.menu-item').classList.add('active');

       // Update sections
       document.querySelectorAll('.section').forEach(section => {
           section.classList.remove('active');
       });
       document.getElementById(sectionId).classList.add('active');

       // Update page title
       const titles = {
           dashboard: 'Dashboard',
           sessions: 'Live Sessions',
           clients: 'Client Management',
           analytics: 'Analytics',
           revenue: 'Revenue Calculator',
           api: 'API Management',
           activity: 'Activity Feed',
           jobsdata: 'Jobs Data API',
           settings: 'Settings'
       };
       document.getElementById('pageTitle').textContent = titles[sectionId];

       // Load section data
       switch(sectionId) {
           case 'sessions':
               loadSessions();
               break;
           case 'clients':
               loadClients();
               break;
           case 'api':
               loadAPIKeys();
               break;
           case 'activity':
               loadActivity();
               break;
           case 'revenue':
               loadRevenueCalculator();
               break;
           case 'jobsdata':
               // Initialize endpoints when section is shown
               initializeDynamicEndpoints();
               break;
       }
   }

   // Enhanced Jobs Data functions
   async function loadJobsData() {
       try {
           // Show loading state
           const viewer = document.getElementById('jobsDataViewer');
           const statsDiv = document.getElementById('jobsStats');
           viewer.innerHTML = '<pre><code>Loading jobs data...</code></pre>';

           // Use dynamic origin
           const response = await fetch(`${state.currentOrigin}/api/jobs`, {
               headers: {
                   'x-session-token': sessionToken
               }
           });

           if (!response.ok) {
               throw new Error(`HTTP error! status: ${response.status}`);
           }

           const data = await response.json();

           // Store jobs data in state
           state.jobsData = data;

           // Update stats
           statsDiv.style.display = 'flex';
           document.getElementById('totalJobsCount').textContent = data.total || data.jobs.length;
           document.getElementById('newJobsCount').textContent = data.newJobsCount || 0;
           document.getElementById('updatedJobsCount').textContent = data.updatedJobsCount || 0;
           document.getElementById('dataSource').textContent = data.source || 'API';

           // Format JSON for display with syntax highlighting
           const jobsDisplay = {
               total: data.jobs.length,
               source: data.source,
               fromCache: data.fromCache,
               lastFetch: data.lastFetch,
               jobs: data.jobs
           };

           const formatted = JSON.stringify(jobsDisplay, null, 2);
           const highlighted = formatted
               .replace(/"([^"]+)":/g, '<span class="json-key">"$1"</span>:')
               .replace(/: "([^"]+)"/g, ': <span class="json-string">"$1"</span>')
               .replace(/: (\d+)/g, ': <span class="json-number">$1</span>')
               .replace(/: (true|false)/g, ': <span class="json-boolean">$1</span>')
               .replace(/: (null)/g, ': <span class="json-null">$1</span>');

           viewer.innerHTML = `<pre><code>${highlighted}</code></pre>`;
           document.getElementById('jobsCount').textContent = `${data.jobs.length} jobs loaded`;

           showToast('Jobs data loaded successfully', 'success');
       } catch (error) {
           console.error('Error loading jobs:', error);
           const viewer = document.getElementById('jobsDataViewer');
           viewer.innerHTML = `<pre><code class="error">Error loading jobs: ${error.message}</code></pre>`;
           document.getElementById('jobsStats').style.display = 'none';
           showToast('Error loading jobs data', 'error');
       }
   }

   async function downloadJobsData() {
       try {
           // Check if data is already loaded
           if (!state.jobsData) {
               showToast('Please load jobs data first', 'warning');
               await loadJobsData();
           }

           if (!state.jobsData) {
               throw new Error('No jobs data available');
           }

           // Prepare download data
           const downloadData = {
               total: state.jobsData.jobs.length,
               download_date: new Date().toISOString(),
               source: state.jobsData.source,
               origin: state.currentOrigin,
               jobs: state.jobsData.jobs
           };

           const blob = new Blob([JSON.stringify(downloadData, null, 2)], { type: 'application/json' });
           const url = window.URL.createObjectURL(blob);
           const a = document.createElement('a');
           a.href = url;
           a.download = `bmj-jobs-${new Date().toISOString().split('T')[0]}.json`;
           document.body.appendChild(a);
           a.click();
           window.URL.revokeObjectURL(url);
           document.body.removeChild(a);

           showToast('Jobs data downloaded successfully', 'success');
       } catch (error) {
           console.error('Error downloading jobs:', error);
           showToast('Error downloading jobs data', 'error');
       }
   }

   async function refreshJobsData() {
       try {
           showToast('Refreshing jobs data...', 'info');

           // Force refresh from server
           const response = await fetch(`${state.currentOrigin}/api/jobs/refresh`, {
               method: 'POST',
               headers: {
                   'x-session-token': sessionToken
               }
           });

           if (!response.ok) {
               throw new Error('Failed to refresh jobs');
           }

           const result = await response.json();

           // Reload the jobs data
           await loadJobsData();

           showToast(`Jobs refreshed: ${result.newJobsCount || 0} new, ${result.updatedJobsCount || 0} updated`, 'success');
       } catch (error) {
           console.error('Error refreshing jobs:', error);
           showToast('Error refreshing jobs data', 'error');
       }
   }

   function copyToClipboard(elementId) {
       const element = document.getElementById(elementId);
       const text = element.textContent;

       navigator.clipboard.writeText(text).then(() => {
           showToast('Copied to clipboard', 'success');
       }).catch(() => {
           // Fallback for older browsers
           const textArea = document.createElement('textarea');
           textArea.value = text;
           document.body.appendChild(textArea);
           textArea.select();
           document.execCommand('copy');
           document.body.removeChild(textArea);
           showToast('Copied to clipboard', 'success');
       });
   }

   // Enhanced load sessions with iframe tracking
   function loadSessions() {
       const container = document.getElementById('sessionsContainer');
       const activeSessions = state.sessions.filter(s => s.isActive);

       document.getElementById('sessionCount').textContent = `${activeSessions.length} Active`;

       if (state.sessions.length === 0) {
           container.innerHTML = `
               <div class="empty-state">
                   <div class="empty-state-icon">üë•</div>
                   <div class="empty-state-title">No sessions found</div>
               </div>
           `;
           return;
       }

       container.innerHTML = state.sessions.map(session => `
           <div class="session-card ${session.isActive ? 'active' : ''}" style="margin-bottom: 1rem;">
               <div class="session-header">
                   <div>
                       <div class="session-client">
                           ${session.displayName}
                           ${session.isIframe ? '<span class="tracking-badge iframe-indicator">iFrame Embed</span>' : ''}
                       </div>
                       <div class="client-identifier">Client: ${session.clientIdentifier}</div>
                       <div style="margin-top: 0.5rem; color: var(--gray); font-size: 0.75rem;">
                           ${session.domain} | Started: ${new Date(session.firstSeen).toLocaleString()}
                       </div>
                   </div>
                   <span class="session-badge ${session.isActive ? 'active' : 'ended'}">
                       ${session.isActive ? '‚óè Active' : '‚óã Ended'}
                   </span>
               </div>
               <div class="session-metrics">
                   <div class="metric-mini">
                       <div class="metric-mini-value">${session.totalMetrics?.loads || 0}</div>
                       <div class="metric-mini-label">Page Views</div>
                   </div>
                   <div class="metric-mini">
                       <div class="metric-mini-value">${session.totalMetrics?.clicks || 0}</div>
                       <div class="metric-mini-label">Job Clicks</div>
                   </div>
                   <div class="metric-mini">
                       <div class="metric-mini-value">${session.duration}</div>
                       <div class="metric-mini-label">Duration</div>
                   </div>
                   <div class="metric-mini">
                       <div class="metric-mini-value">¬£${session.revenue.toFixed(2)}</div>
                       <div class="metric-mini-label">Revenue</div>
                   </div>
               </div>
               ${session.isIframe ? `
                   <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                       <div class="usage-metric">
                           <span class="metric-label">Embed Type:</span>
                           <span class="metric-value">iFrame</span>
                       </div>
                       <div class="usage-metric">
                           <span class="metric-label">Source Domain:</span>
                           <span class="metric-value">${session.clientIdentifier}</span>
                       </div>
                   </div>
               ` : ''}
           </div>
       `).join('');
   }

   // Enhanced load clients with iframe detection
   function loadClients() {
       const tbody = document.getElementById('clientsTable');

       if (state.clients.length === 0) {
           tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No clients found</td></tr>';
           return;
       }

       tbody.innerHTML = state.clients.map(client => `
           <tr>
               <td>
                   <div style="font-weight: 600;">
                       ${client.name}
                       ${client.isIframe ? '<span class="tracking-badge iframe-indicator">iFrame</span>' : ''}
                   </div>
                   <div class="client-identifier">${client.clientId}</div>
               </td>
               <td>${client.domain}</td>
               <td>${client.sessions.length}</td>
               <td>${client.totalMetrics.loads.toLocaleString()}</td>
               <td>${client.totalMetrics.clicks.toLocaleString()}</td>
               <td>¬£${client.totalMetrics.revenue.toFixed(2)}</td>
               <td>
                   <button class="btn btn-sm btn-primary" onclick="viewClientDetails('${client.clientId}')">
                       View Details
                   </button>
               </td>
           </tr>
       `).join('');
   }

   // Load settings
   function loadSettings() {
       const savedSettings = localStorage.getItem('adminSettings');
       if (savedSettings) {
           state.settings = JSON.parse(savedSettings);
       }
   }

   // Save settings
   function saveSettings() {
       localStorage.setItem('adminSettings', JSON.stringify(state.settings));
       showToast('Settings saved', 'success');
       loadDashboard();
   }

   // Real-time updates
   function startRealTimeUpdates() {
       // Update every 30 seconds
       state.refreshInterval = setInterval(() => {
           if (state.settings.enableNotifications) {
               loadDashboard();

               // Check for alerts
               const activeSessions = state.sessions.filter(s => s.isActive).length;
               if (activeSessions > state.settings.alertThreshold) {
                   showToast(`High traffic alert: ${activeSessions} active sessions`, 'warning');
               }
           }
       }, 30000);
   }

   // Toast notifications
   function showToast(message, type = 'success') {
       const toast = document.getElementById('toast');
       const toastIcon = document.getElementById('toastIcon');
       const toastTitle = document.getElementById('toastTitle');
       const toastMessage = document.getElementById('toastMessage');

       // Reset classes
       toast.className = 'toast';
       toast.classList.add(type);

       // Set content
       const icons = {
           success: '‚úì',
           error: '‚úï',
           warning: '‚ö†',
           info: '‚Ñπ'
       };

       const titles = {
           success: 'Success',
           error: 'Error',
           warning: 'Warning',
           info: 'Info'
       };

       toastIcon.textContent = icons[type] || '‚úì';
       toastTitle.textContent = titles[type] || 'Success';
       toastMessage.textContent = message;

       // Show toast
       toast.classList.add('show');

       // Hide after 3 seconds
       setTimeout(() => {
           toast.classList.remove('show');
       }, 3000);
   }

   // Cleanup on page unload
   window.addEventListener('beforeunload', () => {
       if (state.refreshInterval) {
           clearInterval(state.refreshInterval);
       }
   });

   // Handle responsive menu
   function toggleSidebar() {
       document.getElementById('sidebar').classList.toggle('active');
   }

   window.addEventListener('resize', () => {
       if (window.innerWidth > 768) {
           document.getElementById('sidebar').classList.remove('active');
       }
   });

   // Export functions for debugging
   window.debugState = () => console.log(state);
   window.refreshData = () => loadDashboard();

    // Initialize additional charts
function initializeAllCharts() {
    // Call existing initializeCharts first
    initializeCharts();

    // Session Distribution Chart
    const sessionDistCtx = document.getElementById('sessionDistChart');
    if (sessionDistCtx) {
        state.charts.sessionDist = new Chart(sessionDistCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Direct', 'iFrame', 'API'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: ['#0066cc', '#48bb78', '#FFC000']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // Revenue Chart
    const revenueCtx = document.getElementById('revenueChart');
    if (revenueCtx) {
        state.charts.revenue = new Chart(revenueCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Revenue (¬£)',
                    data: [],
                    backgroundColor: '#0066cc'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '¬£' + value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    }

    // Geographic Chart
    const geoCtx = document.getElementById('geoChart');
    if (geoCtx) {
        state.charts.geo = new Chart(geoCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Sessions by Region',
                    data: [],
                    backgroundColor: '#0066cc'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y'
            }
        });
    }
}

// Search clients function
function searchClients(query) {
    const filtered = state.clients.filter(client =>
        client.name.toLowerCase().includes(query.toLowerCase()) ||
        client.domain.toLowerCase().includes(query.toLowerCase()) ||
        client.clientId.toLowerCase().includes(query.toLowerCase())
    );

    const tbody = document.getElementById('clientsTable');
    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No clients match your search</td></tr>';
        return;
    }

    tbody.innerHTML = filtered.map(client => `
        <tr>
            <td>
                <div style="font-weight: 600;">
                    ${client.name}
                    ${client.isIframe ? '<span class="tracking-badge iframe-indicator">iFrame</span>' : ''}
                </div>
                <div class="client-identifier">${client.clientId}</div>
            </td>
            <td>${client.domain}</td>
            <td>${client.sessions.length}</td>
            <td>${client.totalMetrics.loads.toLocaleString()}</td>
            <td>${client.totalMetrics.clicks.toLocaleString()}</td>
            <td>¬£${client.totalMetrics.revenue.toFixed(2)}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="viewClientDetails('${client.clientId}')">
                    View Details
                </button>
            </td>
        </tr>
    `).join('');
}

// View client details function
function viewClientDetails(clientId) {
    const client = state.clients.find(c => c.clientId === clientId);
    if (!client) return;

    // Create and show modal with client details
    alert(`Client Details:\n\nName: ${client.name}\nDomain: ${client.domain}\nTotal Revenue: ¬£${client.totalMetrics.revenue.toFixed(2)}\n\nSessions: ${client.sessions.length}\nPage Views: ${client.totalMetrics.loads}\nClicks: ${client.totalMetrics.clicks}`);
}

// Load API Keys
function loadAPIKeys() {
    const tbody = document.getElementById('apiKeysTable');

    if (!state.apiKeys || state.apiKeys.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No API keys generated yet</td></tr>';
        return;
    }

    tbody.innerHTML = state.apiKeys.map(key => `
        <tr>
            <td>${key.clientName}</td>
            <td>
                <code style="background: var(--light); padding: 0.25rem 0.5rem; border-radius: 4px;">
                    ${key.apiKey.substring(0, 20)}...
                </code>
                <button class="btn btn-sm btn-secondary" onclick="copyApiKey('${key.apiKey || key.fullKey}')">
                    Copy
                </button>
            </td>
            <td>${new Date(key.createdAt).toLocaleDateString()}</td>
            <td>${key.totalUsage || 0}</td>
            <td>${key.lastUsed ? new Date(key.lastUsed).toLocaleString() : 'Never'}</td>
            <td>
                <button class="btn btn-sm btn-danger" onclick="revokeApiKey('${key.clientId}')">
                    Revoke
                </button>
            </td>
        </tr>
    `).join('');
}

// Load Activity Feed
async function loadActivity() {
    try {
        const response = await fetch('/api/admin/activity/recent', {
            headers: {
                'x-session-token': sessionToken
            }
        });

        if (response.ok) {
            const data = await response.json();
            updateActivityFeeds(data.activities);
        }
    } catch (error) {
        console.error('Error loading activity:', error);
        // Show mock data if API fails
        updateActivityFeeds(generateMockActivity());
    }
}

// Generate mock activity data
function generateMockActivity() {
    const activities = {
        loads: [],
        clicks: [],
        apiCalls: []
    };

    state.sessions.forEach(session => {
        if (session.totalMetrics?.loads > 0) {
            activities.loads.push({
                client: session.displayName,
                action: session.isIframe ? 'Loaded widget (iFrame)' : 'Loaded widget',
                time: formatRelativeTime(session.lastSeen)
            });
        }

        if (session.totalMetrics?.clicks > 0) {
            activities.clicks.push({
                client: session.displayName,
                action: 'Clicked on job listing',
                time: formatRelativeTime(session.lastSeen)
            });
        }

        if (session.totalMetrics?.apiCalls > 0) {
            activities.apiCalls.push({
                client: session.displayName,
                action: 'API call',
                time: formatRelativeTime(session.lastSeen)
            });
        }
    });

    return activities;
}

// Update activity feeds
function updateActivityFeeds(activities) {
    // Page loads
    const loadsFeed = document.getElementById('loadsFeed');
    if (activities.loads && activities.loads.length > 0) {
        loadsFeed.innerHTML = activities.loads.slice(0, 10).map(item => `
            <div class="activity-item">
                <div class="activity-icon load">üìÑ</div>
                <div class="activity-content">
                    <div class="activity-title">${item.client}</div>
                    <div class="activity-description">${item.action}</div>
                </div>
                <div class="activity-time">${item.time}</div>
            </div>
        `).join('');
    } else {
        loadsFeed.innerHTML = '<div class="empty-state">No recent page loads</div>';
    }

    // Clicks
    const clicksFeed = document.getElementById('clicksFeed');
    if (activities.clicks && activities.clicks.length > 0) {
        clicksFeed.innerHTML = activities.clicks.slice(0, 10).map(item => `
            <div class="activity-item">
                <div class="activity-icon click">üëÜ</div>
                <div class="activity-content">
                    <div class="activity-title">${item.client}</div>
                    <div class="activity-description">${item.action}</div>
                </div>
                <div class="activity-time">${item.time}</div>
            </div>
        `).join('');
    } else {
        clicksFeed.innerHTML = '<div class="empty-state">No recent clicks</div>';
    }

    // API calls
    const apiFeed = document.getElementById('apiFeed');
    if (activities.apiCalls && activities.apiCalls.length > 0) {
        apiFeed.innerHTML = activities.apiCalls.slice(0, 10).map(item => `
            <div class="activity-item">
                <div class="activity-icon api">üîå</div>
                <div class="activity-content">
                    <div class="activity-title">${item.client}</div>
                    <div class="activity-description">${item.action}</div>
                </div>
                <div class="activity-time">${item.time}</div>
            </div>
        `).join('');
    } else {
        apiFeed.innerHTML = '<div class="empty-state">No recent API calls</div>';
    }
}

// Format relative time helper
function formatRelativeTime(date) {
    const now = new Date();
    const then = new Date(date);
    const diff = now - then;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);

    if (days > 0) return `${days}d ago`;
    if (hours > 0) return `${hours}h ago`;
    if (minutes > 0) return `${minutes}m ago`;
    return 'Just now';
}

// Load Revenue Calculator
function loadRevenueCalculator() {
    const select = document.getElementById('revenueClient');
    if (!select) return;

    select.innerHTML = '<option value="">All Clients</option>' +
        state.clients.map(client =>
            `<option value="${client.clientId}">${client.name}</option>`
        ).join('');
}

// Calculate Revenue
function calculateRevenue() {
    const clientId = document.getElementById('revenueClient').value;
    const period = document.getElementById('revenuePeriod').value;
    const costPerView = parseFloat(document.getElementById('costPerView').value);
    const costPerClick = parseFloat(document.getElementById('costPerClick').value);
    const costPerSession = parseFloat(document.getElementById('costPerSession').value);

    let sessions = state.sessions;
    if (clientId) {
        const client = state.clients.find(c => c.clientId === clientId);
        sessions = client ? client.sessions : [];
    }

    // Filter by period
    const now = new Date();
    let startDate = new Date();

    switch(period) {
        case 'today':
            startDate.setHours(0, 0, 0, 0);
            break;
        case 'week':
            startDate.setDate(now.getDate() - 7);
            break;
        case 'month':
            startDate.setMonth(now.getMonth() - 1);
            break;
        case 'quarter':
            startDate.setMonth(now.getMonth() - 3);
            break;
        case 'year':
            startDate.setFullYear(now.getFullYear() - 1);
            break;
    }

    const filteredSessions = sessions.filter(s =>
        new Date(s.firstSeen) >= startDate
    );

    // Calculate totals
    let totalViews = 0, totalClicks = 0;
    filteredSessions.forEach(session => {
        totalViews += session.totalMetrics?.loads || 0;
        totalClicks += session.totalMetrics?.clicks || 0;
    });

    const totalRevenue = (totalViews * costPerView) +
            (totalClicks * costPerClick) +
            (filteredSessions.length * costPerSession);

    // Display results
    document.getElementById('totalRevenue').textContent = `¬£${totalRevenue.toFixed(2)}`;
    document.getElementById('revenuePeriodText').textContent = document.getElementById('revenuePeriod').selectedOptions[0].text;
    document.getElementById('viewsCount').textContent = totalViews.toLocaleString();
    document.getElementById('clicksCount').textContent = totalClicks.toLocaleString();
    document.getElementById('sessionsCount').textContent = filteredSessions.length.toLocaleString();

    document.getElementById('revenueResult').style.display = 'block';
}

// Additional helper functions
function refreshSessions() {
    loadDashboard();
    showToast('Sessions refreshed', 'success');
}

function copyApiKey(apiKey) {
    navigator.clipboard.writeText(apiKey).then(() => {
        showToast('API key copied to clipboard', 'success');
    }).catch(() => {
        showToast('Failed to copy API key', 'error');
    });
}

async function revokeApiKey(clientId) {
    if (!confirm('Are you sure you want to revoke this API key?')) return;

    try {
        const response = await fetch(`/api/admin/apikey/${clientId}`, {
            method: 'DELETE',
            headers: {
                'x-session-token': sessionToken
            }
        });

        if (response.ok) {
            showToast('API key revoked', 'success');
            loadAPIKeys();
        } else {
            throw new Error('Failed to revoke API key');
        }
    } catch (error) {
        showToast('Error revoking API key', 'error');
    }
}

function showGenerateKeyModal() {
    // Simple prompt for now - can be replaced with proper modal
    const clientName = prompt('Enter client name:');
    const clientId = prompt('Enter client ID:');

    if (clientName && clientId) {
        generateAPIKey(clientId, clientName);
    }
}

async function generateAPIKey(clientId, clientName) {
    try {
        const response = await fetch('/api/admin/generate-api-key', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-session-token': sessionToken
            },
            body: JSON.stringify({ clientId, clientName })
        });

        if (response.ok) {
            const data = await response.json();
            showToast('API key generated successfully', 'success');
            loadDashboard();

            // Copy to clipboard
            navigator.clipboard.writeText(data.apiKey);
            showToast('API key copied to clipboard', 'success');
        } else {
            throw new Error('Failed to generate API key');
        }
    } catch (error) {
        showToast('Error generating API key', 'error');
    }
}
</script>
</body>
</html>
